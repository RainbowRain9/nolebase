# Epic 4: 财务管理（对话、报表、预警、历史采购）

权威来源：../../prd.md#L829


**Epic 目标：** 对话生成/解释报表、指标预警、历史采购对比与财务仪表盘，联通多数据库。

**Epic 描述（现状与增强）：**
- 现有：通用表格与 Mock 能力可用于示例，但缺少多数据库连接器、报表模板与预警策略落地。
- 增强：提供多 DB 连接器与统一映射；可配置报表模板、指标预警与历史采购对比；仪表盘可钻取。

**Stories（概览）：**
- 见下方 Story 4.1–4.3 的详细验收要点。

**兼容性要求：**
- 多数据库连接器向后兼容既有财务报表导出格式；
- 报表模板版本化、灰度发布；性能满足 NFR2，关键查询具缓存/限流。

**风险与回滚：**
- 风险：跨库映射与权限差异、长查询影响体验。
- 缓解：只读副本与预计算、查询分级与缓存、权限统一网关。
- 回滚：关闭新连接器，回退到单库直连与缓存报表。

**完成定义（DoD）：**
- Story 4.1–4.3 验收通过；
- 报表可导出/分享，预警生效并可追溯；
- 仪表盘可钻取到凭证；
- E2E 场景覆盖“生成-解释-预警-对比”。

**验证清单（自检）：**
- 范围：对话/报表/预警/对比/仪表盘与多 DB 接入；
- 风险：关键查询有缓存与限流；权限差异已适配；
- 完整：模板与连接器配置文档完备。

#### Story 4.1: 对话（财务）与报表生成
验收要点：
1. 自然语言生成日/周/月报；支持导出与分享。
2. 解释指标与波动；生成纠偏/节流建议卡片。
3. 报表可配置模板与权限，支持调度。

验收标准（Given-When-Then）：
- Given 用户输入“生成本周财务周报”
  When 报表模板与权限满足
  Then 生成周报卡片并支持导出/分享，附指标波动解释
- Given 设定调度为“每周一9:00”
  When 到达调度时间
  Then 自动生成报表并发送到订阅对象，审计记录包含派发详情

#### Story 4.2: 指标预警与历史采购对比
验收要点：
1. 阈值/规则配置，推送到工作台与消息。
2. 采购对比按供方/物料/时间维度，输出建议。
3. 异常与溯因卡片化展示，可派发任务。

验收标准（Given-When-Then）：
- Given 关键指标设置了阈值规则
  When 指标超阈
  Then 工作台收到预警卡片并可查看溯因与处理建议
- Given 选择供方/物料/时间维度
  When 执行对比分析
  Then 输出可执行建议并可派发为采购优化任务

#### Story 4.3: 多 DB 连接器与仪表盘
验收要点：
1. 连接 MySQL/PostgreSQL/SQL Server 并统一映射。
2. 财务仪表盘可钻取到凭证；收藏/订阅。
3. 高并发查询配合缓存与限流。

验收标准（Given-When-Then）：
- Given 已配置并连通三种数据库
  When 在仪表盘点击某指标
  Then 支持钻取到原始凭证记录，遵循权限控制
- Given 高并发访问场景
  When 压测并发达到目标QPS
  Then 指标稳定，命中缓存与限流策略，无报错

