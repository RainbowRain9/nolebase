# Epic 10: 设置与安全（最小授权与审计）

权威来源：../../prd.md#L1268


**Epic 目标：** 对话解释权限与生成最小授权建议；公司切换、权限与角色、数据源配置、安全与认证、审计日志。

**Epic 描述（现状与增强）：**
- 现有：设置分散、权限解释缺失、缺统一最小授权建议。
- 增强：对话解释权限与最小授权建议；公司切换、数据源配置与安全合规；全链路审计与导出。

**Stories（概览）：**
- 见下方 Story 10.1–10.3 的详细验收要点。

**兼容性要求：**
- 与多租户上下文一致；
- 密钥加密存储；
- 审计与导出遵循合规。

**风险与回滚：**
- 风险：授权误配与安全事件。
- 缓解：最小授权建议+二次确认；密钥轮转与最小暴露面。
- 回滚：关闭自动建议，仅保留人工配置。

**完成定义（DoD）：**
- Story 10.1–10.3 验收通过；
- 审计可检索/聚合/导出；
- 安全检查清单通过；
- E2E 场景覆盖“解释-建议-变更-审计”。

**验证清单（自检）：**
- 范围：权限/公司切换/数据源/安全/审计；
- 风险：变更有审批与回滚步骤；
- 完整：合规模板完备。

#### Story 10.1: 对话（设置）与最小授权建议
验收要点：
1. 输入目标动作与对象，输出最小授权角色/策略。
2. 一键生成变更草稿并走审批。
3. 解释当前权限命中与影响面。

验收标准（Given-When-Then）：
- Given 用户输入“允许张三审批报销”
  When 生成最小授权建议
  Then 输出最小角色/策略并可一键生成变更草稿提交审批
- Given 当前权限校验
  When 询问“为何无法提交审批”
  Then 返回命中规则与影响面解释

#### Story 10.2: 公司切换/数据源/安全与认证
验收要点：
1. 公司切换与隔离策略统一生效。
2. 数据源配置与密钥管理（加密存储）。
3. SSO/MFA 可选；API 限流/防注入。

验收标准（Given-When-Then）：
- Given 切换公司上下文
  When 访问数据源配置
  Then 仅展示该公司可见数据源，密钥以加密形式存储与展示
- Given 启用 MFA 策略
  When 用户登录
  Then 触发二次验证流程

#### Story 10.3: 审计日志与合规导出
验收要点：
1. 全链路审计（对话/命令/视图/API）。
2. 可检索/聚合/导出；保留期可配。
3. 合规报表模板。

验收标准（Given-When-Then）：
- Given 平台记录审计日志
  When 按“操作者/时间/资源类型”检索
  Then 返回结果支持聚合与导出，受保留期策略约束
- Given 选择合规模板
  When 生成报表
  Then 导出满足模板字段与格式要求

