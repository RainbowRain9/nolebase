# Epic 1: 融合式交互框架与多租户安全

权威来源：../../prd.md#L577


**Epic 目标：** 打底“AI 融合式”能力：Conversation Shell（对话壳）、CardSchema、命令面板/全局搜索、Dify 安全集成、RBAC/ABAC、多公司上下文与审计闭环。

**Epic 描述（现状与增强）：**
- 现有：前端已具备基础 AI 对话视图（iframe Dify）与部分 Mock 能力，但缺少服务端签名、统一卡片协议、Action 执行通道与多租户安全基座。
- 增强：抽象 Conversation Shell 与 CardSchema，建立 ActionBus 与命令面板/全局搜索一致协议；补齐多公司上下文传播、RBAC+ABAC 判定与全链路审计。

**Stories（概览）：**
- 见下方 Story 1.1–1.5 的详细验收要点。

**兼容性要求：**
- 不破坏现有菜单/路由与登录流程；对现有 AI 视图提供向后兼容 iframe 参数协议。
- 若引入服务端签名与权限网关，客户端调用需保持稳定接口（以 OpenAPI 契约发布），前端通过 feature flag 渐进切换。
- UI 交互遵循既有组件与主题规范；性能预算满足 NFR2。

**风险与回滚：**
- 风险：签名/权限网关引入导致首 token 延迟升高；Action 执行路径新旧并存造成一致性问题。
- 缓解：灰度发布与开关控制；关键路径压测与缓存；详细审计辅助排障。
- 回滚：保留原有 iframe 直连模式与本地权限判定路径，可一键切换回旧模式。

**完成定义（DoD）：**
- Story 1.1–1.5 验收要点全部通过；
- 单元/集成/E2E 覆盖核心流（命令/对话/卡片/权限/审计）；
- OpenAPI 契约与前端接口文档更新；
- 性能与可用性指标符合 NFR2/NFR3；
- 变更记录与运维手册（含开关/回滚）完善。

**验证清单（自检）：**
- 范围：本 Epic 在不触及业务域功能细节前提下，完成交互与安全内核落地；
- 风险：签名、权限、审计链路均有监控与压测报告；
- 完整：提供演示用例与回归脚本，支持灰度与快速回滚。

#### Story 1.1: 多公司上下文与隔离
验收要点：
1. 三公司数据物理/逻辑隔离；切换公司后导航/搜索/对话结果即时收敛。
2. 跨公司访问需具备显式权限与审计记录。
3. 所有 API 强制带公司上下文，越权请求拒绝并告警。

验收标准（Given-When-Then）：
- Given 用户已登录并处于公司A上下文
  When 在顶栏切换到公司B
  Then 顶部导航、全局搜索与对话检索结果收敛到公司B数据
- Given 用户对公司B无“跨公司可见”权限
  When 在公司A上下文请求公司B资产
  Then 后端以 403 拒绝，请求被审计并触发告警
- Given 任意 API 调用
  When 平台侧检测到缺失公司上下文
  Then 拒绝请求并输出统一错误体与审计记录

#### Story 1.2: RBAC+ABAC 权限与审计
验收要点：
1. 动作级/实体级/字段级权限判定；对话触发动作统一走权限网关。
2. 审计记录至少包含“消息ID/参数/决策/结果/操作者/时间”。
3. 审计可检索与导出；敏感字段按策略脱敏。

验收标准（Given-When-Then）：
- Given 用户具备查看权限但无编辑权限
  When 通过对话尝试提交“编辑实体”动作
  Then 权限网关拒绝并返回“无权限”卡片，同时记录完整审计
- Given 用户查看含敏感字段的记录
  When 触发列表或详情查询
  Then 响应中敏感字段按策略脱敏，并在审计中标记字段级访问

#### Story 1.3: Dify iframe + PostMessage 安全集成
验收要点：
1. 服务端签名上下文与参数白名单；Prompt 注入与越权防护。
2. 首 token 延迟 P95 ≤ 800ms；流式渲染可回退。
3. 失败熔断/重试策略与错误卡片反馈。

验收标准（Given-When-Then）：
- Given 后端签名服务健康且浏览器支持 PostMessage
  When 用户打开对话视图并发送请求
  Then 请求携带签名与白名单参数，首 token 延迟 P95 ≤ 800ms，消息流式渲染
- Given Dify 服务暂时不可用
  When 触发对话请求
  Then 系统展示错误卡片并自动退化到模板/缓存结果

#### Story 1.4: Conversation Shell 与 CardSchema
验收要点：
1. 提供标准卡片（摘要/表格/图表/列表/操作/预览）。
2. 操作卡片绑定 ActionBus，支持“提交/生成/导出/跳转”。
3. 表单片段作为对话内模态片段挂载，可校验与二次确认。

验收标准（Given-When-Then）：
- Given 对话返回“操作卡片（提交报表）”
  When 点击卡片上的“提交”
  Then 通过 ActionBus 执行后端动作并反馈执行结果卡片
- Given 需要补充参数
  When 卡片要求填写表单片段
  Then 在对话内弹出表单，校验通过后方可二次确认提交

#### Story 1.5: 命令面板与全局搜索
验收要点：
1. Cmd/Ctrl+K 打开；支持自然语言与命令短语（#域 动作）。
2. 可直达“任意视图/实体/动作”，执行前权限校验与确认。
3. 结果与对话联动，可生成操作卡片或跳转。

验收标准（Given-When-Then）：
- Given 用户在任意页面
  When 按下 Cmd/Ctrl+K 并输入“#项目 创建任务”
  Then 命令面板展示候选并在确认后跳转到创建视图或生成操作卡片
- Given 用户缺少目标动作权限
  When 在命令面板直接执行动作
  Then 弹出权限不足提示并记录审计

