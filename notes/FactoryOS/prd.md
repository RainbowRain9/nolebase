# FactoryOS 企业级 AI 协作平台产品需求文档 (PRD)

提示：本 PRD 已提供分片索引，见 docs/prd/README.md

## 目标和背景上下文

### 目标

- 构建集成 Dify 平台的企业级 AI 协作系统，支持三家公司（福建微柏、福建鲤东、成都鲤东）统一管理
- 实现项目交付进度管理和成本管理，支持微柏项目进度和（成都鲤东、福建鲤东）周交付管理
- 为各部门同事配备 AI Agent，提供文档编辑、视频编辑、书写协助、专业建议等功能提升工作效率
- 建立自动化财务报表系统（日、周、月），支持财务指标预警和历史采购对比分析
- 构建对外方案资料库、设计零件资料库和 PLC 设计资料库
- 实现全员效率评估报告功能，支持周报和月报自动生成
- 开发业务深度探测和挖掘功能，自动生成对外宣传视频
- 建立合同法务风险解析功能
- 实现公司月度、季度目标管理，设置强制性目标审核功能
- 确保数据安全、防止 AI 胡说八道、实现数据清洗和权限配置管理

### 背景上下文

当前 FactoryOS 是基于 Vue Vben Admin 5.5.9 的现代化 monorepo 项目，具备完善的前端技术栈和模块化架构。三家公司在业务运营中面临信息分散、效率低下、数据分析不足等问题。通过集成 AI 技术，特别是 Dify 平台的对话式 AI 能力，可以显著提升企业运营效率、决策质量和创新能力。该项目将把现有的 FactoryOS 从一个基础的管理系统扩展为综合性的企业级 AI 协作平台。

### 现有项目评估与差距分析（Architect 视角）

为保证规划可落地，基于当前代码库（monorepo）进行一次基线评估，并将关键差距纳入本 PRD 的里程碑规划。

- 代码结构与模块
  - `apps/web-antd/`：主 Web 应用（Vue 3 + Ant Design Vue）；已存在 AI 助手入口与聊天页面（`src/views/ai-assistant/chat/index.vue`）。
  - `apps/backend-mock/`：基于 Nitro 的 Mock API，涵盖认证（`/auth/login|logout|refresh|codes`）、菜单、用户信息、系统数据（部门/角色/菜单）、表格/上传、测试等端点；便于前后端并行与契约校验。
  - `docs/`：已含 `architecture.md`，文档与本 PRD 需要保持一致更新；有多语言指南与项目操作说明。
  - `playground/`：示例与 E2E 场景（Playwright），适合作为融合式交互回归验证的承载地。
  - `scripts/`：包含 CI/构建/部署/开发工具脚本；与 Turbo/pnpm 协同。

- 技术与环境基线
  - Node ≥ 20.10、pnpm ≥ 9.12（`pnpm-workspace.yaml` + Turbo 驱动工作流）；Vite 7、Vitest、Playwright、Stylelint/ESLint/Prettier 已入仓。
  - 前端：Vue 3.5+、TypeScript 5.8+、Ant Design Vue 4.2+、Pinia 3+；样式与主题体系完整。
  - Mock 后端：Nitro + h3；JWT、刷新 Token、Cookie 工具与统一响应封装已具雏形。

- 已实现能力快照（与 PRD 对齐度）
  - AI 助手（对话视图）：以 iframe 嵌入 Dify，支持通过路由参数或环境变量配置 base/token，提供容错与 Loading/Error UI；支持将 `inputs` 参数按需 gzip+base64+encodeURIComponent 编码后透传，具备“遮挡品牌”可选能力（受许可限制）。
  - 基础认证与权限码获取：`/auth/login|refresh|logout|codes` 已打通前端 API 封装与 Mock 端点。
  - 基础系统模块：菜单、部门、角色、通用表格/上传等 Mock 能力可用于早期页面与数据流通。
  - 开发体验：pnpm + Turbo 工作流、Vitest、Playwright、Stylelint/ESLint/Prettier 与 Tailwind/Tokens 等基础设施健全。

- 关键差距（需纳入版本路线图）
  - Dify 安全集成：当前为直嵌 iframe，仍缺少服务端签名/限流/脱敏与 PostMessage 双向通信契约落地（参考 `docs/architecture.md` 的“Dify 集成契约”）。
  - 融合式交互基座：Conversation Shell、CardSchema、ActionBus、命令面板/全局搜索尚未形成稳定可复用内核与协议版本。
  - 多租户与审计：公司上下文传播、RBAC+ABAC 判定、动作审计（traceId/幂等）与合规导出需在 API 网关/服务层补齐。
  - 统一数据访问层与连接器：针对多财务库（MySQL/PG/SQL Server）的映射与统一查询接口尚未实现。
  - SRE 策略：缓存/限流/熔断/降级与可观测性（日志/指标/追踪）未按 SLO 目标固化，需引入并验证。

- 优先级建议（里程碑拆分）
  1) M1（基础内核）：Conversation Shell + CardSchema v1 + 命令面板/搜索 + Dify 签名通道（只读卡片）+ 多租户上下文传播 + 审计基座。
  2) M2（业务首落地）：项目与财务两个域的“对话（模块）+ 两个典型视图 + 两个关键报表/动作”端到端闭环；上线最小 RBAC/ABAC 规则与审批联动一条链路。
  3) M3（横向扩展）：员工与审批、资料库与 BI、统一数据访问层、多 DB 连接器、SRE 策略固化与容量压测。

以上现状评估与差距已同步到本 PRD 的非功能需求与 Epic/Story 设计中，作为验收与推进的客观依据。

## 范围与不在范围（Scope）

### 在范围（In Scope）

- 三家公司（福建微柏、福建鲤东、成都鲤东）统一的多租户安全与上下文传播
- 融合式交互（对话/卡片/命令面板）的一致体验与协议落地
- 项目、财务、审批、人事、资料库、目标&BI、数据与集成、设置与安全、帮助与支持、个人中心等模块的最小可用闭环
- Dify 安全集成（服务端签名、限流、脱敏）与基础 PostMessage 契约
- 统一数据访问层、多数据库连接器、质量与审计的最小实现

### 不在范围（Out of Scope）

- 非核心域的深度行业定制（仅纳入后续版本路线图）
- 大规模数据迁移与清洗（当前仅支持增量与示范性迁移）
- 移动端原生应用（当前为响应式 Web）
- 生成式内容的法律合规审查与法律代理（提供技术支持与审计能力，但不承担法律判断）

## 术语与缩写（Glossary）

- Conversation Shell：承载对话上下文、卡片渲染与动作执行的前端“壳”
- CardSchema：标准化的卡片协议（摘要/表格/图表/操作等）
- ActionBus：在卡片与前端/后端之间传递“动作”的通道
- RBAC/ABAC：基于角色/基于属性的权限控制模型
- Dify：对话式 AI 平台，此处以 iframe + PostMessage 集成为主
- NFR：非功能性需求（性能/安全/可用性等）
- SLO/SLA：服务目标/服务等级协议

## 关键依赖与外部系统（Dependencies）

- Dify 平台：对话与推理能力提供方（iframe 集成 + PostMessage）
- 钉钉：组织/消息/审批同步
- 数据库：MySQL/PostgreSQL/SQL Server（通过连接器与统一数据访问层接入）
- Redis：缓存与消息队列（可选 Bull Queue）
- 对象存储：本地/OSS/S3（文件上传与版本）

### 变更记录

| 日期       | 版本 | 描述                          | 作者        |
| ---------- | ---- | ----------------------------- | ----------- |
| 2025-10-16 | 1.0  | 初始 PRD 创建                 | John (PM)   |
| 2025-10-23 | 1.1  | 导航与交互重构（AI 融合式）版 | FactoryOS AI |
| 2025-10-23 | 1.2  | 补充“现有项目评估与差距分析”  | Winston (Architect) |

## 需求

### 功能性需求（按导航与融合式交互重构）

#### 全局与交互框架

- FR1 多公司与上下文：系统支持多公司（福建微柏、福建鲤东、成都鲤东）隔离，切换公司上下文后，导航、搜索、对话与数据范围即时收敛；支持跨公司（受限）管理能力。
- FR2 默认“对话（模块）”：每个模块提供“对话（模块）”为默认首路由，支持“智能模式/表单模式”一键切换；对话可触发业务动作并落库审计。
- FR3 命令面板/全局搜索：顶栏提供命令面板（Cmd/Ctrl+K）与全局搜索，支持自然语言直达“视图/动作/实体”，执行前走权限校验与二次确认。
- FR4 卡片化回复与行动：统一 CardSchema（摘要/表格/图表/列表/操作），对话返回卡片可一键“提交/生成报表/导出/跳转视图”。
- FR5 Dify 集成与安全：通过 iframe + PostMessage 集成 Dify，对话上下文与参数由服务端签名/限流/脱敏后透传，防止越权与数据外泄。
- FR6 权限与审批联动：任何由对话触发的“有副作用动作”必须经过 RBAC/ABAC 校验；涉及流程的动作与审批引擎联动，必要时出具“预览/草稿”。

#### 工作台（Workbench）

- FR10 今日概览：基于用户上下文生成“智能摘要与下一步建议”卡片，支持一键执行建议动作与跳转。
- FR11 待办/我发起/我参与：统一聚合项目、审批、人事、资料库相关待办，支持批量处理与命令面板快速操作。
- FR12 活动与通知：展示最近活动时间线与系统通知，支持筛选与静音订阅。
- FR13 全局搜索与命令：可检索项目/任务/报表/审批/员工/资料库等，并转化为可执行命令或直达视图。

#### 项目管理（Projects）

- FR20 对话（项目）：自然语言创建项目/任务、查询进度与风险、调整里程碑/资源/成本、生成“周报/看板/甘特/成本”卡片。
- FR21 列表/甘特/看板：提供项目列表、甘特图、看板视图；支持依赖关系、里程碑、负责人与标签等维度。
- FR22 成本与周交付：成本分析（预算/实际/偏差/预测）与“周交付”跟踪视图；可从对话一键落地报表或纠偏建议。
- FR23 模板中心：项目与任务模板库，支持从对话快速套用模板创建项目。

#### 财务管理（Finance）

- FR30 对话（财务）：生成日/周/月报、解释指标、对异常发出告警并溯因；支持“导出/分享/派发审批”。
- FR31 报表与仪表盘：报表配置化生成与权限控制；财务仪表盘可钻取到原始凭证。
- FR32 指标预警：可配置阈值与规则，支持消息推送与工作台提醒。
- FR33 历史采购对比：按供方/物料/时间维度对比分析，并给出采购建议卡片。
- FR34 多 DB 连接器：支持 MySQL/PostgreSQL/SQL Server 等财务库连接与元数据映射。

#### 申请管理（Requests）

- FR41 发起申请：内置常用请假/出差/报销/用章等模板，支持草稿与附件。
- FR42B 我发起/申请历史：统一“我发起”与“申请历史”的视图与筛选，支持按时间/状态/类型筛选与导出；包含筛选维度：状态（草稿/审批中/已通过/已驳回/已撤回）、类型（请假/出差/报销/用章/自定义）、时间范围（发起/完成）、金额区间、发起人/部门、关键字；列表字段示例：单号、标题、类型、发起人、部门、金额、状态、创建时间、完成时间；支持保存筛选、导出与订阅。

#### 审批管理（Approvals）

- FR40 对话（审批）：自然语言发起/催办/回撤，解释当前规则与命中条款；生成带表单片段的操作卡片。
- FR42A 审批待办/审批历史：统一“待办箱”与“审批历史”的视图与筛选，支持批量审批、转办/加签与催办；包含筛选维度：状态（待审批/已审批/已退回/已撤回）、优先级、SLA/超时、流程节点、发起人、部门、时间范围、业务类型、金额区间；列表字段示例：单号、标题、类型、当前节点、发起人、部门、金额、状态、剩余SLA、创建时间、更新时间；支持自定义列与快速操作（同意/驳回/转办/加签/催办）。
- FR43 流程配置与规则：可视化配置流程/条件/节点权限；对话可解释某条规则的来源与影响。

#### 员工管理（HR）

- FR50 对话（人事）：查档、信息变更、生成个人/团队周报/月报、绩效问答与建议。
- FR51 组织与档案：组织架构图、员工档案详情、在岗状态；支持批量导入与变更审核。
- FR52 效率评估与报告：自动生成效率评估报告，支持维度对比与趋势图。
- FR53 技能矩阵：维护技能维度，支持项目排班建议与能力缺口分析。

#### 资料库（Knowledge）

- FR60 对话（资料）：语义检索/对比/引用与版本建议；可生成“引用卡片/对比表”。
- FR61 方案/零件/PLC 资料库：结构化存储、元数据与版本管理、权限与外链分享（可时效）。
- FR62 智能检索：关键词 + 向量混合检索，支持跨公司受限检索与可见性。
- FR63 上传与版本：多格式上传、自动提取摘要与标签、版本差异对比。

#### 目标与 BI（Goals & BI）

- FR70 对话（目标）：目标拆解、校验、跟踪与复盘；生成复盘卡片与行动项。
- FR71 目标管理与审核：支持强制性目标审核流程，多级审核与变更记录。
- FR72 业务数据挖掘与宣传：自动化数据挖掘与“宣传材料生成”卡片，支持导出。
- FR73 智能仪表盘：关键业务指标仪表盘，支持收藏、订阅与分享。

#### 数据与集成（Data & Integration）

- FR80 对话（数据）：同步状态问答、排障、调度建议；可一键触发重试或暂停任务。
- FR81 钉钉集成：同步组织、消息、考勤/日志等（依据权限与合规）。
- FR82 同步调度与统一数据访问：可配置调度；统一数据访问层提供标准化读写接口与缓存。
- FR83 数据质量：规则校验、异常告警、修复建议卡片。

#### 设置与安全（Settings & Security）

- FR90 对话（设置）：解释权限、生成最小授权建议、定位异常配置。
- FR91 公司切换与隔离：公司切换、租户隔离与跨公司受限访问。
- FR92 权限与角色：RBAC + ABAC，细粒度到实体/字段/动作。
- FR93 数据源配置、安全与认证、审计日志：集中配置，变更留痕可追溯。

#### 帮助与支持、个人中心

- FR100 对话（帮助）：问文档、提工单、生成诊断报告。
- FR101 使用指南、反馈与工单、版本与更新、关于。
- FR110 个人中心：我的资料、偏好（默认“智能模式”）、我的收藏、最近访问。

### 非功能性需求（融合式交互增强）

- NFR1 安全与隐私：端到端加密、敏感数据脱敏/最小化传输；Prompt 注入防护与上下文签名；严格的跨租户隔离。
- NFR2 性能预算：
  - UI 首屏加载 ≤ 3s；常用视图交互 ≤ 200ms；
  - 对话首 token 延迟 P95 ≤ 800ms；常规问答 P95 ≤ 2.5s；含工具/查询的动作 P95 ≤ 5s（流式优先）。
- NFR3 可用性与退化：命令面板与对话服务可用性 ≥ 99.9%；外部 AI 不可用时回退到模板/缓存结果与人工流程。
- NFR4 权限与审计：所有由对话触发的动作必须记录“消息ID、请求参数、审批/权限决策、执行结果”；可追溯、可导出。
- NFR5 兼容性与响应式：桌面/平板/移动端一致体验；WCAG AA 无障碍。
- NFR6 国际化与多语言：至少支持中英文，命令面板与对话均可多语言输入输出。
- NFR7 版本化与兼容：CardSchema/Action 协议版本化，向后兼容；命令与搜索提供稳定 ID。
- NFR8 速率限制与熔断：面向 Dify/外部系统的限流、重试与熔断策略；避免级联故障。

## 验收度量与成功标准（KPI & Metrics）

- 业务可用性
  - 三家公司均可独立登录与切换上下文，数据隔离正确（抽样 100% 通过）
  - 工作台“今日概览”与待办聚合上线，日活用户≥60% 使用智能建议
- 性能与稳定性
  - 首屏 ≤ 3s；常用交互 ≤ 200ms；首 token 延迟 P95 ≤ 800ms（达成 NFR2）
  - 可用性 ≥ 99.9%，出现外部依赖故障时具备退化策略（达成 NFR3）
- 安全与合规
  - 对话触发动作 100% 记录审计（消息ID/参数/决策/结果）（达成 NFR4）
  - 跨租户访问拦截率 100%，权限误判率 < 0.5%
- 交互一致性
  - 12 个顶层模块均具备“对话（模块）”入口与卡片化回复
  - 命令面板覆盖 ≥ 80% 高频视图/动作直达

## 用户界面设计目标

### 整体 UX 愿景

打造一个现代化、直观、高效的企业级协作平台界面，让三家公司员工都能轻松使用 AI 功能提升工作效率。界面应该体现专业性，同时保持简洁友好，降低学习成本。重点突出 AI 助手的智能特性和数据可视化的直观性。

### 关键交互范式

- **AI 对话交互**：采用聊天式界面，支持上下文记忆和多轮对话，类似微信/DingTalk 的交互体验
- **数据可视化交互**：提供拖拽式仪表盘，支持实时数据更新和钻取分析
- **工作流程交互**：采用引导式流程设计，提供清晰的步骤指示和进度反馈
- **多公司切换交互**：通过顶部导航栏快速切换不同公司视图，保持界面一致性

### 核心界面和视图

- **登录/认证界面**：支持多因子认证，集成企业 SSO 系统
- **主仪表盘**：展示关键业务指标、待办事项、AI 助手入口
- **项目管理界面**：甘特图视图、看板视图、成本分析图表
- **财务报表界面**：动态报表生成器、财务指标预警面板
- **AI 助手界面**：对话式交互界面，支持多种 AI 模式切换
- **员工管理界面**：组织架构图、效率评估报告、技能矩阵
- **审批管理界面**：流程可视化、待处理审批列表、审批历史
- **设置管理界面**：权限配置、数据源配置、系统设置

## 导航与交互重构（AI 融合式）

### 顶层信息架构与菜单

- 工作台
  - 今日概览（智能摘要与下一步建议）
  - 待办/我发起/我参与
  - 最近活动与通知
  - 全局搜索/命令面板
- 项目管理
  - 对话（项目）：自然语言创建/查询/调整进度与成本
  - 项目列表
  - 甘特图
  - 看板
  - 成本分析
  - 周交付
  - 报表与仪表盘
  - 模板中心
- 财务管理
  - 对话（财务）：自然语言生成报表/解读指标/告警溯因
  - 报表（日/周/月）
  - 指标预警
  - 历史采购对比
  - 财务仪表盘
- 审批管理
  - 对话（审批）：发起/催办/回撤/解释规则
  - 发起申请（含常用：请假/出差/报销/用章）
  - 待我处理
  - 我发起的
  - 审批历史
  - 流程配置与规则
- 员工管理
  - 对话（人事）：查档、变更、周/月报生成、绩效问答
  - 组织架构
  - 员工档案
  - 效率评估
  - 报告生成（周报/月报）
  - 技能矩阵
- 资料库
  - 对话（资料）：语义检索/对比/引用与版本建议
  - 方案资料库
  - 设计零件资料库
  - PLC 设计资料库
  - 智能检索
  - 上传与版本
- 目标与 BI
  - 对话（目标）：目标拆解/校验/跟踪与复盘
  - 目标管理
  - 目标审核
  - 业务数据挖掘
  - 宣传材料生成
  - 业务智能仪表盘
- 数据与集成
  - 对话（数据）：同步状态问答/排障/调度建议
  - 钉钉集成
  - 数据库连接器
  - 同步调度
  - 统一数据访问层
  - 数据质量
- 设置与安全
  - 对话（设置）：权限解释/最小授权建议/异常排查
  - 公司切换
  - 权限与角色
  - 数据源配置
  - 安全与认证
  - 审计日志
- 帮助与支持
  - 对话（帮助）：问文档/提工单/诊断报告
  - 使用指南
  - 反馈与工单
  - 版本与更新
  - 关于
- 个人中心
  - 我的资料
  - 偏好设置（默认“智能模式”）
  - 我的收藏
  - 最近访问

### 融合式交互原则（平台一致性）

- 模块内默认“智能模式”与“表单模式”可切换；首屏即聊天栏，以对话驱动操作，必要时弹出表单片段。
- 每个模块的第一个子项固定为“对话（模块）”，承载智能创建/查询/修改/解释。
- 顶栏提供“命令面板/全局搜索”，可自然语言直达任意模块动作与视图。
- 卡片化回复：支持摘要、图表、表格、以及可执行按钮（如“提交”“生成报表”“导出 Word”）。

### 关键验收标准（导航与交互）

- 首屏“工作台-今日概览”展示用户上下文的智能摘要与下一步建议。
- 任一模块进入默认落在“对话（模块）”视图，且可一键切换“表单模式”。
- 命令面板支持自然语言与快捷指令，能跳转到菜单项或直接执行动作（具备权限校验与二次确认）。
- 所有 AI 回复均以卡片为主展示，并可附带后续行动按钮；操作结果可在同一对话上下文追踪。
- 切换公司上下文后，导航与搜索结果即时收敛到当前公司可见数据。

### 无障碍访问：WCAG AA

系统应遵循 WCAG AA 标准，确保色盲用户可正常使用，支持键盘导航和屏幕阅读器。

### 品牌标识

采用现代化企业级设计风格，主色调使用蓝色系体现专业性和科技感。界面元素保持一致性，采用卡片式布局提升信息层次感。

### 目标设备和平台：Web 响应式

支持桌面端（1920x1080及以上）、平板端（768px-1024px）和移动端（375px-768px），确保在各种设备上都有良好的用户体验。

## 技术假设

### 仓库结构：Monorepo

采用 pnpm workspace 管理的 Monorepo 结构，这与现有 FactoryOS 架构保持一致。这种结构便于包管理和代码共享，支持独立开发和部署。

工程基线：Node ≥ 20.10，pnpm ≥ 9.12；使用 Turbo 进行任务编排。请在 PR/发布前执行 `pnpm check` 与 `pnpm test:*` 相关检查，保持与仓库的 CI 规约一致。

### 服务架构

采用 **Monorepo 内的微服务架构**。前端保持单体应用架构，后端服务采用微服务设计，通过 API 网关统一管理。AI 功能通过 Dify iframe 集成，数据集成通过独立的服务模块实现。

### 测试要求：完整测试金字塔

实施 **单元测试 + 集成测试 + E2E 测试** 的完整测试策略。单元测试覆盖核心业务逻辑，集成测试验证服务间交互，E2E 测试确保用户流程正常工作。

### 额外技术假设和请求

#### 前端技术栈

- **框架**：继续使用 Vue 3.5+ 和 TypeScript 5.8+，与现有技术栈保持一致
- **UI 组件库**：继续使用 Ant Design Vue 4.2+，确保界面一致性
- **状态管理**：使用 Pinia 3.0+ 进行状态管理
- **构建工具**：继续使用 Vite 7.1+ 进行开发和构建
- **图表库**：集成 ECharts 或 Apache ECharts 进行数据可视化
- **AI 通信**：使用 PostMessage API 与 Dify iframe 进行安全通信

#### 后端技术栈

- **API 服务**：基于现有 Nitro Mock 服务扩展，或考虑 Node.js + Express/Fastify
- **数据库**：支持多种数据库（MySQL、PostgreSQL、SQL Server），使用 Prisma 或 TypeORM 进行数据访问
- **缓存**：使用 Redis 进行会话管理和数据缓存
- **消息队列**：使用 Redis 或 Bull Queue 处理异步任务
- **文件存储**：支持本地存储和云存储（AWS S3、阿里云 OSS）

#### AI 集成技术

- **Dify 平台**：通过 iframe 嵌入，使用 PostMessage API 进行通信
- **数据处理**：实现数据清洗和验证机制，防止 AI 生成错误信息
- **模型选择**：支持多种 AI 模型，可根据业务需求选择合适的模型

#### 安全和认证

- **认证机制**：基于 JWT 的认证系统，支持 Token 刷新
- **权限控制**：实现 RBAC + ABAC 混合权限模型
- **数据加密**：敏感数据使用 AES-256 加密存储
- **API 安全**：实施 API 限流、参数验证和 SQL 注入防护

#### 部署和运维

- **容器化**：使用 Docker 进行应用容器化
- **CI/CD**：使用 GitHub Actions 或 GitLab CI 进行自动化部署
- **监控**：集成应用性能监控（APM）和错误追踪
- **日志**：结构化日志记录，支持日志聚合和分析

### 与现有代码的接口契约（首批）

为确保前后端协同与可替换性，以下 Mock 契约作为第 0 版参考标准（以 `apps/backend-mock` 为准）：

- 认证与权限
  - `POST /auth/login`：输入 `{ username, password }`，返回 `{ accessToken }` 并设置刷新 Token Cookie；失败返回 403 与统一错误体。
  - `POST /auth/refresh`：返回新的 Access Token；需携带 Cookie；失败状态遵循 401/403 语义。
  - `POST /auth/logout`：清除 Cookie 与会话状态。
  - `GET /auth/codes`：返回权限码字符串数组，用于前端菜单/按钮级控制。
- 用户与菜单
  - `GET /user/info`：返回当前用户信息与角色等。
  - `GET /menu/all`：返回菜单树（含基础路由/权限标记）。
- 系统数据与通用能力
  - `GET /system/dept/list`、`GET /system/role/list`：分页/过滤列表。
  - `PUT/DELETE /system/dept/[id]`：示例性更新/删除端点。
  - `GET /table/list`：通用表格数据。
  - `POST /upload`：通用上传返回文件 URL。

以上端点仅为 Mock 参考，真实后端需在网关层补充多租户上下文校验、RBAC/ABAC 判定、审计落库与限流/熔断策略，并对外以 OpenAPI 契约发布。

OpenAPI 契约草案（v0）：docs/openapi/factoryos-openapi.yaml

### AI 助手现状与规划

- 现状
  - 前端已提供 `AI 助手 · 对话` 视图（`apps/web-antd/src/views/ai-assistant/chat/index.vue`），支持通过路由 `url|base|token|inputs|hideBrand` 参数或环境变量构建 iframe 地址，具备 Loading/错误兜底与“品牌遮挡（可选）”能力。
  - `inputs` 支持按键值在浏览器侧进行 `gzip + base64 + encodeURIComponent` 编码（CompressionStream 可用则启用），用于 Dify 的兼容性输入。
- 规划
  - M1：引入与后端的 PostMessage 双向通信与服务端签名（traceId、nonce、ts、HMAC），统一 CardSchema 与 Action 执行路径（只读动作优先）。
  - M2：动作执行前置 RBAC/ABAC 判定、草稿/二次确认/审批联动；支持“转离线任务”降级；卡片版本化与向后兼容。
  - M3：统一命令面板/全局搜索与对话的语义对齐，形成“直达视图/动作”的一致体验；可观测性打通（cards/actions 级指标）。

#### 端到端验收脚本模板（GWT 对齐）

以下模板用于 Playwright E2E 场景编写，与本 PRD 的 GWT 标准一致。落脚点在 `apps/web-antd` 前端与（可选）`apps/backend-mock` 签名/权限伪服务。

场景 A：对话视图加载与 PostMessage 握手
- Given 已配置 Dify `base/token` 与开启签名通道特性开关
  When 访问“AI 助手 · 对话”视图并等待 iframe 加载完成
  Then 前端向 iframe 发送 handshake 消息并在 3s 内收到 ack，UI 展示可输入状态
- 脚本要点：
  - 等待选择器：页面路由 `/ai-assistant/chat`，iframe 可见
  - 使用 `page.frameLocator('iframe')` 与 `window.postMessage` 监听
  - 断言 handshake ack 收到且 payload 含 traceId

场景 B：inputs 编码链路（gzip + base64 + encodeURIComponent）
- Given 浏览器支持 CompressionStream 且启用 inputs 压缩
  When 发送包含复杂 `inputs` 的请求
  Then 实际传输体已按约定编码，并被对端成功解码
- 脚本要点：
  - 构造 inputs（嵌套对象与较长文本）
  - 通过 DevTools protocol/拦截器校验请求 query/body 中的编码形态
  - 对端回显原文片段用于断言

场景 C：签名通道与权限前置校验
- Given 后端暴露签名接口，权限网关返回允许
  When 在对话中点击“操作卡片 · 生成报表”
  Then 前端携带签名调用通过，返回执行结果卡片并记录审计
- 脚本要点：
  - 使用 Mock 路由注入签名响应（traceId、nonce、ts、HMAC）
  - 拦截并断言调用头/签名参数齐全
  - 断言页面出现“执行成功/报表链接”

场景 D：权限拒绝与错误卡片退化
- Given 权限网关配置为拒绝目标动作
  When 在对话中执行“提交审批”
  Then 返回“无权限”卡片并写入审计；无页面异常
- 脚本要点：
  - 注入 403 响应与统一错误体
  - 断言卡片 UI 的错误状态与按钮禁用

场景 E：Dify 不可用时的降级
- Given Dify 服务超时或 5xx
  When 发送对话请求
  Then 在 2s 内展示错误卡片，并给出“使用模板/缓存结果”按钮
- 脚本要点：
  - 注入超时/5xx，统计超时到错误卡片出现的时间
  - 点击模板/缓存按钮后展示静态结果

场景 F：卡片操作 + 表单片段 + 二次确认
- Given 对话返回“操作卡片（提交报表）”且需要补充参数
  When 打开表单片段填写并确认
  Then 通过 ActionBus 执行动作并返回结果卡片，期间出现二次确认
- 脚本要点：
  - 断言表单校验消息出现/消失
  - 捕获二次确认弹窗并确认继续

场景 G：性能预算（首 token 延迟）
- Given 网络与后端稳定
  When 发送一条常规问答
  Then 首 token 延迟 P95 ≤ 800ms（以 20 次取样）
- 脚本要点：
  - 记录“请求发出时间”和“第一段流式文本 DOM 变化时间”
  - 运行 20 次并计算 P95；超阈则标红

场景 H：特性开关回退（直连 iframe 模式）
- Given 关闭签名通道开关
  When 重新进入对话页
  Then 使用直连模式仍可完成基本问答，且无签名调用
- 脚本要点：
  - 断言未调用签名接口
  - 断言问答正常返回

脚手架建议（Playwright）
- 目录：`playground/__tests__/e2e/ai-assistant.spec.ts`
- 基础夹具：公司上下文、签名服务开关、权限网关策略、Dify 可用性
- 通用断言：卡片标题/状态按钮、审计提示文案、首 token 计时

## Epic 列表

### Epic 1: 融合式交互框架与多租户安全
统一“对话（模块）+ 表单片段 + 命令面板/全局搜索”的交互基础；实现多公司上下文、RBAC/ABAC、Dify 安全集成与卡片协议（CardSchema）。

### Epic 2: 工作台（今日概览与待办聚合）
以“今日概览”卡片为核心，聚合待办/我发起/我参与、活动与通知、全局搜索/命令面板的落地与闭环执行。

### Epic 3: 项目管理（对话驱动 + 甘特/看板/成本/周交付）
支持对话创建/查询/调整项目进度与成本，提供列表、甘特、看板、成本分析、周交付与模板中心。

### Epic 4: 财务管理（对话、报表、预警、历史采购）
自然语言生成与解释日/周/月报，指标预警、历史采购对比与财务仪表盘，连通多种财务数据库。

### Epic 5: 审批管理（对话与流程配置）
对话发起/催办/回撤/解释规则；常用表单模板；待办与历史；可视化流程配置与规则说明。

### Epic 6: 员工管理（人事对话、档案与效率）
对话驱动查档/变更/报告生成；组织架构、员工档案、效率评估、技能矩阵。

### Epic 7: 资料库（语义检索与版本）
资料对话检索/对比/引用与版本建议；方案/零件/PLC 资料库；智能检索与上传版本管理。

### Epic 8: 目标与 BI（拆解/校验/复盘与仪表盘）
对话拆解与校验目标；目标管理与审核；业务数据挖掘、宣传材料生成与智能仪表盘。

### Epic 9: 数据与集成（钉钉/连接器/调度/统一访问/质量）
钉钉集成；数据库连接器；同步调度；统一数据访问层与数据质量治理；对话式排障与调度建议。

### Epic 10: 设置与安全（最小授权与审计）
对话解释权限、生成最小授权建议；公司切换；权限与角色；数据源配置；安全与认证；审计日志。

### Epic 11: 帮助与支持（对话化支持台）
对话问文档/提工单/生成诊断报告；使用指南、反馈与工单、版本与更新、关于。

### Epic 12: 个人中心（偏好与收藏）
我的资料；偏好设置（默认“智能模式”）；我的收藏与最近访问。

## Epic 详细设计

### Story 编写规范（Brownfield 模板）

为保障 Stories 可执行、可验证、可追溯，统一采用如下最小模板（与 QA 的 Given/When/Then 对齐）：

- 用户故事：作为{角色}，我希望{能力}，以便{业务价值}
- 业务价值：一句话说明达成的直接收益或风险降低
- 前置依赖：接口/数据/权限/特性开关等依赖清单（可简述）
- 验收标准（Given-When-Then）：
  - Given {初始前提/上下文}
  - When {触发动作/条件}
  - Then {系统可观测的结果/状态/侧写}
- 非目标：本迭代未覆盖范围，避免误解
- 备注：数据样例/边界情况/回滚要点（如适用）

### Epic 编写规范（Brownfield 模板）

为方便后续按“PM *create-epic”流程扩展小型增量（1–3 个故事即可完成、低风险、无明显架构变更），本 PRD 引入统一的 Epic 规范模板（参考 brownfield-create-epic）：

- Epic 标题：{增强名称} - Brownfield Enhancement（或使用中文业务名）
- Epic 目标：1–2 句说明该 Epic 达成的业务价值
- Epic 描述：
  - 现有系统上下文（相关功能/技术栈/集成点）
  - 增强细节（变更点、对接方式、成功标准）
- Stories（1–3 条，聚焦、可独立验收）
- 兼容性要求：API/Schema/UI/性能约束需保持兼容或最小影响
- 风险与回滚：主要风险、缓解手段、回滚方案
- 完成定义（DoD）：达成条件清单，含测试与文档
- 验证清单：范围/风险/完整性三方面的自检项

后续如需为单一小功能创建独立 Epic，可直接引用以上模板并链接回本 PRD 的相关需求与约束。

### Epic 1: 融合式交互框架与多租户安全

**Epic 目标：** 打底“AI 融合式”能力：Conversation Shell（对话壳）、CardSchema、命令面板/全局搜索、Dify 安全集成、RBAC/ABAC、多公司上下文与审计闭环。

**Epic 描述（现状与增强）：**
- 现有：前端已具备基础 AI 对话视图（iframe Dify）与部分 Mock 能力，但缺少服务端签名、统一卡片协议、Action 执行通道与多租户安全基座。
- 增强：抽象 Conversation Shell 与 CardSchema，建立 ActionBus 与命令面板/全局搜索一致协议；补齐多公司上下文传播、RBAC+ABAC 判定与全链路审计。

**Stories（概览）：**
- 见下方 Story 1.1–1.5 的详细验收要点。

**兼容性要求：**
- 不破坏现有菜单/路由与登录流程；对现有 AI 视图提供向后兼容 iframe 参数协议。
- 若引入服务端签名与权限网关，客户端调用需保持稳定接口（以 OpenAPI 契约发布），前端通过 feature flag 渐进切换。
- UI 交互遵循既有组件与主题规范；性能预算满足 NFR2。

**风险与回滚：**
- 风险：签名/权限网关引入导致首 token 延迟升高；Action 执行路径新旧并存造成一致性问题。
- 缓解：灰度发布与开关控制；关键路径压测与缓存；详细审计辅助排障。
- 回滚：保留原有 iframe 直连模式与本地权限判定路径，可一键切换回旧模式。

**完成定义（DoD）：**
- Story 1.1–1.5 验收要点全部通过；
- 单元/集成/E2E 覆盖核心流（命令/对话/卡片/权限/审计）；
- OpenAPI 契约与前端接口文档更新；
- 性能与可用性指标符合 NFR2/NFR3；
- 变更记录与运维手册（含开关/回滚）完善。

**验证清单（自检）：**
- 范围：本 Epic 在不触及业务域功能细节前提下，完成交互与安全内核落地；
- 风险：签名、权限、审计链路均有监控与压测报告；
- 完整：提供演示用例与回归脚本，支持灰度与快速回滚。

#### Story 1.1: 多公司上下文与隔离
验收要点：
1. 三公司数据物理/逻辑隔离；切换公司后导航/搜索/对话结果即时收敛。
2. 跨公司访问需具备显式权限与审计记录。
3. 所有 API 强制带公司上下文，越权请求拒绝并告警。

验收标准（Given-When-Then）：
- Given 用户已登录并处于公司A上下文
  When 在顶栏切换到公司B
  Then 顶部导航、全局搜索与对话检索结果收敛到公司B数据
- Given 用户对公司B无“跨公司可见”权限
  When 在公司A上下文请求公司B资产
  Then 后端以 403 拒绝，请求被审计并触发告警
- Given 任意 API 调用
  When 平台侧检测到缺失公司上下文
  Then 拒绝请求并输出统一错误体与审计记录

#### Story 1.2: RBAC+ABAC 权限与审计
验收要点：
1. 动作级/实体级/字段级权限判定；对话触发动作统一走权限网关。
2. 审计记录至少包含“消息ID/参数/决策/结果/操作者/时间”。
3. 审计可检索与导出；敏感字段按策略脱敏。

验收标准（Given-When-Then）：
- Given 用户具备查看权限但无编辑权限
  When 通过对话尝试提交“编辑实体”动作
  Then 权限网关拒绝并返回“无权限”卡片，同时记录完整审计
- Given 用户查看含敏感字段的记录
  When 触发列表或详情查询
  Then 响应中敏感字段按策略脱敏，并在审计中标记字段级访问

#### Story 1.3: Dify iframe + PostMessage 安全集成
验收要点：
1. 服务端签名上下文与参数白名单；Prompt 注入与越权防护。
2. 首 token 延迟 P95 ≤ 800ms；流式渲染可回退。
3. 失败熔断/重试策略与错误卡片反馈。

验收标准（Given-When-Then）：
- Given 后端签名服务健康且浏览器支持 PostMessage
  When 用户打开对话视图并发送请求
  Then 请求携带签名与白名单参数，首 token 延迟 P95 ≤ 800ms，消息流式渲染
- Given Dify 服务暂时不可用
  When 触发对话请求
  Then 系统展示错误卡片并自动退化到模板/缓存结果

#### Story 1.4: Conversation Shell 与 CardSchema
验收要点：
1. 提供标准卡片（摘要/表格/图表/列表/操作/预览）。
2. 操作卡片绑定 ActionBus，支持“提交/生成/导出/跳转”。
3. 表单片段作为对话内模态片段挂载，可校验与二次确认。

验收标准（Given-When-Then）：
- Given 对话返回“操作卡片（提交报表）”
  When 点击卡片上的“提交”
  Then 通过 ActionBus 执行后端动作并反馈执行结果卡片
- Given 需要补充参数
  When 卡片要求填写表单片段
  Then 在对话内弹出表单，校验通过后方可二次确认提交

#### Story 1.5: 命令面板与全局搜索
验收要点：
1. Cmd/Ctrl+K 打开；支持自然语言与命令短语（#域 动作）。
2. 可直达“任意视图/实体/动作”，执行前权限校验与确认。
3. 结果与对话联动，可生成操作卡片或跳转。

验收标准（Given-When-Then）：
- Given 用户在任意页面
  When 按下 Cmd/Ctrl+K 并输入“#项目 创建任务”
  Then 命令面板展示候选并在确认后跳转到创建视图或生成操作卡片
- Given 用户缺少目标动作权限
  When 在命令面板直接执行动作
  Then 弹出权限不足提示并记录审计

### Epic 2: 工作台（今日概览与待办聚合）

**Epic 目标：** 通过“今日概览”提供一屏总览与可执行建议，统一待办聚合、活动时间线与全局搜索/命令面板入口。

**Epic 描述（现状与增强）：**
- 现有：基础菜单/Mock 数据可支撑原型，但缺少跨模块待办聚合与可执行建议。
- 增强：提供“今日概览”可执行卡片、跨域待办聚合、时间线与命令面板直达能力。

**Stories（概览）：**
- 见下方 Story 2.1–2.3 的详细验收要点。

**兼容性要求：**
- 不改变既有登录/导航行为；待办聚合以非侵入方式对接各域 API。
- 卡片渲染遵循 CardSchema v1；命令面板 ID 与对话动作保持一致。

**风险与回滚：**
- 风险：待办聚合导致性能波动；跨域权限差异。
- 缓解：按需加载与缓存；统一权限网关查询；降级为本地模块待办。
- 回滚：保留原工作台静态视图作为兜底。

**完成定义（DoD）：**
- Story 2.1–2.3 验收要点通过；
- 今日概览/待办/时间线可用并具备命令面板直达；
- 性能指标满足 NFR2；审计记录完整；
- 文档与回归用例更新。

**验证清单（自检）：**
- 范围：仅聚合/建议/时间线与命令面板联动；
- 风险：聚合查询有缓存与限流策略；
- 完整：存在演示数据与失败退化路径。

#### Story 2.1: 今日概览与建议卡片
验收要点：
1. 汇总关键 KPI、风险与下一步建议；建议卡片可一键执行。
2. 支持按用户角色定制内容与排序；可订阅/静音。
3. 切换公司上下文后，内容即时收敛。

验收标准（Given-When-Then）：
- Given 用户为项目经理角色
  When 打开工作台
  Then 今日概览显示项目 KPI 与风险，并生成可执行建议卡片
- Given 用户静音某类建议
  When 下次进入工作台
  Then 被静音建议不再展示

#### Story 2.2: 待办/我发起/我参与
验收要点：
1. 跨项目/审批/人事/资料库统一聚合，批量处理。
2. 命令面板可对选中项执行批量命令。
3. 提供筛选/订阅与通知策略。

验收标准（Given-When-Then）：
- Given 用户在待办视图勾选多条记录
  When 在命令面板执行“批量催办”
  Then 被选记录批量执行催办并生成审计记录
- Given 设置了订阅规则
  When 有新待办命中规则
  Then 用户在通知中收到聚合提醒

#### Story 2.3: 活动与通知时间线
验收要点：
1. 时间线展示最近活动；按模块/重要度筛选。
2. 与对话联动，可展开来源卡片或跳转。
3. 支持静音与回溯查询。

验收标准（Given-When-Then）：
- Given 时间线存在多模块活动
  When 按“项目模块/高优先级”筛选
  Then 列表仅展示符合条件的活动
- Given 某条活动关联对话来源
  When 点击“查看详情”
  Then 在当前页面展开来源卡片或跳转到相关视图

### Epic 3: 项目管理（对话 + 甘特/看板/成本/周交付）

**Epic 目标：** 覆盖项目全生命周期，对话驱动创建/查询/调整，配合甘特/看板/成本/周交付视图与模板中心。

**Epic 描述（现状与增强）：**
- 现有：有基础表格/上传等 Mock 能力，缺少对话驱动与视图间上下文互通。
- 增强：统一对话入口，模板中心与视图（甘特/看板/列表/成本/周交付）互通，生成卡片化周报与纠偏建议。

**Stories（概览）：**
- 见下方 Story 3.1–3.3 的详细验收要点。

**兼容性要求：**
- 不破坏现有菜单/权限；导入导出格式兼容现有模板。
- 甘特/看板采用既有 UI 规范；对话动作经权限网关与审计。

**风险与回滚：**
- 风险：复杂依赖/关键路径计算影响前端性能；成本口径不一致。
- 缓解：服务端预计算与分页；统一口径配置与校验；
- 回滚：关闭对话驱动，保留传统视图操作。

**完成定义（DoD）：**
- Story 3.1–3.3 验收通过；
- 视图互通（从卡片跳转保持上下文）；
- 关键报表可导出并附审计；
- E2E 场景覆盖“创建-跟踪-周报”。

**验证清单（自检）：**
- 范围：对话/模板中心/视图互通/成本与周交付；
- 风险：前后端分担计算与缓存策略已验证；
- 完整：有演示用例与数据集。

#### Story 3.1: 对话（项目）与模板中心
验收要点：
1. 自然语言创建项目/任务、调整里程碑/依赖/资源。
2. 一键套用项目/任务模板并可参数化。
3. 生成“周报/风险/纠偏建议”卡片。

验收标准（Given-When-Then）：
- Given 用户进入“对话（项目）”视图
  When 输入“创建项目并添加两个里程碑”
  Then 自动创建项目与里程碑并回显操作卡片，可进一步编辑确认
- Given 模板中心存在“标准实施模板”
  When 在对话中选择套用该模板并传入参数
  Then 系统按参数化结果创建任务结构并生成周报/风险建议卡片

#### Story 3.2: 甘特/看板/列表
验收要点：
1. 甘特支持依赖/关键路径、拖拽调整；看板支持泳道/在制限制。
2. 列表支持多维筛选与批量操作。
 3. 视图与对话互通：卡片跳转视图并保持上下文。

验收标准（Given-When-Then）：
- Given 甘特图存在任务依赖
  When 拖拽调整任务日期
  Then 系统实时重新计算关键路径并保存更新，审计记录变更
- Given 对话返回“查看任务详情”卡片
  When 点击“在看板中查看”
  Then 跳转至看板并定位对应卡片，筛选上下文保持一致

#### Story 3.3: 成本分析与周交付
验收要点：
1. 预算/实际/偏差/预测；维度：人工/材料/设备。
2. 周交付计划与状态跟踪；异常预警与处理卡片。
3. 可生成报表并派发审批/归档。

验收标准（Given-When-Then）：
- Given 已录入预算与实际成本
  When 打开成本分析视图
  Then 展示预算/实际/偏差/预测并可按维度切换
- Given 本周交付存在延迟风险
  When 风险命中阈值
  Then 生成预警卡片并可一键派发审批或创建纠偏任务

### Epic 4: 财务管理（对话、报表、预警、历史采购）

**Epic 目标：** 对话生成/解释报表、指标预警、历史采购对比与财务仪表盘，联通多数据库。

**Epic 描述（现状与增强）：**
- 现有：通用表格与 Mock 能力可用于示例，但缺少多数据库连接器、报表模板与预警策略落地。
- 增强：提供多 DB 连接器与统一映射；可配置报表模板、指标预警与历史采购对比；仪表盘可钻取。

**Stories（概览）：**
- 见下方 Story 4.1–4.3 的详细验收要点。

**兼容性要求：**
- 多数据库连接器向后兼容既有财务报表导出格式；
- 报表模板版本化、灰度发布；性能满足 NFR2，关键查询具缓存/限流。

**风险与回滚：**
- 风险：跨库映射与权限差异、长查询影响体验。
- 缓解：只读副本与预计算、查询分级与缓存、权限统一网关。
- 回滚：关闭新连接器，回退到单库直连与缓存报表。

**完成定义（DoD）：**
- Story 4.1–4.3 验收通过；
- 报表可导出/分享，预警生效并可追溯；
- 仪表盘可钻取到凭证；
- E2E 场景覆盖“生成-解释-预警-对比”。

**验证清单（自检）：**
- 范围：对话/报表/预警/对比/仪表盘与多 DB 接入；
- 风险：关键查询有缓存与限流；权限差异已适配；
- 完整：模板与连接器配置文档完备。

#### Story 4.1: 对话（财务）与报表生成
验收要点：
1. 自然语言生成日/周/月报；支持导出与分享。
2. 解释指标与波动；生成纠偏/节流建议卡片。
3. 报表可配置模板与权限，支持调度。

验收标准（Given-When-Then）：
- Given 用户输入“生成本周财务周报”
  When 报表模板与权限满足
  Then 生成周报卡片并支持导出/分享，附指标波动解释
- Given 设定调度为“每周一9:00”
  When 到达调度时间
  Then 自动生成报表并发送到订阅对象，审计记录包含派发详情

#### Story 4.2: 指标预警与历史采购对比
验收要点：
1. 阈值/规则配置，推送到工作台与消息。
2. 采购对比按供方/物料/时间维度，输出建议。
3. 异常与溯因卡片化展示，可派发任务。

验收标准（Given-When-Then）：
- Given 关键指标设置了阈值规则
  When 指标超阈
  Then 工作台收到预警卡片并可查看溯因与处理建议
- Given 选择供方/物料/时间维度
  When 执行对比分析
  Then 输出可执行建议并可派发为采购优化任务

#### Story 4.3: 多 DB 连接器与仪表盘
验收要点：
1. 连接 MySQL/PostgreSQL/SQL Server 并统一映射。
2. 财务仪表盘可钻取到凭证；收藏/订阅。
3. 高并发查询配合缓存与限流。

验收标准（Given-When-Then）：
- Given 已配置并连通三种数据库
  When 在仪表盘点击某指标
  Then 支持钻取到原始凭证记录，遵循权限控制
- Given 高并发访问场景
  When 压测并发达到目标QPS
  Then 指标稳定，命中缓存与限流策略，无报错

### Epic 5: 审批管理（对话与流程配置）

**Epic 目标：** 对话发起/催办/回撤/解释规则；常用申请模板；待办/历史；流程可视化配置与规则说明。

**Epic 描述（现状与增强）：**
- 现有：缺乏对话驱动的审批体验与规则可解释；流程配置未版本化。
- 增强：对话生成带表单片段的操作卡片；流程/规则可视化配置与解释；全链路审计。

**Stories（概览）：**
- 见下方 Story 5.1–5.3 的详细验收要点。

**兼容性要求：**
- 沿用现有 UI/权限规范；与工作台待办聚合无缝联动；
- 流程配置变更版本化与灰度。

**风险与回滚：**
- 风险：复杂流程导致性能与易用性下降；规则误配风险。
- 缓解：模板化常用流程、变更前模拟校验、二次确认。
- 回滚：保留旧流程引擎与静态表单路径。

**完成定义（DoD）：**
- Story 5.1–5.3 验收通过；
- 对话-表单片段-流程三者互通；
- 审计与导出可用；
- E2E 场景覆盖“发起-审批-撤回/催办-历史”。

**验证清单（自检）：**
- 范围：常用申请/待办/历史/流程配置与规则解释；
- 风险：模板化与模拟校验覆盖关键路径；
- 完整：与命令面板与工作台联动验证通过。

#### Story 5.1: 对话（审批）与常用申请
验收要点：
1. 对话生成带表单片段的操作卡片（请假/出差/报销/用章）。
2. 草稿/附件/抄送与通知；权限校验。
3. 支持撤回/催办并记录审计。

验收标准（Given-When-Then）：
- Given 用户在对话输入“发起请假3天”
  When 表单片段要求补充日期与原因
  Then 填写并提交后生成申请单，通知相关人员并记录审计
- Given 申请处于处理中
  When 用户执行“撤回”
  Then 流程撤回成功并生成撤回审计记录

#### Story 5.2: 待办/我发起/历史
验收要点：
1. 统一视图、筛选与批量；命令面板可操作。
2. 历史可按单据/人/规则检索与导出。
3. 与工作台待办联动。

验收标准（Given-When-Then）：
- Given 待办列表存在多条任务
  When 选择多条并执行“批量通过/拒绝”
  Then 批量处理成功并可在历史中按条件检索、导出
- Given 工作台与待办视图
  When 在工作台处理待办
  Then 待办视图实时同步状态

#### Story 5.3: 流程配置与规则解释
验收要点：
1. 可视化流程/条件/节点权限配置。
2. 对话解释当前单据命中规则与原因。
3. 版本化规则与回滚；变更留痕。

验收标准（Given-When-Then）：
- Given 流程新增条件节点配置
  When 发布新版本
  Then 新版本生效且可一键回滚到旧版本，变更有留痕
- Given 用户在对话询问“为什么进入二级审批”
  When 系统分析当前单据与规则
  Then 返回命中规则与原因说明

### Epic 6: 员工管理（人事对话、档案与效率）

**Epic 目标：** 对话查档/变更/生成周月报与绩效问答；组织、档案、效率、技能矩阵全覆盖。

**Epic 描述（现状与增强）：**
- 现有：基础组织/表格能力可复用，缺少报告生成与敏感字段级权限。
- 增强：对话生成周/月报与绩效问答；字段级 RBAC/ABAC；效率评估与技能矩阵。

**Stories（概览）：**
- 见下方 Story 6.1–6.3 的详细验收要点。

**兼容性要求：**
- 字段级权限与审计；导入导出沿用既有格式；
- 报告模板版本化。

**风险与回滚：**
- 风险：隐私与合规风险；评分模型争议。
- 缓解：脱敏/最小化展示；模型口径配置与解释；审批前置。
- 回滚：关闭评分与报告自动化，仅保留手工路径。

**完成定义（DoD）：**
- Story 6.1–6.3 验收通过；
- 报告生成/编辑/导出链路完整；
- 字段级权限生效并可审计；
- E2E 场景覆盖“查档-变更-报告”。

**验证清单（自检）：**
- 范围：对话/档案/效率/技能矩阵；
- 风险：隐私/口径有明确策略与审计；
- 完整：模板与演示数据齐备。

#### Story 6.1: 对话（人事）与报告生成
验收要点：
1. 一句话生成个人/团队周报/月报并可编辑。
2. 绩效问答与建议卡片；敏感信息脱敏。
3. 变更生成审批单草稿。

验收标准（Given-When-Then）：
- Given 用户输入“生成团队月报草稿”
  When 系统汇总数据并脱敏
  Then 生成可编辑月报卡片，支持导出与提交审批
- Given 员工信息修改请求
  When 对话触发变更
  Then 自动生成审批草稿，敏感字段按权限脱敏

#### Story 6.2: 组织架构与档案
验收要点：
 1. 组织树与岗位编制；员工档案详情。
2. 批量导入/变更审核；历史追溯。
3. 权限到字段级（如薪酬）。

验收标准（Given-When-Then）：
- Given 导入员工变更文件
  When 通过校验并发起审核
  Then 审核通过后批量更新档案并记录历史
- Given 无薪酬字段权限的用户
  When 查看员工档案
  Then 薪酬字段被脱敏隐藏

#### Story 6.3: 效率评估与技能矩阵
验收要点：
1. 效率评分模型与趋势图；对比分析。
2. 技能维度维护与项目排班建议。
3. 导出报告与共享。

验收标准（Given-When-Then）：
- Given 已生成效率评分与趋势
  When 选择时间范围与对比组
  Then 展示趋势对比并生成改进建议
- Given 维护技能矩阵
  When 选择项目进行排班建议
  Then 输出人员建议名单并可导出分享

### Epic 7: 资料库（语义检索与版本）

**Epic 目标：** 对话检索/对比/引用与版本建议；方案/零件/PLC 资料库；智能检索与上传版本管理。

**Epic 描述（现状与增强）：**
- 现有：缺少资料结构化与版本能力，检索以关键字为主。
- 增强：语义+关键词混排检索，版本管理与 diff，引用卡片插入对话/文档。

**Stories（概览）：**
- 见下方 Story 7.1–7.3 的详细验收要点。

**兼容性要求：**
- 文件存储与外链权限与现有规范一致；
- 版本兼容与迁移工具。

**风险与回滚：**
- 风险：召回/相关性不稳定；外链权限误配。
- 缓解：可调参数与评估面板；外链有效期与权限模板。
- 回滚：保留普通上传+关键字检索兜底。

**完成定义（DoD）：**
- Story 7.1–7.3 验收通过；
- 引用卡片可用于对话/文档；
- 版本管理与 diff 可用；
- 检索效果有评估指标。

**验证清单（自检）：**
- 范围：检索/引用/版本；
- 风险：权限/召回控制机制有效；
- 完整：评估报告与退化路径存在。

#### Story 7.1: 对话（资料）与引用卡片
验收要点：
1. 语义检索 + 关键词混排；结果卡片可引用/对比。
2. 生成引用卡片并插入到对话或文档。
3. 跨公司检索受限与审计。

验收标准（Given-When-Then）：
- Given 用户进行资料语义检索
  When 选择两条结果进行对比
  Then 生成对比卡片并可插入到对话或文档
- Given 当前公司无权访问目标资料
  When 发起跨公司检索
  Then 返回受限提示并记录审计

#### Story 7.2: 资料库结构与版本
验收要点：
1. 方案/零件/PLC 分类与元数据；版本管理。
2. 上传抽取摘要/标签；版本 diff。
3. 外链分享（时效/权限）。

验收标准（Given-When-Then）：
- Given 上传新版本资料
  When 完成解析
  Then 自动生成摘要/标签并可与上版进行 diff
- Given 生成外链分享
  When 设置有效期与权限
  Then 链接在有效期内可访问并受权限控制

#### Story 7.3: 智能检索与推荐
验收要点：
1. 近义/相似推荐与去重；高召回与可解释。
2. 支持过滤/排序与收藏。
3. 检索效果可评估与反馈闭环。

验收标准（Given-When-Then）：
- Given 用户进行检索
  When 选择“相似推荐”并去重
  Then 返回去重后的相似结果并提供可解释信息
- Given 用户反馈“不相关”
  When 累积到阈值
  Then 推荐模型调整并在评估面板反映改进

### Epic 8: 目标与 BI（拆解/校验/复盘与仪表盘）

**Epic 目标：** 对话拆解与校验目标；目标管理与审核；业务挖掘、宣传材料生成与智能仪表盘。

**Epic 描述（现状与增强）：**
- 现有：缺乏统一目标管理与对话拆解能力。
- 增强：对话拆解/校验，复盘卡片与行动派发，BI 仪表盘与宣传材料生成。

**Stories（概览）：**
- 见下方 Story 8.1–8.3 的详细验收要点。

**兼容性要求：**
- 目标模板与审批对接；仪表盘组件复用；
- 导出渠道适配。

**风险与回滚：**
- 风险：目标口径不一致与指标失真。
- 缓解：口径配置与校验；关键指标可回溯到原始记录。
- 回滚：保留传统目标表单路径与手工汇报。

**完成定义（DoD）：**
- Story 8.1–8.3 验收通过；
- 行动项派发与回溯；
- 仪表盘订阅/分享可用；
- 宣传材料生成达可编辑发布。

**验证清单（自检）：**
- 范围：目标/复盘/BI/宣传材料；
- 风险：口径/追溯/隐私策略明确；
- 完整：模板与示例素材就绪。

#### Story 8.1: 对话（目标）与拆解/校验
验收要点：
1. 自然语言拆解目标、校验合理性与对齐关系。
2. 生成复盘卡片与行动项，一键派发。
3. 强制性审核前置检查。

验收标准（Given-When-Then）：
- Given 用户输入年度目标描述
  When 触发“拆解并校验”
  Then 产出合理性校验说明与分解清单，并生成行动项卡片
- Given 目标属于强制审核范围
  When 提交目标
  Then 执行前置检查，不通过时给出修正建议

#### Story 8.2: 目标管理与审核
验收要点：
1. 多级审核流与变更记录；可回溯。
2. 里程碑进度跟踪与提醒。
3. 目标完成度评估与对齐视图。

验收标准（Given-When-Then）：
- Given 目标处于二级审核
  When 审核通过
  Then 生成变更记录并进入执行阶段，提醒相关责任人
- Given 目标包含若干里程碑
  When 接近到期未达成
  Then 触发提醒并在对齐视图显示风险

#### Story 8.3: BI 仪表盘与宣传材料
验收要点：
1. 关键指标仪表盘，支持订阅与分享。
2. 自动生成宣传材料（文案/图片/视频）草稿。
3. 导出与渠道适配。

验收标准（Given-When-Then）：
- Given 已配置仪表盘订阅
  When 到达订阅时间
  Then 向订阅者发送最新快照
- Given 用户选择宣传模板
  When 生成草稿
  Then 输出可编辑的文案/图片/视频占位并支持导出到指定渠道

### Epic 9: 数据与集成（钉钉/连接器/调度/统一访问/质量）

**Epic 目标：** 打通钉钉与各数据库，提供调度、统一数据访问层与质量治理；对话式问诊/排障。

**Epic 描述（现状与增强）：**
- 现有：缺少统一数据访问层、调度器与质量治理；钉钉未接入。
- 增强：钉钉组织/消息/审批同步；连接器与统一访问层；调度与数据质量治理；对话排障与建议。

**Stories（概览）：**
- 见下方 Story 9.1–9.3 的详细验收要点。

**兼容性要求：**
- 连接器与访问层保持 API 稳定与分页；
- 同步/调度可观测与可限流；
- 钉钉权限与组织映射一致。

**风险与回滚：**
- 风险：同步风暴与速率限制；跨源权限差异。
- 缓解：限流/重试/熔断与增量/重放；权限网关；
- 回滚：逐步关闭连接器/同步源，保留核心只读能力。

**完成定义（DoD）：**
- Story 9.1–9.3 验收通过；
- 访问层读写接口与缓存可用；
- 质量规则与告警生效；
- 可观测性面板上线。

**验证清单（自检）：**
- 范围：钉钉/连接器/调度/访问层/质量；
- 风险：限流与熔断场景覆盖；
- 完整：回滚与隔离预案具备。

#### Story 9.1: 对话（数据）与排障/调度建议
验收要点：
1. 查询同步状态/错误；一键重试/暂停。
2. 生成调度建议卡片；支持应用。
3. 重要操作需二次确认与审计。

验收标准（Given-When-Then）：
- Given 某数据同步任务失败
  When 在对话中执行“一键重试”
  Then 任务重新排队执行并记录审计
- Given 大量延迟任务
  When 生成调度建议并应用
  Then 调整后的调度策略生效，指标回升

#### Story 9.2: 钉钉集成与同步
验收要点：
1. 组织/用户/消息/审批等按权限同步。
2. 增量同步、重放与监控面板。
3. 失败重试/告警与限流。

验收标准（Given-When-Then）：
- Given 启用增量同步
  When 组织结构发生变更
  Then 在监控面板可见增量任务完成并更新到本地
- Given 触发重放
  When 选择时间窗口
  Then 仅重放该窗口内事件，失败项触发重试与告警

#### Story 9.3: 统一数据访问层与质量
验收要点：
1. 提供标准读写接口与缓存策略。
2. 质量规则校验、异常告警与修复建议卡片。
3. 元数据字典与血缘追踪。

验收标准（Given-When-Then）：
- Given 通过访问层进行查询
  When 命中缓存策略
  Then 返回命中信息与延迟缩短，无一致性问题
- Given 数据质量规则命中
  When 产生异常
  Then 触发告警并生成修复建议卡片，可一键执行

### Epic 10: 设置与安全（最小授权与审计）

**Epic 目标：** 对话解释权限与生成最小授权建议；公司切换、权限与角色、数据源配置、安全与认证、审计日志。

**Epic 描述（现状与增强）：**
- 现有：设置分散、权限解释缺失、缺统一最小授权建议。
- 增强：对话解释权限与最小授权建议；公司切换、数据源配置与安全合规；全链路审计与导出。

**Stories（概览）：**
- 见下方 Story 10.1–10.3 的详细验收要点。

**兼容性要求：**
- 与多租户上下文一致；
- 密钥加密存储；
- 审计与导出遵循合规。

**风险与回滚：**
- 风险：授权误配与安全事件。
- 缓解：最小授权建议+二次确认；密钥轮转与最小暴露面。
- 回滚：关闭自动建议，仅保留人工配置。

**完成定义（DoD）：**
- Story 10.1–10.3 验收通过；
- 审计可检索/聚合/导出；
- 安全检查清单通过；
- E2E 场景覆盖“解释-建议-变更-审计”。

**验证清单（自检）：**
- 范围：权限/公司切换/数据源/安全/审计；
- 风险：变更有审批与回滚步骤；
- 完整：合规模板完备。

#### Story 10.1: 对话（设置）与最小授权建议
验收要点：
1. 输入目标动作与对象，输出最小授权角色/策略。
2. 一键生成变更草稿并走审批。
3. 解释当前权限命中与影响面。

验收标准（Given-When-Then）：
- Given 用户输入“允许张三审批报销”
  When 生成最小授权建议
  Then 输出最小角色/策略并可一键生成变更草稿提交审批
- Given 当前权限校验
  When 询问“为何无法提交审批”
  Then 返回命中规则与影响面解释

#### Story 10.2: 公司切换/数据源/安全与认证
验收要点：
1. 公司切换与隔离策略统一生效。
2. 数据源配置与密钥管理（加密存储）。
3. SSO/MFA 可选；API 限流/防注入。

验收标准（Given-When-Then）：
- Given 切换公司上下文
  When 访问数据源配置
  Then 仅展示该公司可见数据源，密钥以加密形式存储与展示
- Given 启用 MFA 策略
  When 用户登录
  Then 触发二次验证流程

#### Story 10.3: 审计日志与合规导出
验收要点：
1. 全链路审计（对话/命令/视图/API）。
2. 可检索/聚合/导出；保留期可配。
3. 合规报表模板。

验收标准（Given-When-Then）：
- Given 平台记录审计日志
  When 按“操作者/时间/资源类型”检索
  Then 返回结果支持聚合与导出，受保留期策略约束
- Given 选择合规模板
  When 生成报表
  Then 导出满足模板字段与格式要求

### Epic 11: 帮助与支持（对话化支持台）

**Epic 目标：** 对话问文档/提工单/诊断报告；使用指南、反馈与工单、版本与更新、关于。

**Epic 描述（现状与增强）：**
- 现有：帮助文档分散、缺诊断与对话式支持。
- 增强：对话生成诊断报告与工单；指南与版本更新联动。

**Stories（概览）：**
- 见下方 Story 11.1–11.2 的详细验收要点。

**兼容性要求：**
- 与工单系统/通知集成遵循既有契约；
- 支持国际化与多语言。

**风险与回滚：**
- 风险：误诊断或过度自动化。
- 缓解：人工复核与可编辑诊断；关键操作二次确认。
- 回滚：退化为手工工单与静态文档。

**完成定义（DoD）：**
- Story 11.1–11.2 验收通过；
- 诊断与工单闭环；
- 指南与版本日志上线；
- 指标可观测（响应时间/解决率）。

**验证清单（自检）：**
- 范围：对话/诊断/工单/指南；
- 风险：人工复核与权限校验在位；
- 完整：示例脚本与模板完备。

#### Story 11.1: 对话（帮助）与诊断报告
验收要点：
1. 根据上下文生成诊断报告卡片。
2. 一键创建工单并带上下文。
3. 可追踪状态与关闭。

验收标准（Given-When-Then）：
- Given 用户在异常页面触发“诊断”
  When 生成诊断卡片
  Then 可一键创建工单并自动附带上下文与日志摘要
- Given 工单处理完成
  When 用户在对话中查询状态
  Then 返回工单状态并可选择关闭

#### Story 11.2: 使用指南与版本更新
验收要点：
1. 场景化指南与搜索；收藏/分享。
2. 版本更新日志与影响说明。
3. 变更提示与引导。

验收标准（Given-When-Then）：
- Given 新版本发布
  When 用户进入系统
  Then 展示版本更新说明与高影响变更提示，可跳转至指南
- Given 用户收藏某指南
  When 下次搜索相关关键词
  Then 收藏结果优先展示

### Epic 12: 个人中心（偏好与收藏）

**Epic 目标：** 我的资料、偏好（默认“智能模式”）、收藏与最近访问，提升个性化与效率。

**Epic 描述（现状与增强）：**
- 现有：基础资料/偏好有限，缺收藏与跨模块最近访问。
- 增强：偏好（智能模式/语言/主题/快捷键）多端同步；收藏与最近访问联动命令面板。

**Stories（概览）：**
- 见下方 Story 12.1–12.2 的详细验收要点。

**兼容性要求：**
- 与登录/会话与多端同步机制兼容；
- 隐私擦除能力。

**风险与回滚：**
- 风险：隐私泄露与同步冲突。
- 缓解：最小化存储+本地优先；冲突合并策略。
- 回滚：关闭跨端同步，仅本地存储。

**完成定义（DoD）：**
- Story 12.1–12.2 验收通过；
- 偏好/收藏/最近访问功能闭环；
- 与命令面板候选联动；
- E2E 场景覆盖常用操作。

**验证清单（自检）：**
- 范围：资料/偏好/收藏/最近访问；
- 风险：隐私擦除与合规；
- 完整：导入导出与重置路径存在。

#### Story 12.1: 个人资料与偏好
验收要点：
1. 个人资料编辑与安全设置。
2. 偏好项覆盖“智能模式/语言/主题/快捷键”。
3. 多端同步。

验收标准（Given-When-Then）：
- Given 用户修改主题与语言
  When 保存偏好
  Then 全局应用并在其它设备同步生效（登录同账号）
- Given 开启“智能模式”
  When 返回各模块首页
  Then 默认进入对话视图

#### Story 12.2: 收藏与最近访问
验收要点：
1. 收藏视图/命令/搜索；一键打开。
2. 最近访问跨模块聚合，隐私可清理。
3. 与命令面板联动作为候选。

验收标准（Given-When-Then）：
- Given 用户收藏某视图与命令
  When 打开命令面板
  Then 收藏项出现在候选列表并可一键直达
- Given 用户清理隐私
  When 执行“清空最近访问”
  Then 最近访问记录被清理且不可恢复

## Checklist Results Report

_(待完成 PM Checklist 后填充)_

## 合规检查（PRD 自检）

- 文档完整性：目标/范围/术语/依赖/NFR/KPI/Epics/Stories/接口契约均具备
- 可执行性：每个 Epic 至少包含目标、Stories 与 DoD；核心 Epic（1–3）含兼容性/风险/回滚
- 一致性：术语与架构文档一致；导航与交互遵循“对话（模块）”范式
- 可测性：NFR 对应明确的指标与回归路径；关键流具备 E2E 场景
- 可回滚性：核心变更具备开关与旧路径兜底

## 修订记录

- v0.2 增补：范围/术语/依赖/KPI；为 Epic 1–3 补充兼容性、风险/回滚、DoD 与验证清单；新增 Brownfield Epic 模板与合规自检
- v0.3 增补：新增“Story 编写规范（Brownfield 模板）”；为 Story 1.1–1.5、2.1–2.3 及 Epic 3–12 全部 Stories 增加 GWT 验收标准；为“AI 助手现状与规划”新增 E2E 验收脚本模板（GWT 对齐）
- v0.3.1 拆分：新增 docs/prd/ 目录与分片索引；抽取“AI 助手现状与规划（含 E2E 模板）”至 docs/prd/ai-assistant.md；新增 Epics 索引 docs/prd/epics/README.md；新增各 Epic 分片 docs/prd/epics/epic-*.md（权威来源仍为本文件）
- v0.3.2 分片镜像：各 Epic 分片改为复制主文档全文内容，便于离线阅读与按章节评审；权威来源仍为本文件

## Next Steps

### UX Expert Prompt

基于此 PRD，请创建用户体验设计方案，重点关注多公司上下文一致性、AI 融合式交互（对话/卡片/命令面板）、以及关键业务（项目/财务/审批/人事）的可用性与可视化呈现。

### Architect Prompt

基于此 PRD，请创建技术架构设计，重点关注 Dify 安全集成（签名/限流/脱敏）、统一数据访问层、RBAC+ABAC 与审计闭环、以及缓存/熔断/限流等 SRE 要求。
