# é¡µé¢-å¿ƒè¯­ç²¾çµå¯¹è¯ç•Œé¢

> ç‰ˆæœ¬ï¼šv1.0.0 | æ›´æ–°æ—¥æœŸï¼š2025-10-08
> é¡µé¢è·¯å¾„ï¼š`miniprogram/independent/heartchat/index`
> åˆ†åŒ…ç±»å‹ï¼šç‹¬ç«‹åˆ†åŒ… | ä¾èµ–äº‘å‡½æ•°ï¼šaskMessageManager

## é¡µé¢æ¦‚è¿°

å¿ƒè¯­ç²¾çµå¯¹è¯ç•Œé¢æ˜¯MindGuardé¡¹ç›®çš„æ ¸å¿ƒAIäº¤äº’åŠŸèƒ½ï¼Œä¸ºç”¨æˆ·æä¾›7Ã—24å°æ—¶çš„æ™ºèƒ½å¿ƒç†é™ªä¼´æœåŠ¡ã€‚è¯¥é¡µé¢é›†æˆäº†å…ˆè¿›çš„å¤šAgentå¯¹è¯ç³»ç»Ÿã€å®æ—¶æƒ…ç»ªåˆ†æã€æ–‡åŒ–æ´å¯Ÿå’Œé£é™©è¯„ä¼°åŠŸèƒ½ï¼Œé€šè¿‡è‡ªç„¶è¯­è¨€äº¤äº’ä¸ºç”¨æˆ·æä¾›ä¸ªæ€§åŒ–çš„å¿ƒç†æ”¯æŒã€‚

## è®¾è®¡ç›®æ ‡

- **è‡ªç„¶äº¤äº’**ï¼šæä¾›æµç•…ã€è‡ªç„¶çš„å¯¹è¯ä½“éªŒï¼Œé™ä½ç”¨æˆ·ä½¿ç”¨é—¨æ§›
- **æ™ºèƒ½åˆ†æ**ï¼šå®æ—¶åˆ†æç”¨æˆ·æƒ…ç»ªçŠ¶æ€ï¼Œæä¾›æ·±åº¦å¿ƒç†æ´å¯Ÿ
- **å®‰å…¨ä¿éšœ**ï¼šé›†æˆé£é™©è¯„ä¼°æœºåˆ¶ï¼Œç¡®ä¿ç”¨æˆ·å®‰å…¨
- **ä¸ªæ€§åŒ–æœåŠ¡**ï¼šåŸºäºç”¨æˆ·ç‰¹ç‚¹æä¾›å®šåˆ¶åŒ–å›åº”å’Œå»ºè®®
- **éšç§ä¿æŠ¤**ï¼šä¸¥æ ¼çš„æ•°æ®éšç§ä¿æŠ¤ï¼Œè®©ç”¨æˆ·æ”¾å¿ƒäº¤æµ

## é¡µé¢æ¶æ„

### æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å¿ƒè¯­ç²¾çµå¯¹è¯ç•Œé¢                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å±•ç¤ºå±‚ (Presentation Layer)                                 â”‚
â”‚  â”œâ”€ Agenté€‰æ‹©é¢æ¿ (AgentSelector)                             â”‚
â”‚  â”œâ”€ å¯¹è¯æ¶ˆæ¯åˆ—è¡¨ (MessageList)                               â”‚
â”‚  â”œâ”€ AIåˆ†æç»“æœå¡ç‰‡ (AnalysisCards)                           â”‚
â”‚  â”œâ”€ è¾“å…¥åŒºåŸŸ (InputArea)                                    â”‚
â”‚  â””â”€ åŠŸèƒ½æ§åˆ¶æ  (ControlBar)                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é€»è¾‘å±‚ (Logic Layer)                                        â”‚
â”‚  â”œâ”€ å¯¹è¯çŠ¶æ€ç®¡ç† (ConversationManager)                        â”‚
â”‚  â”œâ”€ æ¶ˆæ¯å¤„ç† (MessageProcessor)                              â”‚
â”‚  â”œâ”€ åˆ†æç»“æœå±•ç¤º (AnalysisRenderer)                          â”‚
â”‚  â”œâ”€ å®‰å…¨ç›‘æ§ (SafetyMonitor)                                 â”‚
â”‚  â””â”€ ç¼“å­˜ç®¡ç† (CacheManager)                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ•°æ®å±‚ (Data Layer)                                         â”‚
â”‚  â”œâ”€ æœ¬åœ°å­˜å‚¨ (LocalStorage)                                  â”‚
â”‚  â”œâ”€ äº‘å‡½æ•°è°ƒç”¨ (CloudFunction)                               â”‚
â”‚  â”œâ”€ åˆ†ææ•°æ®å­˜å‚¨ (AnalysisData)                              â”‚
â”‚  â””â”€ ç”¨æˆ·é…ç½® (UserPreferences)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç»„ä»¶ç»“æ„

```
HeartChatPage
â”œâ”€â”€ AgentSelector (Agenté€‰æ‹©é¢æ¿)
â”‚   â”œâ”€â”€ AgentCard (Agentå¡ç‰‡)
â”‚   â”œâ”€â”€ AgentDescription (Agentä»‹ç»)
â”‚   â””â”€â”€ AgentHistory (å¯¹è¯å†å²)
â”œâ”€â”€ MessageList (æ¶ˆæ¯åˆ—è¡¨)
â”‚   â”œâ”€â”€ UserMessage (ç”¨æˆ·æ¶ˆæ¯)
â”‚   â”œâ”€â”€ AgentMessage (AIå›å¤)
â”‚   â”œâ”€â”€ AnalysisCard (åˆ†æç»“æœå¡ç‰‡)
â”‚   â””â”€â”€ SystemMessage (ç³»ç»Ÿæ¶ˆæ¯)
â”œâ”€â”€ InputArea (è¾“å…¥åŒºåŸŸ)
â”‚   â”œâ”€â”€ TextInput (æ–‡æœ¬è¾“å…¥)
â”‚   â”œâ”€â”€ VoiceInput (è¯­éŸ³è¾“å…¥)
â”‚   â”œâ”€â”€ EmotionPicker (æƒ…ç»ªé€‰æ‹©)
â”‚   â””â”€â”€ QuickActions (å¿«æ·æ“ä½œ)
â”œâ”€â”€ ControlBar (æ§åˆ¶æ )
â”‚   â”œâ”€â”€ SettingsButton (è®¾ç½®æŒ‰é’®)
â”‚   â”œâ”€â”€ HistoryButton (å†å²è®°å½•)
â”‚   â”œâ”€â”€ ShareButton (åˆ†äº«åŠŸèƒ½)
â”‚   â””â”€â”€ HelpButton (å¸®åŠ©ä¸­å¿ƒ)
â””â”€â”€ SafetyPanel (å®‰å…¨é¢æ¿) [æŒ‰éœ€æ˜¾ç¤º]
    â”œâ”€â”€ RiskIndicator (é£é™©æŒ‡ç¤ºå™¨)
    â”œâ”€â”€ EmergencyContacts (ç´§æ€¥è”ç³»)
    â””â”€â”€ ProfessionalResources (ä¸“ä¸šèµ„æº)
```

## æ ¸å¿ƒåŠŸèƒ½è®¾è®¡

### 1. Agenté€‰æ‹©ç³»ç»Ÿ

#### Agentç±»å‹å®šä¹‰

```javascript
const AgentTypes = {
  cbt_specialist: {
    name: 'CBTè®¤çŸ¥ä¸“å®¶',
    avatar: '/assets/agents/cbt-specialist.png',
    description: 'æ“…é•¿è®¤çŸ¥è¡Œä¸ºç–—æ³•ï¼Œå¸®åŠ©ä½ è¯†åˆ«å’Œæ”¹å˜éç†æ€§æ€ç»´æ¨¡å¼',
    specialties: ['è®¤çŸ¥é‡æ„', 'æƒ…ç»ªç®¡ç†', 'è¡Œä¸ºæ¿€æ´»'],
    suitable_for: ['ç„¦è™‘æƒ…ç»ª', 'è´Ÿé¢æ€ç»´', 'è¡Œä¸ºé—®é¢˜']
  },

  emotion_companion: {
    name: 'æƒ…ç»ªé™ªä¼´å¸ˆ',
    avatar: '/assets/agents/emotion-companion.png',
    description: 'æ¸©æš–çš„å€¾å¬è€…ï¼Œæä¾›æƒ…ç»ªæ”¯æŒå’Œå…±æƒ…ç†è§£',
    specialties: ['æƒ…ç»ªæ”¯æŒ', 'å…±æƒ…å€¾å¬', 'å¿ƒç†é™ªä¼´'],
    suitable_for: ['æƒ…ç»ªä½è½', 'å­¤ç‹¬æ„Ÿ', 'éœ€è¦é™ªä¼´']
  },

  stress_counselor: {
    name: 'å‹åŠ›ç®¡ç†é¡¾é—®',
    avatar: '/assets/agents/stress-counselor.png',
    description: 'ä¸“ä¸šçš„å‹åŠ›ç®¡ç†ä¸“å®¶ï¼Œæä¾›å®ç”¨çš„å‡å‹æŠ€å·§',
    specialties: ['å‹åŠ›è¯„ä¼°', 'æ”¾æ¾è®­ç»ƒ', 'æ—¶é—´ç®¡ç†'],
    suitable_for: ['å­¦ä¸šå‹åŠ›', 'å·¥ä½œå‹åŠ›', 'ç”Ÿæ´»å‹åŠ›']
  },

  relationship_guide: {
    name: 'å…³ç³»æŒ‡å¯¼å¸ˆ',
    avatar: '/assets/agents/relationship-guide.png',
    description: 'äººé™…å…³ç³»ä¸“å®¶ï¼Œå¸®åŠ©ä½ æ”¹å–„äººé™…æ²Ÿé€šæŠ€å·§',
    specialties: ['æ²Ÿé€šæŠ€å·§', 'å†²çªè§£å†³', 'å…³ç³»å»ºç«‹'],
    suitable_for: ['äººé™…å›°æ‰°', 'æ²Ÿé€šé—®é¢˜', 'å…³ç³»æ”¹å–„']
  },

  wellness_coach: {
    name: 'å¥åº·ç”Ÿæ´»æ•™ç»ƒ',
    avatar: '/assets/agents/wellness-coach.png',
    description: 'å…¨æ–¹ä½å¥åº·ç”Ÿæ´»æŒ‡å¯¼ï¼Œå…³æ³¨èº«å¿ƒåè°ƒå‘å±•',
    specialties: ['ç”Ÿæ´»ä¹ æƒ¯', 'è¿åŠ¨å»ºè®®', 'è¥å…»æŒ‡å¯¼'],
    suitable_for: ['ç”Ÿæ´»è§„åˆ’', 'å¥åº·å’¨è¯¢', 'ä¹ æƒ¯å…»æˆ']
  }
};
```

#### Agenté€‰æ‹©ç•Œé¢

```html
<!-- Agenté€‰æ‹©é¢æ¿ -->
<view class="agent-selector">
  <view class="selector-header">
    <text class="title">é€‰æ‹©ä½ çš„å¿ƒè¯­ç²¾çµ</text>
    <text class="subtitle">æ¯ä¸ªç²¾çµéƒ½æœ‰ç‹¬ç‰¹çš„ä¸“é•¿ï¼Œæ‰¾åˆ°æœ€é€‚åˆä½ çš„é™ªä¼´</text>
  </view>

  <scroll-view class="agent-list" scroll-x="{{true}}">
    <view class="agent-cards">
      <view
        class="agent-card {{selectedAgent === agent.type ? 'selected' : ''}}"
        wx:for="{{availableAgents}}"
        wx:key="type"
        bindtap="selectAgent"
        data-agent="{{item}}"
      >
        <image class="agent-avatar" src="{{item.avatar}}" />
        <text class="agent-name">{{item.name}}</text>
        <text class="agent-desc">{{item.description}}</text>

        <view class="agent-tags">
          <text
            class="tag"
            wx:for="{{item.specialties}}"
            wx:key="*this"
          >{{item}}</text>
        </view>
      </view>
    </view>
  </scroll-view>

  <view class="selector-actions">
    <button class="btn-primary" bindtap="startConversation">
      å¼€å§‹å¯¹è¯
    </button>
  </view>
</view>
```

### 2. å¯¹è¯æ¶ˆæ¯ç³»ç»Ÿ

#### æ¶ˆæ¯ç±»å‹å®šä¹‰

```javascript
const MessageTypes = {
  USER: 'user',           // ç”¨æˆ·æ¶ˆæ¯
  AGENT: 'agent',         // AIå›å¤æ¶ˆæ¯
  SYSTEM: 'system',       // ç³»ç»Ÿæ¶ˆæ¯
  ANALYSIS: 'analysis',   // åˆ†æç»“æœå¡ç‰‡
  EMERGENCY: 'emergency'  // ç´§æ€¥æç¤ºæ¶ˆæ¯
};

const MessageStatus = {
  SENDING: 'sending',     // å‘é€ä¸­
  SENT: 'sent',           // å·²å‘é€
  DELIVERED: 'delivered', // å·²é€è¾¾
  READ: 'read',           // å·²è¯»
  FAILED: 'failed'        // å‘é€å¤±è´¥
};
```

#### æ¶ˆæ¯åˆ—è¡¨ç»„ä»¶

```html
<!-- æ¶ˆæ¯åˆ—è¡¨ -->
<scroll-view
  class="message-list"
  scroll-y="{{true}}"
  scroll-into-view="{{scrollToMessage}}"
  bindscrolltolower="loadMoreMessages"
>
  <view class="message-container">
    <!-- ç³»ç»Ÿæ¬¢è¿æ¶ˆæ¯ -->
    <view class="message system-message" wx:if="{{showWelcome}}">
      <view class="message-content">
        <text class="welcome-text">
          æ¬¢è¿æ¥åˆ°å¿ƒè¯­ç²¾çµï¼æˆ‘æ˜¯{{selectedAgent.name}}ï¼Œ{{selectedAgent.description}}
        </text>
      </view>
    </view>

    <!-- æ¶ˆæ¯å¾ªç¯ -->
    <view
      class="message {{item.type}}-message {{item.status}}"
      wx:for="{{messageList}}"
      wx:key="id"
      id="message-{{item.id}}"
    >
      <!-- ç”¨æˆ·æ¶ˆæ¯ -->
      <view class="user-message" wx:if="{{item.type === 'user'}}">
        <view class="message-content">
          <text class="message-text">{{item.content}}</text>
          <view class="message-time">{{item.time}}</view>
        </view>
        <image class="user-avatar" src="{{userInfo.avatar}}" />
      </view>

      <!-- AIå›å¤æ¶ˆæ¯ -->
      <view class="agent-message" wx:if="{{item.type === 'agent'}}">
        <image class="agent-avatar" src="{{selectedAgent.avatar}}" />
        <view class="message-content">
          <text class="message-text">{{item.content}}</text>
          <view class="message-actions">
            <button class="btn-text" bindtap="likeMessage" data-id="{{item.id}}">
              ğŸ‘ æœ‰å¸®åŠ©
            </button>
            <button class="btn-text" bindtap="regenerateResponse" data-id="{{item.id}}">
              ğŸ”„ é‡æ–°ç”Ÿæˆ
            </button>
          </view>
          <view class="message-time">{{item.time}}</view>
        </view>
      </view>

      <!-- åˆ†æç»“æœå¡ç‰‡ -->
      <view class="analysis-card" wx:if="{{item.type === 'analysis'}}">
        <AnalysisCard
          analysis-data="{{item.analysisData}}"
          on-expand="onAnalysisCardExpand"
        />
      </view>

      <!-- ç³»ç»Ÿæ¶ˆæ¯ -->
      <view class="system-message" wx:if="{{item.type === 'system'}}">
        <view class="message-content">
          <text class="system-text">{{item.content}}</text>
        </view>
      </view>

      <!-- ç´§æ€¥æç¤º -->
      <view class="emergency-message" wx:if="{{item.type === 'emergency'}}">
        <view class="emergency-content">
          <view class="emergency-icon">âš ï¸</view>
          <text class="emergency-text">{{item.content}}</text>
          <view class="emergency-actions">
            <button class="btn-emergency" bindtap="handleEmergency">
              ç«‹å³å¯»æ±‚å¸®åŠ©
            </button>
          </view>
        </view>
      </view>
    </view>

    <!-- è¾“å…¥çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <view class="typing-indicator" wx:if="{{isAgentTyping}}">
      <image class="agent-avatar" src="{{selectedAgent.avatar}}" />
      <view class="typing-dots">
        <view class="dot"></view>
        <view class="dot"></view>
        <view class="dot"></view>
      </view>
    </view>
  </view>
</scroll-view>
```

### 3. AIåˆ†æç»“æœå±•ç¤º

#### åˆ†æç»“æœå¡ç‰‡ç»„ä»¶

```html
<!-- åˆ†æç»“æœå¡ç‰‡ -->
<view class="analysis-card {{isExpanded ? 'expanded' : 'collapsed'}}">
  <!-- å¡ç‰‡å¤´éƒ¨ -->
  <view class="card-header" bindtap="toggleCard">
    <view class="analysis-icon">
      <image
        class="icon"
        src="/assets/icons/analysis-{{analysisData.type}}.png"
      />
    </view>
    <view class="analysis-title">
      <text class="title">{{getAnalysisTitle(analysisData.type)}}</text>
      <text class="subtitle">{{getAnalysisSubtitle(analysisData.type)}}</text>
    </view>
    <view class="expand-icon">
      <text class="icon">{{isExpanded ? 'â–²' : 'â–¼'}}</text>
    </view>
  </view>

  <!-- å¡ç‰‡å†…å®¹ -->
  <view class="card-content" wx:if="{{isExpanded}}">
    <!-- æƒ…æ„Ÿåˆ†æç»“æœ -->
    <view class="emotion-analysis" wx:if="{{analysisData.type === 'emotion'}}">
      <view class="emotion-summary">
        <view class="primary-emotion">
          <text class="emotion-emoji">{{getEmotionEmoji(analysisData.primary_emotion)}}</text>
          <text class="emotion-text">{{analysisData.primary_emotion}}</text>
          <text class="emotion-intensity">{{analysisData.intensity * 100}}%</text>
        </view>

        <view class="secondary-emotions" wx:if="{{analysisData.secondary_emotions.length > 0}}">
          <text class="label">å…¶ä»–æƒ…ç»ªï¼š</text>
          <view class="emotion-tags">
            <text
              class="emotion-tag"
              wx:for="{{analysisData.secondary_emotions}}"
              wx:key="*this"
            >{{item}}</text>
          </view>
        </view>
      </view>

      <!-- æƒ…ç»ªé›·è¾¾å›¾ -->
      <view class="radar-chart-container">
        <canvas
          class="emotion-radar"
          canvas-id="emotionRadar{{cardId}}"
          bind:tap="showRadarDetail"
        />
      </view>

      <!-- æƒ…ç»ªå»ºè®® -->
      <view class="emotion-suggestions">
        <text class="suggestions-title">ğŸ’¡ æƒ…ç»ªå»ºè®®</text>
        <view class="suggestions-list">
          <text
            class="suggestion-item"
            wx:for="{{getEmotionSuggestions(analysisData)}}"
            wx:key="*this"
          >â€¢ {{item}}</text>
        </view>
      </view>
    </view>

    <!-- æ–‡åŒ–æ´å¯Ÿç»“æœ -->
    <view class="culture-analysis" wx:if="{{analysisData.type === 'culture'}}">
      <view class="culture-keywords">
        <text class="keywords-title">ğŸ® æ–‡åŒ–å…³é”®è¯</text>
        <view class="keywords-list">
          <text
            class="keyword-item"
            wx:for="{{analysisData.topic_keywords}}"
            wx:key="*this"
          >{{item}}</text>
        </view>
      </view>

      <view class="culture-triggers">
        <text class="triggers-title">ğŸ’­ æƒ…ç»ªè§¦å‘ç‚¹</text>
        <view class="triggers-list">
          <text
            class="trigger-item"
            wx:for="{{analysisData.emotion_triggers}}"
            wx:key="*this"
          >{{item}}</text>
        </view>
      </view>

      <view class="culture-context">
        <text class="context-title">ğŸ“– æ–‡åŒ–èƒŒæ™¯è§£è¯»</text>
        <text class="context-text">{{analysisData.cultural_context_notes}}</text>
      </view>

      <view class="culture-advice">
        <text class="advice-title">ğŸ¯ ä¸ªæ€§åŒ–å»ºè®®</text>
        <view class="advice-list">
          <text
            class="advice-item"
            wx:for="{{getCulturalSuggestions(analysisData)}}"
            wx:key="*this"
          >â€¢ {{item}}</text>
        </view>
      </view>
    </view>

    <!-- é£é™©è¯„ä¼°ç»“æœ -->
    <view class="risk-analysis" wx:if="{{analysisData.type === 'risk'}}">
      <view class="risk-level {{getRiskLevelClass(analysisData.risk_level)}}">
        <view class="risk-icon">{{getRiskIcon(analysisData.risk_level)}}</view>
        <view class="risk-info">
          <text class="risk-title">{{getRiskTitle(analysisData.risk_level)}}</text>
          <text class="risk-description">{{getRiskDescription(analysisData.risk_level)}}</text>
        </view>
      </view>

      <view class="risk-summary" wx:if="{{analysisData.summary}}">
        <text class="summary-title">ğŸ“‹ é£é™©è¯„ä¼°æ‘˜è¦</text>
        <text class="summary-text">{{analysisData.summary}}</text>
      </view>

      <!-- é«˜é£é™©æ—¶æ˜¾ç¤ºç´§æ€¥èµ„æº -->
      <view class="emergency-resources" wx:if="{{analysisData.risk_level >= 3}}">
        <text class="resources-title">ğŸš¨ ç´§æ€¥æ”¯æŒèµ„æº</text>
        <view class="resources-list">
          <view
            class="resource-item"
            wx:for="{{getEmergencyResources()}}"
            wx:key="name"
            bindtap="contactResource"
            data-resource="{{item}}"
          >
            <text class="resource-name">{{item.name}}</text>
            <text class="resource-contact">{{item.contact}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>
```

#### æƒ…ç»ªé›·è¾¾å›¾å®ç°

```javascript
// emotion-radar.js
Component({
  properties: {
    analysisData: {
      type: Object,
      value: {}
    }
  },

  data: {
    radarData: null,
    animationProgress: 0
  },

  lifetimes: {
    attached() {
      this.initRadarChart();
    }
  },

  methods: {
    initRadarChart() {
      const { radar_dimensions } = this.properties.analysisData;

      if (!radar_dimensions) return;

      // è½¬æ¢æ•°æ®æ ¼å¼
      this.radarData = {
        trust: radar_dimensions.trust * 100,
        openness: radar_dimensions.openness * 100,
        resistance: radar_dimensions.resistance * 100,
        stress: radar_dimensions.stress * 100,
        control: radar_dimensions.control * 100
      };

      // å¯åŠ¨åŠ¨ç”»
      this.animateRadar();
    },

    animateRadar() {
      const animationDuration = 1000; // 1ç§’åŠ¨ç”»
      const startTime = Date.now();

      const animate = () => {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / animationDuration, 1);

        // ä½¿ç”¨ç¼“åŠ¨å‡½æ•°
        const easeProgress = this.easeInOutCubic(progress);
        this.setData({ animationProgress: easeProgress });

        if (progress < 1) {
          this.animationFrameId = requestAnimationFrame(animate);
        } else {
          this.drawRadarChart();
        }
      };

      animate();
    },

    drawRadarChart() {
      const ctx = wx.createCanvasContext('emotionRadar');
      const centerX = 100;
      const centerY = 100;
      const radius = 80;

      // ç»˜åˆ¶ç½‘æ ¼
      this.drawGrid(ctx, centerX, centerY, radius);

      // ç»˜åˆ¶æ•°æ®
      this.drawData(ctx, centerX, centerY, radius, this.radarData);

      ctx.draw();
    },

    drawGrid(ctx, centerX, centerY, radius) {
      const levels = 5;
      const dimensions = 5;

      // ç»˜åˆ¶åŒå¿ƒåœ†
      for (let i = 1; i <= levels; i++) {
        const levelRadius = (radius / levels) * i;

        ctx.beginPath();
        for (let j = 0; j <= dimensions; j++) {
          const angle = (Math.PI * 2 / dimensions) * j - Math.PI / 2;
          const x = centerX + Math.cos(angle) * levelRadius;
          const y = centerY + Math.sin(angle) * levelRadius;

          if (j === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
        }
        ctx.closePath();
        ctx.setStrokeStyle('rgba(200, 200, 200, 0.3)');
        ctx.stroke();
      }

      // ç»˜åˆ¶è½´çº¿
      for (let i = 0; i < dimensions; i++) {
        const angle = (Math.PI * 2 / dimensions) * i - Math.PI / 2;
        const x = centerX + Math.cos(angle) * radius;
        const y = centerY + Math.sin(angle) * radius;

        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.lineTo(x, y);
        ctx.setStrokeStyle('rgba(150, 150, 150, 0.5)');
        ctx.stroke();
      }
    },

    drawData(ctx, centerX, centerY, radius, data) {
      const dimensions = Object.keys(data);
      const angleStep = (Math.PI * 2) / dimensions;

      // ç»˜åˆ¶æ•°æ®å¤šè¾¹å½¢
      ctx.beginPath();
      dimensions.forEach((dimension, index) => {
        const angle = angleStep * index - Math.PI / 2;
        const value = data[dimension] / 100; // å½’ä¸€åŒ–åˆ°0-1
        const distance = value * radius * this.data.animationProgress;
        const x = centerX + Math.cos(angle) * distance;
        const y = centerY + Math.sin(angle) * distance;

        if (index === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      });
      ctx.closePath();

      // å¡«å……å’Œæè¾¹
      ctx.setFillStyle('rgba(74, 144, 226, 0.3)');
      ctx.fill();
      ctx.setStrokeStyle('#4a90e2');
      ctx.stroke();

      // ç»˜åˆ¶æ•°æ®ç‚¹
      dimensions.forEach((dimension, index) => {
        const angle = angleStep * index - Math.PI / 2;
        const value = data[dimension] / 100;
        const distance = value * radius * this.data.animationProgress;
        const x = centerX + Math.cos(angle) * distance;
        const y = centerY + Math.sin(angle) * distance;

        ctx.beginPath();
        ctx.arc(x, y, 4, 0, Math.PI * 2);
        ctx.setFillStyle('#4a90e2');
        ctx.fill();
        ctx.setStrokeStyle('white');
        ctx.stroke();
      });
    },

    easeInOutCubic(t) {
      return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
    },

    showRadarDetail() {
      this.triggerEvent('showDetail', {
        radarData: this.radarData
      });
    }
  }
});
```

### 4. è¾“å…¥ç³»ç»Ÿè®¾è®¡

#### å¤šæ¨¡æ€è¾“å…¥ç»„ä»¶

```html
<!-- è¾“å…¥åŒºåŸŸ -->
<view class="input-area">
  <!-- å¿«æ·æƒ…ç»ªé€‰æ‹© -->
  <view class="emotion-picker" wx:if="{{showEmotionPicker}}">
    <scroll-view class="emotion-list" scroll-x="{{true}}">
      <view class="emotion-items">
        <view
          class="emotion-item {{selectedEmotion === item.type ? 'selected' : ''}}"
          wx:for="{{emotionOptions}}"
          wx:key="type"
          bindtap="selectEmotion"
          data-emotion="{{item}}"
        >
          <text class="emotion-emoji">{{item.emoji}}</text>
          <text class="emotion-label">{{item.label}}</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- ä¸»è¾“å…¥æ¡† -->
  <view class="input-container">
    <!-- è¯­éŸ³è¾“å…¥æŒ‰é’® -->
    <button
      class="voice-btn {{isRecording ? 'recording' : ''}}"
      bindtouchstart="startRecording"
      bindtouchend="stopRecording"
      wx:if="{{!inputText}}"
    >
      <text class="voice-icon">ğŸ¤</text>
    </button>

    <!-- æ–‡æœ¬è¾“å…¥æ¡† -->
    <input
      class="text-input"
      type="text"
      placeholder="åˆ†äº«ä½ çš„æƒ³æ³•..."
      value="{{inputText}}"
      bindinput="onInputChange"
      bindconfirm="sendMessage"
      focus="{{inputFocused}}"
      maxlength="500"
    />

    <!-- è¡¨æƒ…æŒ‰é’® -->
    <button
      class="emoji-btn"
      bindtap="toggleEmotionPicker"
      wx:if="{{!inputText}}"
    >
      <text class="emoji-icon">ğŸ˜Š</text>
    </button>

    <!-- å‘é€æŒ‰é’® -->
    <button
      class="send-btn {{inputText ? 'active' : ''}}"
      bindtap="sendMessage"
      disabled="{{!inputText}}"
    >
      <text class="send-icon">â¤</text>
    </button>
  </view>

  <!-- å¿«æ·æ“ä½œæ  -->
  <view class="quick-actions">
    <button
      class="quick-action"
      wx:for="{{quickActions}}"
      wx:key="type"
      bindtap="sendQuickAction"
      data-action="{{item}}"
    >
      <text class="action-icon">{{item.icon}}</text>
      <text class="action-label">{{item.label}}</text>
    </button>
  </view>
</view>
```

#### è¾“å…¥å¤„ç†é€»è¾‘

```javascript
// input-handler.js
Page({
  data: {
    inputText: '',
    isRecording: false,
    showEmotionPicker: false,
    selectedEmotion: null,
    emotionOptions: [
      { type: 'happy', emoji: 'ğŸ˜Š', label: 'å¼€å¿ƒ' },
      { type: 'sad', emoji: 'ğŸ˜¢', label: 'éš¾è¿‡' },
      { type: 'angry', emoji: 'ğŸ˜ ', label: 'ç”Ÿæ°”' },
      { type: 'anxious', emoji: 'ğŸ˜°', label: 'ç„¦è™‘' },
      { type: 'confused', emoji: 'ğŸ˜•', label: 'å›°æƒ‘' },
      { type: 'calm', emoji: 'ğŸ˜Œ', label: 'å¹³é™' }
    ],
    quickActions: [
      { type: 'mood_report', icon: 'ğŸ“Š', label: 'å¿ƒæƒ…æŠ¥å‘Š' },
      { type: 'breathing', icon: 'ğŸ«', label: 'å‘¼å¸ç»ƒä¹ ' },
      { type: 'gratitude', icon: 'ğŸ™', label: 'æ„Ÿæ©æ—¥è®°' },
      { type: 'goal_setting', icon: 'ğŸ¯', label: 'ç›®æ ‡è®¾å®š' }
    ]
  },

  // æ–‡æœ¬è¾“å…¥å¤„ç†
  onInputChange(e) {
    this.setData({
      inputText: e.detail.value
    });
  },

  // å‘é€æ¶ˆæ¯
  async sendMessage() {
    const { inputText, selectedEmotion } = this.data;

    if (!inputText.trim()) return;

    // æ„å»ºæ¶ˆæ¯å†…å®¹
    const messageContent = this.buildMessageContent(inputText, selectedEmotion);

    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°åˆ—è¡¨
    this.addUserMessage(messageContent);

    // æ¸…ç©ºè¾“å…¥
    this.setData({
      inputText: '',
      selectedEmotion: null,
      showEmotionPicker: false
    });

    // å‘é€åˆ°AIå¤„ç†
    await this.processMessage(messageContent);
  },

  // æ„å»ºæ¶ˆæ¯å†…å®¹
  buildMessageContent(text, emotion) {
    let content = text;

    if (emotion) {
      content = `[${emotion.label}] ${content}`;
    }

    return content;
  },

  // å¤„ç†æ¶ˆæ¯ï¼ˆè°ƒç”¨äº‘å‡½æ•°ï¼‰
  async processMessage(content) {
    try {
      // æ˜¾ç¤ºAIæ­£åœ¨è¾“å…¥
      this.setData({ isAgentTyping: true });

      // è°ƒç”¨äº‘å‡½æ•°
      const result = await wx.cloud.callFunction({
        name: 'askMessageManager',
        data: {
          action: 'sendMessage',
          message: content,
          sessionId: this.data.currentSessionId,
          agentType: this.data.selectedAgent.type
        }
      });

      const { response, analysis } = result.result;

      // æ·»åŠ AIå›å¤æ¶ˆæ¯
      this.addAgentMessage(response);

      // æ·»åŠ åˆ†æç»“æœå¡ç‰‡
      if (analysis && analysis.length > 0) {
        this.addAnalysisCards(analysis);
      }

    } catch (error) {
      console.error('æ¶ˆæ¯å¤„ç†å¤±è´¥:', error);
      this.addSystemMessage('æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æ— æ³•å›å¤ã€‚è¯·ç¨åå†è¯•ã€‚');
    } finally {
      this.setData({ isAgentTyping: false });
    }
  },

  // è¯­éŸ³è¾“å…¥å¤„ç†
  startRecording(e) {
    if (!this.checkRecordPermission()) {
      return;
    }

    this.setData({ isRecording: true });

    // å¼€å§‹å½•éŸ³
    wx.startRecord({
      success: (res) => {
        console.log('å½•éŸ³å¼€å§‹');
      },
      fail: (err) => {
        console.error('å½•éŸ³å¤±è´¥:', err);
        this.setData({ isRecording: false });
      }
    });
  },

  stopRecording() {
    if (!this.data.isRecording) return;

    wx.stopRecord({
      success: (res) => {
        const tempFilePath = res.tempFilePath;
        this.processVoiceMessage(tempFilePath);
      },
      fail: (err) => {
        console.error('å½•éŸ³ç»“æŸå¤±è´¥:', err);
      }
    });

    this.setData({ isRecording: false });
  },

  // å¤„ç†è¯­éŸ³æ¶ˆæ¯
  async processVoiceMessage(filePath) {
    try {
      // è¯­éŸ³è½¬æ–‡å­—
      const transcription = await this.transcribeVoice(filePath);

      if (transcription) {
        this.setData({ inputText: transcription });
        // è‡ªåŠ¨å‘é€è¯­éŸ³è½¬æ–‡å­—çš„ç»“æœ
        await this.sendMessage();
      }
    } catch (error) {
      console.error('è¯­éŸ³å¤„ç†å¤±è´¥:', error);
      this.addSystemMessage('è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•æˆ–ä½¿ç”¨æ–‡å­—è¾“å…¥ã€‚');
    }
  },

  // è¯­éŸ³è½¬æ–‡å­—
  transcribeVoice(filePath) {
    return new Promise((resolve, reject) => {
      wx.cloud.callFunction({
        name: 'askMessageManager',
        data: {
          action: 'transcribeVoice',
          filePath: filePath
        },
        success: (res) => {
          resolve(res.result.text);
        },
        fail: (err) => {
          reject(err);
        }
      });
    });
  },

  // æƒ…ç»ªé€‰æ‹©å¤„ç†
  selectEmotion(e) {
    const emotion = e.currentTarget.dataset.emotion;
    this.setData({
      selectedEmotion: emotion,
      showEmotionPicker: false
    });
  },

  // å¿«æ·æ“ä½œå¤„ç†
  sendQuickAction(e) {
    const action = e.currentTarget.dataset.action;

    const quickMessages = {
      mood_report: 'æˆ‘æƒ³äº†è§£ä¸€ä¸‹æˆ‘çš„æƒ…ç»ªçŠ¶æ€',
      breathing: 'æˆ‘ç°åœ¨å‹åŠ›å¾ˆå¤§ï¼Œæƒ³åšä¸€äº›å‘¼å¸ç»ƒä¹ ',
      gratitude: 'ä»Šå¤©æœ‰ä»€ä¹ˆå€¼å¾—æ„Ÿæ©çš„äº‹æƒ…å—ï¼Ÿ',
      goal_setting: 'å¸®æˆ‘è®¾å®šä¸€ä¸ªå°ç›®æ ‡'
    };

    const message = quickMessages[action.type];
    if (message) {
      this.setData({ inputText: message });
      this.sendMessage();
    }
  }
});
```

### 5. å®‰å…¨ç›‘æ§ç³»ç»Ÿ

#### é£é™©ç›‘æ§ç»„ä»¶

```html
<!-- å®‰å…¨ç›‘æ§é¢æ¿ -->
<view class="safety-panel {{riskLevel > 0 ? 'visible' : 'hidden'}}">
  <!-- é£é™©æŒ‡ç¤ºå™¨ -->
  <view class="risk-indicator level-{{riskLevel}}">
    <view class="risk-icon">{{getRiskIcon(riskLevel)}}</view>
    <view class="risk-info">
      <text class="risk-title">{{getRiskTitle(riskLevel)}}</text>
      <text class="risk-description">{{getRiskDescription(riskLevel)}}</text>
    </view>
  </view>

  <!-- ç´§æ€¥æ“ä½œï¼ˆé«˜é£é™©æ—¶æ˜¾ç¤ºï¼‰ -->
  <view class="emergency-actions" wx:if="{{riskLevel >= 3}}">
    <button
      class="emergency-contact"
      bindtap="contactEmergencyService"
    >
      ğŸ“ è”ç³»å¿ƒç†çƒ­çº¿
    </button>
    <button
      class="emergency-location"
      bindtap="shareLocation"
    >
      ğŸ“ åˆ†äº«ä½ç½®
    </button>
    <button
      class="emergency-contact-person"
      bindtap="contactEmergencyPerson"
    >
      ğŸ‘¥ è”ç³»ç´§æ€¥è”ç³»äºº
    </button>
  </view>

  <!-- å®‰æŠšèµ„æºï¼ˆä½ä¸­é£é™©æ—¶æ˜¾ç¤ºï¼‰ -->
  <view class="calming-resources" wx:if="{{riskLevel < 3}}">
    <button
      class="calming-action"
      bindtap="startBreathingExercise"
    >
      ğŸ« å‘¼å¸ç»ƒä¹ 
    </button>
    <button
      class="calming-action"
      bindtap="playCalmingMusic"
    >
      ğŸµ æ”¾æ¾éŸ³ä¹
    </button>
    <button
      class="calming-action"
      bindtap="showPositiveThoughts"
    >
      ğŸ’­ ç§¯ææ€è€ƒ
    </button>
  </view>
</view>
```

#### å®‰å…¨ç›‘æ§é€»è¾‘

```javascript
// safety-monitor.js
const SafetyMonitor = {
  // é£é™©ç­‰çº§è¯„ä¼°
  assessRiskLevel(analysisResults) {
    let maxRiskLevel = 0;
    let riskFactors = [];

    analysisResults.forEach(analysis => {
      if (analysis.type === 'risk') {
        maxRiskLevel = Math.max(maxRiskLevel, analysis.risk_level);

        if (analysis.risk_level >= 2) {
          riskFactors.push({
            type: 'risk_assessment',
            level: analysis.risk_level,
            details: analysis.summary
          });
        }
      }
    });

    return {
      level: maxRiskLevel,
      factors: riskFactors,
      requiresIntervention: maxRiskLevel >= 3
    };
  },

  // è§¦å‘å®‰å…¨å“åº”
  triggerSafetyResponse(riskAssessment) {
    const { level, factors, requiresIntervention } = riskAssessment;

    switch (level) {
      case 0:
        // æ— é£é™©ï¼Œæ­£å¸¸ç›‘æ§
        this.startNormalMonitoring();
        break;

      case 1:
        // è½»åº¦é£é™©ï¼Œå¢åŠ å…³æ³¨
        this.startEnhancedMonitoring();
        break;

      case 2:
        // ä¸­åº¦é£é™©ï¼Œä¸»åŠ¨å¹²é¢„
        this.startProactiveIntervention();
        break;

      case 3:
        // é«˜åº¦é£é™©ï¼Œç´§æ€¥å¹²é¢„
        this.startEmergencyIntervention();
        break;

      case 4:
        // ç´§æ€¥å±æœºï¼Œç«‹å³å“åº”
        this.triggerCrisisResponse();
        break;
    }
  },

  // ç´§æ€¥å¹²é¢„æµç¨‹
  startEmergencyIntervention() {
    // æ˜¾ç¤ºç´§æ€¥èµ„æºé¢æ¿
    this.showEmergencyPanel();

    // è®°å½•å®‰å…¨äº‹ä»¶
    this.logSafetyEvent({
      level: 3,
      timestamp: new Date().toISOString(),
      actions: ['show_emergency_resources', 'increase_monitoring']
    });

    // é€šçŸ¥å®‰å…¨å›¢é˜Ÿï¼ˆå¦‚æœæ˜¯ç”Ÿäº§ç¯å¢ƒï¼‰
    if (this.isProduction()) {
      this.notifySafetyTeam();
    }
  },

  // å±æœºå“åº”æµç¨‹
  triggerCrisisResponse() {
    // ç«‹å³è”ç³»ç´§æ€¥æœåŠ¡
    this.contactEmergencyServices();

    // é€šçŸ¥ç´§æ€¥è”ç³»äºº
    this.notifyEmergencyContacts();

    // ä¿æŒç”¨æˆ·åœ¨çº¿
    this.keepUserOnline();

    // è®°å½•å±æœºäº‹ä»¶
    this.logCrisisEvent({
      level: 4,
      timestamp: new Date().toISOString(),
      actions: ['contact_emergency_services', 'notify_contacts', 'keep_online']
    });
  },

  // è”ç³»ç´§æ€¥æœåŠ¡
  async contactEmergencyServices() {
    const emergencyNumbers = [
      { name: 'å¿ƒç†æ´åŠ©çƒ­çº¿', phone: '400-161-9995' },
      { name: 'å±æœºå¹²é¢„ä¸­å¿ƒ', phone: '010-82951332' }
    ];

    for (const service of emergencyNumbers) {
      try {
        await wx.makePhoneCall({
          phoneNumber: service.phone
        });
        break; // æˆåŠŸæ‹¨æ‰“ç”µè¯åé€€å‡ºå¾ªç¯
      } catch (error) {
        console.error(`æ‹¨æ‰“${service.name}å¤±è´¥:`, error);
      }
    }
  },

  // åˆ†äº«ä½ç½®ä¿¡æ¯
  async shareLocation() {
    try {
      const location = await this.getCurrentLocation();

      // å‘é€ä½ç½®ç»™ç´§æ€¥è”ç³»äºº
      await this.sendLocationToContacts(location);

      // æ˜¾ç¤ºä½ç½®ä¿¡æ¯ç»™ç”¨æˆ·
      this.showLocationInfo(location);

    } catch (error) {
      console.error('è·å–ä½ç½®å¤±è´¥:', error);
      wx.showToast({
        title: 'ä½ç½®è·å–å¤±è´¥',
        icon: 'none'
      });
    }
  },

  // è·å–å½“å‰ä½ç½®
  getCurrentLocation() {
    return new Promise((resolve, reject) => {
      wx.getLocation({
        type: 'gcj02',
        success: (res) => {
          resolve({
            latitude: res.latitude,
            longitude: res.longitude,
            accuracy: res.accuracy,
            timestamp: new Date().toISOString()
          });
        },
        fail: reject
      });
    });
  }
};
```

## æ ·å¼è®¾è®¡

### ä¸»è¦æ ·å¼è§„èŒƒ

```scss
// å¿ƒè¯­ç²¾çµå¯¹è¯ç•Œé¢æ ·å¼
.heartchat-page {
  height: 100vh;
  display: flex;
  flex-direction: column;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);

  // Agenté€‰æ‹©é¢æ¿
  .agent-selector {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 16px;
    margin: 16px;
    padding: 20px;

    .selector-header {
      text-align: center;
      margin-bottom: 20px;

      .title {
        font-size: 18px;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 8px;
      }

      .subtitle {
        font-size: 14px;
        color: #7f8c8d;
        line-height: 1.4;
      }
    }

    .agent-cards {
      display: flex;
      gap: 16px;
      padding: 0 8px;

      .agent-card {
        min-width: 120px;
        padding: 16px;
        border-radius: 12px;
        background: white;
        border: 2px solid transparent;
        transition: all 0.3s ease;

        &.selected {
          border-color: #4a90e2;
          background: #f0f8ff;
        }

        .agent-avatar {
          width: 48px;
          height: 48px;
          border-radius: 50%;
          margin: 0 auto 12px;
        }

        .agent-name {
          font-size: 14px;
          font-weight: 600;
          color: #2c3e50;
          text-align: center;
          display: block;
          margin-bottom: 8px;
        }

        .agent-desc {
          font-size: 12px;
          color: #7f8c8d;
          line-height: 1.3;
          text-align: center;
          display: block;
          margin-bottom: 12px;
        }

        .agent-tags {
          display: flex;
          flex-wrap: wrap;
          gap: 4px;

          .tag {
            font-size: 10px;
            padding: 2px 6px;
            background: #e8f4fd;
            color: #4a90e2;
            border-radius: 4px;
          }
        }
      }
    }
  }

  // æ¶ˆæ¯åˆ—è¡¨
  .message-list {
    flex: 1;
    padding: 0 16px;

    .message {
      margin-bottom: 16px;

      &.user-message {
        display: flex;
        justify-content: flex-end;

        .message-content {
          max-width: 70%;
          background: white;
          border-radius: 16px 16px 4px 16px;
          padding: 12px 16px;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);

          .message-text {
            font-size: 15px;
            color: #2c3e50;
            line-height: 1.4;
          }

          .message-time {
            font-size: 11px;
            color: #bdc3c7;
            margin-top: 4px;
            text-align: right;
          }
        }

        .user-avatar {
          width: 32px;
          height: 32px;
          border-radius: 50%;
          margin-left: 8px;
        }
      }

      &.agent-message {
        display: flex;
        justify-content: flex-start;

        .agent-avatar {
          width: 32px;
          height: 32px;
          border-radius: 50%;
          margin-right: 8px;
        }

        .message-content {
          max-width: 70%;
          background: #f8f9fa;
          border-radius: 16px 16px 16px 4px;
          padding: 12px 16px;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);

          .message-text {
            font-size: 15px;
            color: #2c3e50;
            line-height: 1.4;
          }

          .message-actions {
            margin-top: 8px;
            display: flex;
            gap: 12px;

            .btn-text {
              font-size: 12px;
              color: #4a90e2;
              background: transparent;
              border: none;
              padding: 0;

              &:active {
                opacity: 0.6;
              }
            }
          }

          .message-time {
            font-size: 11px;
            color: #bdc3c7;
            margin-top: 8px;
          }
        }
      }

      &.analysis-card {
        margin: 20px 0;
      }
    }

    // è¾“å…¥çŠ¶æ€æŒ‡ç¤ºå™¨
    .typing-indicator {
      display: flex;
      align-items: center;
      margin-bottom: 16px;

      .agent-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .typing-dots {
        background: #f8f9fa;
        border-radius: 16px;
        padding: 12px 16px;
        display: flex;
        gap: 4px;

        .dot {
          width: 6px;
          height: 6px;
          border-radius: 50%;
          background: #bdc3c7;
          animation: typing 1.4s infinite;

          &:nth-child(2) {
            animation-delay: 0.2s;
          }

          &:nth-child(3) {
            animation-delay: 0.4s;
          }
        }
      }
    }
  }

  // è¾“å…¥åŒºåŸŸ
  .input-area {
    background: white;
    border-radius: 20px 20px 0 0;
    padding: 16px;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);

    .emotion-picker {
      margin-bottom: 12px;

      .emotion-items {
        display: flex;
        gap: 12px;

        .emotion-item {
          display: flex;
          flex-direction: column;
          align-items: center;
          padding: 8px;
          border-radius: 8px;
          background: #f8f9fa;
          transition: all 0.2s ease;

          &.selected {
            background: #e8f4fd;
            border: 1px solid #4a90e2;
          }

          .emotion-emoji {
            font-size: 20px;
            margin-bottom: 4px;
          }

          .emotion-label {
            font-size: 10px;
            color: #7f8c8d;
          }
        }
      }
    }

    .input-container {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #f8f9fa;
      border-radius: 25px;
      padding: 8px 16px;

      .voice-btn, .emoji-btn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: transparent;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;

        &.recording {
          background: #e74c3c;
          animation: pulse 1s infinite;
        }
      }

      .text-input {
        flex: 1;
        background: transparent;
        border: none;
        font-size: 15px;
        color: #2c3e50;
        padding: 8px 0;
      }

      .send-btn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #4a90e2;
        border: none;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;

        &:not(.active) {
          background: #bdc3c7;
        }
      }
    }

    .quick-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;

      .quick-action {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 8px;
        border: none;

        .action-icon {
          font-size: 16px;
          margin-bottom: 4px;
        }

        .action-label {
          font-size: 10px;
          color: #7f8c8d;
        }
      }
    }
  }

  // å®‰å…¨é¢æ¿
  .safety-panel {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    z-index: 1000;
    min-width: 300px;

    .risk-indicator {
      display: flex;
      align-items: center;
      margin-bottom: 16px;

      .risk-icon {
        font-size: 24px;
        margin-right: 12px;
      }

      .risk-info {
        .risk-title {
          font-size: 16px;
          font-weight: 600;
          color: #2c3e50;
          margin-bottom: 4px;
        }

        .risk-description {
          font-size: 14px;
          color: #7f8c8d;
        }
      }
    }

    .emergency-actions, .calming-resources {
      display: flex;
      flex-direction: column;
      gap: 8px;

      button {
        padding: 12px 16px;
        border-radius: 8px;
        border: none;
        font-size: 14px;
        transition: all 0.2s ease;

        &:active {
          opacity: 0.8;
        }
      }
    }

    .emergency-actions {
      button {
        background: #e74c3c;
        color: white;
      }
    }

    .calming-resources {
      button {
        background: #3498db;
        color: white;
      }
    }
  }
}

// åŠ¨ç”»å®šä¹‰
@keyframes typing {
  0%, 60%, 100% {
    opacity: 0.3;
  }
  30% {
    opacity: 1;
  }
}

@keyframes pulse {
  0% {
    box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7);
  }
  70% {
    box-shadow: 0 0 0 10px rgba(231, 76, 60, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(231, 76, 60, 0);
  }
}
```

## æ•°æ®æµè®¾è®¡

### é¡µé¢æ•°æ®ç»“æ„

```javascript
// é¡µé¢æ•°æ®ç»“æ„
const pageData = {
  // Agentç›¸å…³
  selectedAgent: null,
  availableAgents: [],
  agentHistory: [],

  // ä¼šè¯ç›¸å…³
  currentSessionId: null,
  messageList: [],
  isLoading: false,
  isAgentTyping: false,

  // è¾“å…¥ç›¸å…³
  inputText: '',
  selectedEmotion: null,
  showEmotionPicker: false,
  isRecording: false,

  // åˆ†æç»“æœ
  analysisResults: [],
  currentRiskLevel: 0,
  safetyPanelVisible: false,

  // ç”¨æˆ·ä¿¡æ¯
  userInfo: {
    avatar: '',
    nickname: ''
  },

  // é…ç½®
  scrollToMessage: '',
  showWelcome: true,

  // ç¼“å­˜
  messageCache: new Map(),
  analysisCache: new Map()
};
```

### æ¶ˆæ¯æ•°æ®ç»“æ„

```javascript
// æ¶ˆæ¯æ•°æ®ç»“æ„
const messageStructure = {
  id: 'unique_message_id',
  type: 'user|agent|system|analysis|emergency',
  content: 'message_content',
  timestamp: '2025-10-08T15:30:00Z',
  status: 'sending|sent|delivered|read|failed',

  // ç”¨æˆ·æ¶ˆæ¯ç‰¹æœ‰
  userInfo: {
    avatar: 'avatar_url',
    nickname: 'user_nickname'
  },

  // Agentæ¶ˆæ¯ç‰¹æœ‰
  agentInfo: {
    type: 'cbt_specialist',
    name: 'CBTè®¤çŸ¥ä¸“å®¶',
    avatar: 'agent_avatar_url'
  },

  // åˆ†æç»“æœç‰¹æœ‰
  analysisData: {
    type: 'emotion|culture|risk',
    data: { /* åˆ†æç»“æœæ•°æ® */ },
    confidence: 0.95
  },

  // å…ƒæ•°æ®
  metadata: {
    sessionId: 'session_id',
    messageId: 'original_message_id',
    processingTime: 250,
    modelVersion: 'v2.1.0'
  }
};
```

## æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. æ¶ˆæ¯åˆ—è¡¨ä¼˜åŒ–

- **è™šæ‹Ÿæ»šåŠ¨**ï¼šå¤§é‡æ¶ˆæ¯æ—¶ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨æŠ€æœ¯
- **å›¾ç‰‡æ‡’åŠ è½½**ï¼šå¤´åƒå’Œå›¾ç‰‡æ‡’åŠ è½½
- **æ¶ˆæ¯ç¼“å­˜**ï¼šæœ¬åœ°ç¼“å­˜æ¶ˆæ¯æ•°æ®ï¼Œå‡å°‘ç½‘ç»œè¯·æ±‚

### 2. åˆ†æç»“æœä¼˜åŒ–

- **å¼‚æ­¥åŠ è½½**ï¼šåˆ†æç»“æœå¼‚æ­¥åŠ è½½å’Œæ¸²æŸ“
- **æ•°æ®å‹ç¼©**ï¼šå‹ç¼©åˆ†ææ•°æ®ä¼ è¾“é‡
- **ç¼“å­˜ç­–ç•¥**ï¼šæ™ºèƒ½ç¼“å­˜å¸¸ç”¨åˆ†æç»“æœ

### 3. è¾“å…¥ä½“éªŒä¼˜åŒ–

- **è¾“å…¥é¢„æµ‹**ï¼šåŸºäºå†å²æ•°æ®æä¾›è¾“å…¥å»ºè®®
- **è¯­éŸ³è¯†åˆ«ä¼˜åŒ–**ï¼šä¼˜åŒ–è¯­éŸ³è¯†åˆ«å‡†ç¡®ç‡
- **å¿«æ·æ“ä½œ**ï¼šæä¾›å¸¸ç”¨çŸ­è¯­å¿«æ·è¾“å…¥

## æµ‹è¯•ç­–ç•¥

### åŠŸèƒ½æµ‹è¯•

```javascript
// Agenté€‰æ‹©æµ‹è¯•
describe('Agent Selection', () => {
  test('should select agent successfully', () => {
    const agent = { type: 'cbt_specialist', name: 'CBTè®¤çŸ¥ä¸“å®¶' };
    page.selectAgent(agent);

    expect(page.data.selectedAgent).toEqual(agent);
  });

  test('should load agent history', async () => {
    await page.loadAgentHistory();
    expect(page.data.agentHistory.length).toBeGreaterThan(0);
  });
});

// æ¶ˆæ¯å‘é€æµ‹è¯•
describe('Message Sending', () => {
  test('should send text message successfully', async () => {
    page.setData({ inputText: 'Hello, I need help' });
    await page.sendMessage();

    const lastMessage = page.data.messageList[page.data.messageList.length - 1];
    expect(lastMessage.type).toBe('user');
    expect(lastMessage.content).toContain('Hello, I need help');
  });

  test('should handle voice message input', async () => {
    // Mock voice recording
    const mockVoiceData = 'mock_voice_data';
    await page.processVoiceMessage(mockVoiceData);

    expect(page.data.inputText).toBeDefined();
  });
});

// åˆ†æç»“æœå±•ç¤ºæµ‹è¯•
describe('Analysis Display', () => {
  test('should display emotion analysis correctly', () => {
    const analysisData = {
      type: 'emotion',
      primary_emotion: 'happy',
      radar_dimensions: {
        trust: 0.8,
        openness: 0.7,
        resistance: 0.2,
        stress: 0.3,
        control: 0.9
      }
    };

    page.addAnalysisCards([analysisData]);

    const analysisCard = page.data.messageList.find(msg => msg.type === 'analysis');
    expect(analysisCard).toBeDefined();
    expect(analysisCard.analysisData.type).toBe('emotion');
  });
});
```

### æ€§èƒ½æµ‹è¯•

```javascript
// æ€§èƒ½æµ‹è¯•
describe('Performance Tests', () => {
  test('should handle large message list efficiently', () => {
    const startTime = performance.now();

    // æ·»åŠ 1000æ¡æ¶ˆæ¯
    for (let i = 0; i < 1000; i++) {
      page.addMockMessage();
    }

    const endTime = performance.now();
    const renderTime = endTime - startTime;

    expect(renderTime).toBeLessThan(1000); // 1ç§’å†…å®Œæˆæ¸²æŸ“
  });

  test('should cache analysis results effectively', () => {
    const analysisData = { type: 'emotion', data: {} };

    const startTime = performance.now();
    page.cacheAnalysisResult('test_key', analysisData);
    const cachedResult = page.getCachedAnalysisResult('test_key');
    const endTime = performance.now();

    const cacheTime = endTime - startTime;
    expect(cacheTime).toBeLessThan(10); // 10mså†…å®Œæˆç¼“å­˜æ“ä½œ
    expect(cachedResult).toEqual(analysisData);
  });
});
```

## ç›¸å…³æ–‡æ¡£

- [åŠŸèƒ½-AIå¯¹è¯æ¶ˆæ¯åˆ†æ](../åŠŸèƒ½æ–‡æ¡£/åŠŸèƒ½-AIå¯¹è¯æ¶ˆæ¯åˆ†æ.md)
- [åŠŸèƒ½-æƒ…ç»ªé›·è¾¾å›¾å±•ç¤º](../åŠŸèƒ½æ–‡æ¡£/åŠŸèƒ½-æƒ…ç»ªé›·è¾¾å›¾å±•ç¤º.md)
- [åŠŸèƒ½-æ–‡åŒ–æ´å¯Ÿåˆ†æ](../åŠŸèƒ½æ–‡æ¡£/åŠŸèƒ½-æ–‡åŒ–æ´å¯Ÿåˆ†æ.md)
- [åŠŸèƒ½-å®æ—¶é£é™©è¯„ä¼°](../åŠŸèƒ½æ–‡æ¡£/åŠŸèƒ½-å®æ—¶é£é™©è¯„ä¼°.md)
- [æ•°æ®åº“è®¾è®¡ - message_analysisé›†åˆ](../æ•°æ®åº“è®¾è®¡.md)
- [å‰ç«¯æ ·å¼æ–‡æ¡£ - å¿ƒè¯­ç²¾çµç»„ä»¶](../å‰ç«¯æ ·å¼/å¿ƒè¯­ç²¾çµç»„ä»¶æ ·å¼.md)

## ç‰ˆæœ¬è®°å½•

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ | ä½œè€… |
|------|------|----------|------|
| v1.0.0 | 2025-10-08 | åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæˆå¿ƒè¯­ç²¾çµå¯¹è¯ç•Œé¢æ ¸å¿ƒè®¾è®¡ | å“ˆé›·é…± |