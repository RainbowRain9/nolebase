# 埋点与数据分析

本方案聚焦 5 个 Tab（今天 / 心情随笔 / 任务 / 树洞 / 我的）的关键行为，结合行为闭环、风险治理与成长激励三大目标，定义统一的事件命名与参数规范。所有事件默认在前端以 `wx.reportAnalytics` 上报，同时写入后端 `user_events` 流水，供埋点看板与画像更新双向使用。

## 1. 事件总览

| 事件名称 | 触发条件 | 上报参数 |
| --- | --- | --- |
| `pv_today` | `pages/today/index` `onShow` 触发，记录今天页曝光 | `entry_source`(launch/switchTab/deeplink)、`has_login`(boolean)、`recommendation_bucket` |
| `pv_tasks` | `pages/tasks/index` `onShow` 触发，记录任务页曝光 | `entry_source`(switchTab/deeplink)、`has_login`(boolean)、`filter_applied`(boolean) |
| `click_today_tool` | 用户在今天页金刚区点击某工具 | `tool_id`、`tool_category`、`position`、`is_pinned`(boolean) |
| `mood_checkin_submit` | 用户在今天页提交情绪打卡 | `mood_score`(0-100)、`primary_emotion`、`mood_tags[]`(场景/人物/地点)、`input_type`(emoji/text)、`timestamp` |
| `suggestion_task_create` | 用户点击微建议“一键生成任务卡” | `suggestion_id`、`task_id`、`category`(学业/睡眠/社交/恋爱/其他)、`source`(AI/运营)、`latency_ms`(生成耗时) |
| `task_status_update` | 任务开始/完成/跳过 | `task_id`、`status`(start/complete/skip/defer)、`source_tab`(today/tasks)、`delay_minutes`(相对计划时间) |
| `task_review_submit` | T+1 复盘完成并提交反馈 | `task_id`、`perceived_effect`(scale)、`follow_up_intent`(yes/no)、`note_length` |
| `journal_entry_submit` | 用户在心情随笔页保存内容（含语音转写） | `entry_id`、`input_channel`(text/voice/image/template)、`use_rebt_template`(boolean)、`word_count`、`mood_score` |
| `journal_to_task` | 从心情随笔生成任务卡 | `entry_id`、`task_id`、`template_id`、`auto_summary`(boolean) |
| `task_create_manual` | 用户在任务 Tab 新增任务 | `task_id`、`source`(self/ai/template)、`emotion_category`、`est_duration`、`reminder_setting` |
| `treehole_post_publish` | 树洞发帖通过草稿自检并发布 | `post_id`、`topic`、`risk_score`(0-1)、`anonymity_mode`(anon/pseudonym)、`auto_moderation_result`(pass/review) |
| `treehole_care_action` | 温和关怀触达（抱抱/留言/收藏） | `post_id`、`action_type`(hug/reply/save/report)、`target_user_role`(self/peer/moderator) |
| `risk_signal_escalate` | 内容触发高危阈值并进入转介流程 | `risk_signal_id`、`source`(treehole/conversation/task_note)、`severity_level`、`response_latency_s`、`handler_role` |
| `sos_fab_trigger` | 长按悬浮按钮触发 SOS | `entry_point`(today/global)、`abort`(boolean)、`handoff_channel`(电话/IM) |
| `resource_map_click` | 我的页资源地图点击跳转 | `resource_id`、`category`(校内/热线/社团)、`open_in`(phone/map/miniprogram) |
| `privacy_setting_update` | 用户调整隐私/授权中心选项 | `setting_key`、`new_value`、`previous_value`、`auth_scope` |
| `badge_unlock` | 成就徽章解锁 | `badge_id`、`badge_type`(consistency/compliance/recovery)、`unlock_criteria`、`journey_day` |
| `weekly_report_view` | 护心周报被查看或分享 | `report_id`、`view_channel`(push/today/mine)、`share_action`(none/counselor) |

## 2. 参数规范与公共字段

- **公共字段**：所有事件默认携带 `user_id`（脱敏）、`device_id`、`app_version`、`env`(prod/staging)、`network_type`、`timestamp`。敏感字段在前端本地脱敏后上报。
- **地理信息**：仅在 `resource_map_click` 事件附带 `geo_hash`，并遵循最小必要原则。
- **风险事件**：`risk_signal_escalate` 需链路追踪 ID (`trace_id`)，以便与人工处理工单匹配。
- **内容摘要**：心情随笔、树洞正文不直接上报，使用哈希或模型摘要字段，如 `content_vector_id`，保证隐私。

## 3. 数据看板与指标映射

| 指标类别 | 指标 | 数据来源 | 说明 |
| --- | --- | --- | --- |
| 行为依从性 | 建议接受率 | `suggestion_task_create` ÷ `mood_checkin_submit` | 监控建议→行动转化。
|  | 任务完成率 | `task_status_update(status=complete)` ÷ `task_status_update(status=start)` | 关注行为闭环效果。
|  | T+1 复盘率 | `task_review_submit` ÷ `task_status_update(status=complete)` | 衡量复盘习惯。
| 社区健康 | 高危响应时延 | `risk_signal_escalate.response_latency_s` 平均值 | 风险治理 SLA。
|  | 温和关怀互动率 | `treehole_care_action` ÷ `treehole_post_publish` | 保障社区支持度。
| 成长激励 | 徽章解锁人数 | `badge_unlock` 去重 | 观察激励体系效果。
| 体验满意度 | 周报查看率 | `weekly_report_view` ÷ 周报推送数 | 评估洞察消费程度。

## 4. 落地流程

1. **埋点开发**：前端依据事件表实现，使用统一 `analytics.ts` 封装；上线前通过开发者工具校验字段。 
2. **联调验证**：连通测试环境的埋点网关，使用测试账号走全流程，导出日志核对参数。 
3. **数据入库**：后端将埋点写入 Kafka → ClickHouse，配置离线与实时看板（Superset/Metabase）。 
4. **数据安全**：敏感字段脱敏存储，权限基于 RBAC 控制；风险事件额外加密。 
5. **分析节奏**：
   - 每日：行为闭环漏斗、异常上报（>10% error rate）。
   - 每周：周报查看、徽章、社区互动。
   - 每月：情绪趋势与风险治理复盘。

## 5. 后续迭代建议

- 与用户画像服务打通，依据埋点实时调整 Today 推荐模块排序。
- 引入 A/B 实验字段（`exp_group`），用于微建议、任务提醒策略验证。
- 结合树洞文本情感分析，构建“情绪温度”趋势看板，提前预警校园大事件。


