# 分包规划方案

## 1. 主包与分包结构

### 主包（`pages/`）
- **覆盖页面/功能：** `pages/today/index`、`pages/journal/index`、`pages/tasks/index`、`pages/treehole/index`、`pages/mine/index`
- **选择理由：** 五个 Tab 承载情绪打卡、心情随笔记录、任务看板、树洞浏览、我的总览等首屏核心体验，需要随首包加载以保证启动即用，并复用最多公共组件。
- **包体控制建议：** 精简首屏组件，公共 UI 抽成自定义组件库，静态资源走 CDN，控制主包体积 < 2 MB。

### 分包一：心情随笔域（`packages/journal/`）
- **覆盖页面/功能：** 心情随笔详情、心情随笔编辑、导出分享、任务详情等延伸流程。
- **选择理由：** 属于心情随笔 Tab 的深层页面，首次打开频率低，按需下载可显著减轻主包；与 REBT 模板、情绪趋势复盘逻辑强相关，便于团队独立迭代。
- **包体控制建议：** 图表脚本拆成异步模块，导出素材压缩；语音/录音 SDK 采用按需加载或云能力，避免拖大分包。

### 分包二：社区域（`packages/community/`）
- **覆盖页面/功能：** 帖子详情、发帖向导、话题聚合、行动卡领取成功页等树洞进阶功能。
- **选择理由：** 富文本编辑、风控提示、行动卡逻辑资源占用高，独立打包便于后续灰度发布，减少主包对编辑器与审核组件的耦合。
- **包体控制建议：** 富文本模板改为 JSON 配置，图片上传走云存储；敏感词库放云函数，表情素材放 CDN，保证分包下载后首屏加载 < 1 s。

### 分包三：个人与资源域（`packages/profile/`）
- **覆盖页面/功能：** 护心周报详情、徽章详情、隐私授权详情、资源地图、个人资料编辑。
- **选择理由：** 我的 Tab 深层功能访问频率较低，但周报图表、地图等组件体积大，拆分后可保持主包轻量，并便于独立调优数据可视化与地图 SDK。
- **包体控制建议：** 地图能力使用插件或异步加载，周报图表数据懒加载；静态图片统一使用 WebP 或矢量格式。

### 独立分包：SOS 域（`independent/sos/`）
- **覆盖页面/功能：** SOS 流程主面板、紧急联系人、危机资源快速跳转页。
- **选择理由：** 需要在任何页面秒开，独立分包可避免主包阻塞，并支持被动告警时直接唤起。
- **包体控制建议：** 页面控制在 200 KB 内，沿用极简样式；语音/定位能力通过云调用或插件获取，保持独立分包极轻量。

## 2. app.json 配置建议

```json
{
  "pages": [
    "pages/today/index",
    "pages/journal/index",
    "pages/tasks/index",
    "pages/treehole/index",
    "pages/mine/index"
  ],
  "window": {
    "navigationStyle": "default",
    "navigationBarTitleText": "MindGuard",
    "backgroundTextStyle": "light",
    "navigationBarBackgroundColor": "#FFFFFF",
    "navigationBarTextStyle": "black"
  },
  "tabBar": {
    "color": "#8C8C8C",
    "selectedColor": "#3A7BD5",
    "backgroundColor": "#FFFFFF",
    "borderStyle": "black",
    "list": [
      {
        "pagePath": "pages/today/index",
        "text": "今天",
        "iconPath": "assets/tab/today.png",
        "selectedIconPath": "assets/tab/today-active.png"
      },
      {
        "pagePath": "pages/journal/index",
        "text": "心情随笔",
        "iconPath": "assets/tab/journal.png",
        "selectedIconPath": "assets/tab/journal-active.png"
      },
      {
        "pagePath": "pages/tasks/index",
        "text": "任务",
        "iconPath": "assets/tab/tasks.png",
        "selectedIconPath": "assets/tab/tasks-active.png"
      },
      {
        "pagePath": "pages/treehole/index",
        "text": "树洞",
        "iconPath": "assets/tab/treehole.png",
        "selectedIconPath": "assets/tab/treehole-active.png"
      },
      {
        "pagePath": "pages/mine/index",
        "text": "我的",
        "iconPath": "assets/tab/mine.png",
        "selectedIconPath": "assets/tab/mine-active.png"
      }
    ]
  },
  "subpackages": [
    {
      "root": "packages/journal",
      "name": "journal",
      "pages": [
        "detail/index",
        "edit/index",
        "export/index",
        "task-detail/index"
      ]
    },
    {
      "root": "packages/community",
      "name": "community",
      "pages": [
        "post-detail/index",
        "post-editor/index",
        "topic/index",
        "action-feedback/index"
      ]
    },
    {
      "root": "packages/profile",
      "name": "profile",
      "pages": [
        "report-detail/index",
        "badge-detail/index",
        "privacy-detail/index",
        "resource-map/index",
        "profile-edit/index"
      ]
    },
    {
      "root": "independent/sos",
      "name": "sos",
      "independent": true,
      "pages": [
        "index",
        "resource-switch/index"
      ]
    }
  ],
  "preloadRule": {
    "pages/today/index": {
      "packages": ["packages/journal", "independent/sos"],
      "network": "all"
    },
    "pages/journal/index": {
      "packages": ["packages/journal"],
      "network": "all"
    },
    "pages/tasks/index": {
      "packages": ["packages/journal", "packages/profile"],
      "network": "all"
    },
    "pages/treehole/index": {
      "packages": ["packages/community"],
      "network": "wifi"
    },
    "pages/mine/index": {
      "packages": ["packages/profile"],
      "network": "all"
    }
  }
}
```

## 3. 页面归属校验与优化建议

- **今天 Tab**：首屏承载情绪打卡、微建议、任务执行提醒，是用户启动即用的核心流程，保留在主包合理。其延伸的任务详情、周报查看等已分拆到 journal/profile 分包，可通过预加载减少二次跳转等待。【F:docs/页面文档/页面-今天.md†L1-L26】【F:docs/用户流程说明.md†L6-L18】
- **心情随笔 Tab**：专注多模情绪记录与趋势洞察，深层的心情随笔详情、导出、番茄任务等放入 `packages/journal`。建议将 REBT 模板的多媒体上传组件迁入分包，避免主包引入录音 SDK。【F:docs/页面文档/页面-心情随笔.md†L1-L25】【F:docs/用户流程说明.md†L20-L31】
- **任务 Tab**：集中管理 AI/社区/真人/自建任务并展示统计。主页面保留在主包以保证快速响应；任务详情、周报导出等依赖 journal/profile 分包即可按需加载。【F:docs/页面文档/页面-任务.md†L1-L36】【F:docs/用户流程说明.md†L33-L42】
- **树洞 Tab**：发帖、详情、话题等均移入 `packages/community`，可减少富文本与风控资源占用。建议将“抱抱/评论”所需的表情素材改为 CDN，确保分包下载后首屏加载 < 1 s。【F:docs/页面文档/页面-树洞.md†L1-L31】【F:docs/功能列表.md†L11-L15】
- **我的 Tab**：主包只保留概览卡片，详情页落入 `packages/profile`。由于资源地图与隐私中心依赖地图/安全组件，分包设计合理；建议将意见反馈若跳转树洞话题保持跨包路由，或单独拆出 `packages/feedback` 以便灰度。【F:docs/页面文档/页面-我的.md†L1-L31】【F:docs/用户流程说明.md†L45-L57】
- **SOS 独立分包**：从任何页面唤起需极速响应，使用独立分包正确。建议保持页面轻量并提前通过 `preloadRule` 在今天页预加载，满足紧急情况下的冷启动性能要求。【F:docs/功能列表.md†L6-L7】【F:docs/用户流程说明.md†L6-L18】
- **进一步优化**：若未来新增专题工具箱或资源专题页，可考虑新增 `packages/toolkit` 将低频练习集中，保证主包持续 < 2 MB；跨分包公共组件抽到 `miniprogram_npm` 复用，避免重复打包。


