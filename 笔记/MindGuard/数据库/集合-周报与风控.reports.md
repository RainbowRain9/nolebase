# 集合：周报与风控报告（reports）

## 1. 目的与使用场景
- 存储护心周报、风险提示、运营播报等报告类数据，供“我的”页周报查看、push 通知、辅导员监控及运维分析使用。由 `/api/reports/weekly`、`risk_signal_escalate` 流程、运营后台生成。

## 2. Schema 定义
| 字段 | 类型 | 必填 | 默认值 | 约束/校验 | 说明 | 隐私分级 |
|---|---|---|---|---|---|---|
| _id | string | 是 | - | TCB 自动 | 主键 | P2 |
| user_id | 指针id | 是 | - | 指向 users._id | 报告对象 | P2 |
| report_type | string | 是 | weekly | 枚举(weekly,risk_alert,advisor_note,ops_digest) | 报告类型 | P2 |
| period_start | date | 否 | - | ISO 日期 | 周期开始 | P1 |
| period_end | date | 否 | - | ISO 日期 | 周期结束 | P1 |
| headline | string | 否 | - | 长度 ≤ 80 | 报告标题 | P1 |
| mood_summary | object | 否 | - | `{average,peak,trough,tags[]}` | 情绪概览 | P3 |
| task_metrics | object | 否 | - | `{completion,skipped,focus_minutes}` | 任务指标 | P2 |
| community_highlights | object | 否 | - | `{posts[], hugs_received}` | 社区亮点 | P2 |
| recommendations | array | 否 | [] | 元素 object `{title, task_id}` | 下一步建议 | P2 |
| risk_digest | object | 否 | - | `{level, signals[], handler}` | 风险摘要 | P3 |
| share_status | string | 否 | none | 枚举(none,share_to_guardian,share_to_counselor) | 分享状态 | P2 |
| delivered_channels | array | 否 | [] | 枚举(miniapp,subscription,push,email) | 推送渠道 | P1 |
| read_at | date | 否 | - | ISO 字符串 | 用户阅读时间 | P1 |
| generated_by | string | 否 | system | 枚举(system,ops,counselor) | 生成来源 | P1 |
| version | string | 否 | v1 | semver | 模板版本 | P1 |
| createdAt | date | 是 | - | 服务端时间 | 生成时间 | P1 |
| updatedAt | date | 是 | - | 服务端时间 | 更新时间 | P1 |

## 3. 索引与唯一约束
- 单字段索引：`user_id`、`report_type`
- 复合索引：`[user_id, report_type, period_start desc]`
- 唯一性约束：`[user_id, report_type, period_start]`
- 设计理由：周报按周期唯一；风险提示按生成时间倒序查询。

## 4. 访问控制（TCB 权限）
```json
{
  "read": "user_id == auth.uid || auth.role in ['counselor','ops']",
  "write": "auth.role in ['report_service','counselor','ops']"
}
```

用户可读取自身报告；辅导员/运营可读取全部。写入由报告服务或人工操作完成。


5. 关系与级联
- `user_id` → `users`
- `recommendations.task_id` → `tasks`
- 风险摘要关联 `sos` 记录（通过 `risk_digest.signals` 存储 ID）
- 删除策略：周报保留至少 1 年；风险报告若误报可软删并记录操作日志。
- 反范式：`mood_summary`、`task_metrics` 直接嵌入以提升读取效率。


6. 数据生命周期与合规
- 留存：周报保留 2 年；风险报告依据法规保留 3 年。
- 匿名化：导出给第三方时移除个人标签，仅保留指标。
- 用户导出：允许下载 PDF/JSON；删除请求需同时清理推荐任务引用。
- 审计字段：`createdAt`、`updatedAt`、`generated_by`、`share_status`。


7. API/云函数契约映射
| 接口/函数 | 读/写 | 使用字段 | 过滤条件 | 排序/分页 | 备注 |
| `/api/reports/weekly` GET | 读 | headline, mood_summary, task_metrics, recommendations, read_at | `user_id = auth.uid`, `report_type='weekly'` | `period_start desc` | 我的页周报 |
| `/api/reports/weekly` PATCH | 写 | share_status, read_at | `_id` 匹配 | - | 标记已读/分享 |
| 风险升级流程 `risk_signal_escalate` | 写 | report_type='risk_alert', risk_digest, delivered_channels | - | - | 升级通知 |
| 运营后台 `generateOpsDigest` | 写 | report_type='ops_digest', headline, recommendations | - | - | 运营播报 |

8. 示例文档（≥3条）
```json
{
  "_id": "rep_week_2024w14_usr001",
  "user_id": "usr_001",
  "report_type": "weekly",
  "period_start": "2024-04-01",
  "period_end": "2024-04-07",
  "headline": "情绪平稳，任务完成率 80%",
  "mood_summary": {"average": 68, "peak": 80, "trough": 45, "tags": ["室友", "学习"]},
  "task_metrics": {"completion": 0.8, "skipped": 0.1, "focus_minutes": 160},
  "recommendations": [{"title": "保持固定自习节奏", "task_id": "task_305"}],
  "delivered_channels": ["miniapp"],
  "read_at": "2024-04-08T02:00:00Z",
  "createdAt": "2024-04-07T23:00:00Z",
  "updatedAt": "2024-04-08T02:00:00Z"
}
{
  "_id": "rep_week_2024w14_usr002",
  "user_id": "usr_002",
  "report_type": "weekly",
  "period_start": "2024-04-01",
  "period_end": "2024-04-07",
  "headline": "睡眠偏少，尝试晚安模式",
  "mood_summary": {"average": 52, "peak": 70, "trough": 35, "tags": ["睡眠", "自习"]},
  "task_metrics": {"completion": 0.55, "skipped": 0.3, "focus_minutes": 90},
  "recommendations": [{"title": "晚安呼吸练习", "task_id": "task_401"}],
  "share_status": "share_to_guardian",
  "delivered_channels": ["miniapp", "subscription"],
  "createdAt": "2024-04-07T23:05:00Z",
  "updatedAt": "2024-04-07T23:10:00Z"
}
{
  "_id": "rep_risk_20240406_usr002",
  "user_id": "usr_002",
  "report_type": "risk_alert",
  "headline": "树洞帖子触发 R3 审核",
  "risk_digest": {"level": "R3", "signals": ["sos_20240406_01"], "handler": "counselor_zhang"},
  "delivered_channels": ["miniapp", "push"],
  "generated_by": "counselor",
  "createdAt": "2024-04-06T14:10:00Z",
  "updatedAt": "2024-04-06T14:10:00Z"
}
```

9. 常用查询样例（≥3条）
```javascript
// 获取最近三期周报
const weekly = await db.collection('reports').where({
  user_id: auth.uid,
  report_type: 'weekly'
}).orderBy('period_start', 'desc').limit(3).get();

// 未读周报数量
const unread = await db.collection('reports').where({
  user_id: auth.uid,
  report_type: 'weekly',
  read_at: db.command.exists(false)
}).count();

// 风险值班查看近 24 小时风险警报
const riskAlerts = await db.collection('reports').where({
  report_type: 'risk_alert',
  createdAt: db.command.gte(new Date(Date.now() - 24 * 3600 * 1000).toISOString())
}).orderBy('createdAt', 'desc').get();
```

10. 边界与错误码
- 重复生成：同周期周报已存在返回 `E_REPORT_DUPLICATE`。
- 越权访问：非本人访问返回 `E_FORBIDDEN`，记录审计。
- 风险报告回写失败：缺少 handler 返回 `E_REPORT_HANDLER_REQUIRED`。

11. 变更影响评估
- 字段调整需同步 `/api/reports/weekly`、周报推送模板、埋点 `weekly_report_view`。
- 索引调整影响我的页加载与运营后台查询效率。

12. 假设与待确认
- 假设风险警报也落库此集合；待确认是否需拆分单独 `risk_signals` 集合。
- 待确认是否需要存储周报 PDF 链接（cos_url）。
