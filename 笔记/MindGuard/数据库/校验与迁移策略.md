# 校验与迁移策略

## 1. 校验流程
1. 设计评审：提交集合变更前，补充字段说明、权限表达式、索引影响，并在 PR 中引用相关需求文档。
2. 本地模拟：使用 TCB 模拟器或测试环境执行新增/更新，校验 Schema 校验器（云函数 `schemaValidator`）返回是否通过。
3. 集成测试：关联接口在 `dify/tests` 目录下补充 API 套件，覆盖读写、越权、并发更新场景。
4. 观测指标：迁移后 24 小时内重点关注接口成功率、埋点完整率与慢查询占比（>5% 告警）。

## 2. 迁移策略
- **向前兼容**：新增字段默认可空，前端灰度后再设为必填；旧版本客户端通过云函数输出默认值。
- **索引调整**：先在影子集合验证查询计划；主集合扩索引采用“创建 → 验证 → 切换查询 → 删除旧索引”的顺序。
- **批量数据修复**：使用云函数 `migrationRunner` 分批（每批 500 条）执行，写入迁移日志集合 `migration_logs`。
- **回滚预案**：保留迁移前数据快照（COS 导出或 TCB 备份），若异常回滚需同步更新版本历史并通知埋点团队回补数据。

## 3. 验证清单
- [ ] Schema 校验器通过
- [ ] 索引/唯一约束在控制台检查成功
- [ ] 权限表达式使用测试账号验证读写矩阵
- [ ] 关键 API/云函数自动化测试通过
- [ ] 埋点与事件流字段未缺失（对照《埋点与数据分析.md》）

## 4. 运维交接
- 迁移结束后在飞书群共享总结，记录影响范围、潜在风险与下次迭代建议。
- 由数据团队在 Grafana/腾讯云监控设置临时仪表板，迁移后至少保留 72 小时。
