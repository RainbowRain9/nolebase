# 数据库设计草案

本草案基于 `docs/功能文档` 与《用户流程说明》所述核心场景，提炼微信小程序所需的概念级数据模型，用于后续详细设计与接口梳理。设计遵循“最小必要信息”“安全审计留痕”的原则，并兼顾情绪记录、任务闭环、社区守护与资源触达等业务主线。

## 实体与关系概览

| 核心域 | 关键表 | 主要关系说明 |
| --- | --- | --- |
| 用户与画像 | `users`、`user_profiles` | 用户为一切数据的主键；画像信息为任务推荐、微建议和个性化排序提供特征。|
| 情绪与记录 | `checkins`、`journals`、`daily_reports`、`weekly_summaries` | 情绪打卡与日记沉淀原始数据，按日/周汇总支撑趋势分析、周报与建议生成。|
| 建议与闭环 | `suggestion_sessions`、`micro_suggestions`、`behavior_tasks`、`task_events` | 微建议池与展示会话生成任务清单，事件流水追踪执行状态并回写情绪回执。|
| 社区与守护 | `forum_posts`、`action_cards`、`forum_reactions`、`risk_signals` | 树洞发帖与行动卡互通任务系统，风险信号触发守护流程并记录审计。|
| 紧急求助 | `sos_cases`、`sos_followups` | SOS 呼救记录风险等级、处置动作与回访情况，串联守护者协作。|
| 通知触达 | `notifications`、`user_events` | 系统推送与用户行为事件沉淀触达效果与埋点分析。|
| 安全与合规 | `audit_logs`、`consents` | 记录授权、撤销、SOS 联系等敏感操作，支撑隐私中心与合规审计。|
| 资源与反馈 | `support_resources`、`resource_feedback` | 资源地图提供求助入口，反馈数据反哺运营优化。|
| 成长激励 | `badge_catalog`、`badge_events` | 徽章体系根据情绪、任务、社区数据计算进度与解锁记录。|

下文对各概念表的字段与类型进行说明（类型为概念化描述，可在物理设计阶段调整）。

## 表结构设计

### `users`

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `user_id` | UUID | 用户唯一标识，内部主键。|
| `wechat_openid` | String | 微信 OpenID，用于小程序登录关联。|
| `nickname` | String | 昵称（默认读取微信，可二次编辑）。|
| `avatar_url` | String | 头像地址。|
| `campus_affiliation` | String | 校区/年级等归属信息（可选）。|
| `status` | Enum(`active`,`inactive`,`restricted`) | 账号状态，支持温和封禁。|
| `onboarding_stage` | Enum | 入门进度（用于引导）。|
| `created_at` | Timestamp | 注册时间。|
| `last_login_at` | Timestamp | 最近登录时间。|

**关系**：一对一关联 `user_profiles`；一对多关联所有行为记录（打卡、任务、发帖等）。

### `user_profiles`

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `profile_id` | UUID | 主键。|
| `user_id` | UUID | 关联 `users`。|
| `emotion_baseline` | Integer | 情绪基线（0-100），供建议排序。|
| `risk_tier` | Enum(`low`,`mid`,`high`) | 风险画像，来源于历史信号。|
| `preference_tags` | Array<String> | 用户常用主题/工具偏好。|
| `adherence_score` | Decimal | 任务依从度评分。|
| `last_suggestion_refresh` | Timestamp | 最近一次微建议刷新。|
| `updated_at` | Timestamp | 最后更新时间。|

### `checkins`

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `checkin_id` | UUID | 打卡记录主键。|
| `user_id` | UUID | 关联 `users`。|
| `source` | Enum(`mood_card`,`task_receipt`,`sos`,`manual`) | 打卡来源。|
| `mood_score` | Integer | 情绪分值（0-100）。|
| `mood_tags` | Array<String> | 场景/人物/地点标签。|
| `context_note` | Text | 感受文本或语音转写摘要。|
| `related_task_id` | UUID | 若来自任务回执，关联 `behavior_tasks`。|
| `energy_level` | Integer | 可选能量指数。|
| `created_at` | Timestamp | 记录时间。|
| `meta` | JSON | 设备、触发渠道等补充信息。|

**关系**：用于生成 `daily_reports`、`weekly_summaries`，并回流到 `badge_events` 计算连续打卡等指标。

### `journals`

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `journal_id` | UUID | 日记主键。|
| `user_id` | UUID | 关联 `users`。|
| `entry_type` | Enum(`text`,`voice`,`image`,`mixed`) | 记录类型。|
| `title` | String | 可选标题。|
| `body_text` | Text | 正文内容或语音转写。|
| `mood_score` | Integer | 情绪评分。|
| `mood_tags` | Array<String> | 标签云来源。|
| `media_refs` | Array<String> | 媒体文件引用地址。|
| `abcd_ref` | JSON | REBT A/B/C/D/E 结构化内容。|
| `is_favorited` | Boolean | 是否收藏。|
| `visibility` | Enum(`private`,`share_with_guardian`) | 分享范围。|
| `source` | Enum(`journal_page`,`quick_note`) | 创建入口。|
| `created_at` | Timestamp | 创建时间。|
| `updated_at` | Timestamp | 最近编辑时间。|

**关系**：与 `behavior_tasks`（生成任务）、`daily_reports`（趋势）、`weekly_summaries`（复盘）及 `badge_events`（写作成就）互通。

### `behavior_tasks`

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `task_id` | UUID | 任务主键。|
| `user_id` | UUID | 关联 `users`。|
| `title` | String | 任务标题。|
| `description` | Text | 执行步骤或备注。|
| `source` | Enum(`suggestion`,`journal`,`forum_action`,`weekly_report`,`quick_note`,`template`) | 任务来源。|
| `origin_reference_type` | Enum | 关联的来源实体类型（如 `suggestion`,`action_card`,`tool`）。|
| `origin_reference_id` | UUID | 来源实体标识（可关联 `action_cards`、`journals` 等）。|
| `due_at` | Timestamp | 截止时间。|
| `estimated_duration_minutes` | Integer | 预计耗时。|
| `reminder_at` | Timestamp | 提醒时间。|
| `status` | Enum(`pending`,`in_progress`,`completed`,`skipped`,`expired`) | 当前状态。|
| `priority` | Enum(`low`,`medium`,`high`) | 优先级。|
| `tags` | Array<String> | 主题标签。|
| `created_at` | Timestamp | 创建时间。|
| `updated_at` | Timestamp | 最近更新时间。|

**关系**：与 `task_events` 一对多；可被 `checkins` 引用作为情绪回执来源；来源字段连接社区、周报等模块。

### `task_events`

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `event_id` | UUID | 任务事件主键。|
| `task_id` | UUID | 关联 `behavior_tasks`。|
| `user_id` | UUID | 关联 `users`（冗余便于检索）。|
| `event_type` | Enum(`created`,`claimed`,`started`,`completed`,`skipped`,`reminder_sent`,`feedback_submitted`) | 事件类型。|
| `event_time` | Timestamp | 发生时间。|
| `channel` | Enum(`in_app`,`mini_program`,`notification`) | 触达渠道。|
| `payload` | JSON | 附加数据（如跳过原因）。|
| `related_checkin_id` | UUID | 若填写回执，关联 `checkins`。|
| `notes` | Text | 运营备注或系统补充。|

**关系**：支撑依从性分析、徽章解锁、周报指标；与 `suggestion_sessions`、`weekly_summaries` 间接关联。

### `suggestion_sessions`

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `session_id` | UUID | 微建议展示会话。|
| `user_id` | UUID | 关联 `users`。|
| `trigger_source` | Enum(`mood_card`,`refresh_button`,`weekly_report`) | 触发场景。|
| `suggestions` | JSON | 当次推荐内容（含排序与权重）。|
| `selected_task_id` | UUID | 用户接受并生成的任务标识。|
| `refresh_count` | Integer | 当前会话内刷新次数。|
| `created_at` | Timestamp | 会话时间。|
| `updated_at` | Timestamp | 最近更新。|

**关系**：生成的任务写入 `behavior_tasks`；刷新次数用于画像 (`user_profiles.adherence_score`) 调整。

### `micro_suggestions`

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `suggestion_id` | UUID | 微建议模板主键。|
| `theme` | Enum(`emotion`,`sleep`,`social`,`productivity`,`mindfulness`) | 所属主题，用于前端分类与权重计算。|
| `title` | String | 建议标题。|
| `description` | Text | 建议正文/执行引导。|
| `intensity_level` | Enum(`gentle`,`standard`,`challenge`) | 行动强度层级。|
| `tags` | Array<String> | 标签（适用情绪、场景、时间段）。|
| `applicability_conditions` | JSON | 命中条件（情绪分、画像标签、周期等）。|
| `task_template` | JSON | 生成任务所需的结构化字段（标题、步骤、预计耗时）。|
| `status` | Enum(`active`,`paused`,`retired`) | 是否对用户开放。|
| `updated_at` | Timestamp | 最近更新时间。|

**关系**：作为 `suggestion_sessions` 的候选池，命中后生成 `behavior_tasks`；标签用于 `user_profiles.preference_tags` 学习。


### `daily_reports`

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `report_id` | UUID | 日报主键。|
| `user_id` | UUID | 关联 `users`。|
| `report_date` | Date | 对应日期。|
| `mood_avg` | Decimal | 平均情绪分值。|
| `mood_peak` | Integer | 最高情绪分值。|
| `mood_trough` | Integer | 最低情绪分值。|
| `top_tags` | Array<String> | 高频标签。|
| `task_completion_rate` | Decimal | 当日任务完成率。|
| `insights` | JSON | 个性化洞察/提示。|
| `created_at` | Timestamp | 生成时间。|

**关系**：聚合 `checkins`、`task_events`、`journals`；为 `weekly_summaries` 与情绪趋势图提供数据。

### `weekly_summaries`

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `summary_id` | UUID | 周报主键。|
| `user_id` | UUID | 关联 `users`。|
| `week_start_date` | Date | 周期开始日期。|
| `week_end_date` | Date | 周期结束日期。|
| `mood_overview` | JSON | 情绪分布、波动描述。|
| `task_metrics` | JSON | 任务完成率、跳过率、番茄时长等。|
| `risk_digest` | JSON | 风险信号摘要。|
| `highlight_journal_ids` | Array<UUID> | 代表性日记引用。|
| `next_best_actions` | JSON | Top N 下一步建议。|
| `shared_with_guardian` | Boolean | 是否分享给守护者。|
| `created_at` | Timestamp | 生成时间。|

**关系**：与 `behavior_tasks`（生成下一步任务）、`consents`（分享授权）和 `badge_events`（周报阅读成就）相关。

### `forum_posts`

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `post_id` | UUID | 帖子主键。|
| `user_id` | UUID | 关联 `users`（匿名时仍内部关联）。|
| `alias_name` | String | 匿名/化名展示。|
| `content` | Text | 帖子正文。|
| `tags` | Array<String> | 主题标签。|
| `mood_thermometer` | Integer | 情绪温度条分值。|
| `is_anonymous` | Boolean | 是否匿名展示。|
| `risk_level` | Enum(`R1`,`R2`,`R3`,`R4`) | 风险分级。|
| `status` | Enum(`draft`,`pending_review`,`published`,`archived`) | 审核状态。|
| `origin_task_id` | UUID | 若来自任务复盘，关联 `behavior_tasks`。|
| `action_card_id` | UUID | 若生成行动卡，关联 `action_cards`。|
| `created_at` | Timestamp | 创建时间。|
| `updated_at` | Timestamp | 最近更新时间。|

**关系**：与 `forum_reactions`、`risk_signals`、`action_cards` 联动；高风险帖子触发告警与资源引导。

### `forum_reactions`

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `reaction_id` | UUID | 互动主键。|
| `post_id` | UUID | 关联 `forum_posts`。|
| `user_id` | UUID | 关联 `users`。|
| `reaction_type` | Enum(`like`,`hug`,`comment`,`share`) | 互动类型。|
| `content` | Text | 评论或附加文案（点赞/抱抱为空）。|
| `created_at` | Timestamp | 发生时间。|

**关系**：反映社区活跃度，可用于徽章解锁与画像调整。

### `action_cards`

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `action_card_id` | UUID | 行动卡主键。|
| `post_id` | UUID | 关联 `forum_posts`（行动卡贴）。|
| `title` | String | 行动标题。|
| `steps` | JSON | 执行步骤列表。|
| `estimated_duration_minutes` | Integer | 预计耗时。|
| `tags` | Array<String> | 场景标签。|
| `created_by` | UUID | 创建用户（运营或守护者）。|
| `status` | Enum(`published`,`draft`,`retired`) | 当前状态。|
| `published_at` | Timestamp | 上线时间。|

**关系**：被 `behavior_tasks` 领取，记录在 `task_events::claimed`；完成后可反哺帖子复盘。

### `risk_signals`

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `signal_id` | UUID | 风险事件主键。|
| `user_id` | UUID | 关联 `users`（若可识别）。|
| `source` | Enum(`forum_post`,`sos_button`,`task_feedback`,`system`) | 触发来源。|
| `related_post_id` | UUID | 关联 `forum_posts`（可空）。|
| `related_task_id` | UUID | 关联 `behavior_tasks`（可空）。|
| `level` | Enum(`R1`,`R2`,`R3`,`R4`) | 风险等级。|
| `score` | Integer | 模型评分或概率。|
| `status` | Enum(`open`,`acknowledged`,`in_progress`,`resolved`,`dismissed`) | 处理状态。|
| `assigned_guardian_id` | UUID | 值班守护者/工作人员。|
| `created_at` | Timestamp | 触发时间。|
| `resolved_at` | Timestamp | 关闭时间。|
| `notes` | Text | 处理说明或转介情况。|

**关系**：驱动守护工作流，产生 `audit_logs` 与 `consents`；高等级信号可关联 `support_resources` 推荐。

### `sos_cases`

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `sos_id` | UUID | SOS 呼救主键。|
| `user_id` | UUID | 发起用户（未登录时可空）。|
| `trigger_channel` | Enum(`today_tab`,`mine_tab`,`floating_button`,`offline_code`) | 触发渠道。|
| `location_geo` | GeoPoint | 定位信息（经脱敏/模糊化处理）。|
| `emotion_level` | Enum(`calm`,`upset`,`panic`) | 用户自述状态。|
| `risk_level` | Enum(`R2`,`R3`,`R4`) | 系统评估等级。|
| `contact_preference` | Enum(`call_me`,`text_me`,`no_contact`) | 用户期望的联系方式。|
| `status` | Enum(`open`,`assigned`,`in_progress`,`resolved`,`cancelled`) | 当前处理状态。|
| `assigned_guardian_id` | UUID | 值守人/辅导员。|
| `created_at` | Timestamp | 发起时间。|
| `resolved_at` | Timestamp | 关闭时间。|
| `notes` | Text | 记录处理摘要。|

**关系**：严重呼救同步写入 `risk_signals`；处理动作在 `sos_followups`、`audit_logs` 留痕，并可能推送 `notifications` 给相关人员。

### `sos_followups`

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `followup_id` | UUID | 跟进记录主键。|
| `sos_id` | UUID | 关联 `sos_cases`。|
| `handler_id` | UUID | 记录执行者。|
| `action_type` | Enum(`call`,`message`,`escalate`,`offline_support`,`resource_share`) | 跟进行动类型。|
| `action_detail` | Text | 动作描述、时间与结果。|
| `next_step` | Text | 后续计划。|
| `created_at` | Timestamp | 记录时间。|

**关系**：与 `audit_logs` 共用守护流程审计，若涉及资源转介需关联 `support_resources`。|

### `audit_logs`

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `log_id` | UUID | 审计记录主键。|
| `user_id` | UUID | 行为发起用户。|
| `action` | String | 操作标识（如 `revoke_consent`、`contact_resource`）。|
| `target_type` | String | 被操作对象类型（如 `consent`,`resource`,`post`）。|
| `target_id` | UUID | 被操作对象标识。|
| `channel` | Enum(`mini_program`,`staff_console`,`automation`) | 操作渠道。|
| `ip_location` | String | 大致地理位置/设备信息。|
| `metadata` | JSON | 其他字段级审计信息。|
| `created_at` | Timestamp | 记录时间。|

**关系**：隐私中心、SOS、资源联系等操作均写入审计；可与 `consents`、`risk_signals` 关联追踪处理链路。

### `consents`

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `consent_id` | UUID | 授权记录主键。|
| `user_id` | UUID | 授权主体。|
| `grantee_type` | Enum(`counselor`,`guardian`,`staff`,`service`) | 被授权对象类型。|
| `grantee_identifier` | String | 对方标识（工号、手机号等）。|
| `scope` | JSON | 授权范围（字段级）。|
| `is_anonymous` | Boolean | 是否匿名共享。|
| `effective_from` | Timestamp | 生效时间。|
| `expires_at` | Timestamp | 失效时间。|
| `status` | Enum(`active`,`revoked`,`expired`) | 当前状态。|
| `revoked_at` | Timestamp | 撤销时间。|
| `created_at` | Timestamp | 创建时间。|

**关系**：与 `audit_logs`（撤销/续期记录）、`weekly_summaries`（分享周报）、`risk_signals`（危机授权）相关。

### `support_resources`

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `resource_id` | UUID | 资源主键。|
| `name` | String | 资源名称。|
| `category` | Enum(`campus_center`,`counselor`,`club`,`hotline`,`tool`) | 资源类别。|
| `description` | Text | 简要介绍。|
| `contact_type` | Enum(`phone`,`wechat`,`link`,`offline`) | 联系方式类型。|
| `contact_value` | String | 联系方式具体内容。|
| `supports_anonymous` | Boolean | 是否支持匿名。|
| `location` | String | 地址或线上入口。|
| `working_hours` | String | 服务时间。|
| `priority_rank` | Integer | 展示排序权重。|
| `status` | Enum(`active`,`inactive`) | 是否在用。|
| `created_at` | Timestamp | 创建时间。|
| `updated_at` | Timestamp | 最近更新。|

**关系**：在“我的”页展示；被 `resource_feedback`、`audit_logs`（联系记录）、`risk_signals`（推荐）引用。

### `resource_feedback`

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `feedback_id` | UUID | 反馈主键。|
| `resource_id` | UUID | 关联 `support_resources`。|
| `user_id` | UUID | 反馈用户。|
| `contact_method` | Enum(`anonymous`,`identified`) | 联系方式类型。|
| `rating` | Integer | 体验评分（1-5）。|
| `comment` | Text | 文字反馈。|
| `follow_up_required` | Boolean | 是否需要运营跟进。|
| `created_at` | Timestamp | 提交时间。|

**关系**：帮助优化资源地图；可关联 `risk_signals` 用于跟进高风险求助。

### `notifications`

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `notification_id` | UUID | 通知主键。|
| `user_id` | UUID | 接收用户。|
| `category` | Enum(`task`,`report`,`community`,`sos`,`system`) | 通知类别。|
| `title` | String | 标题。|
| `body` | Text | 文本内容（可含 markdown 片段）。|
| `action_path` | String | 点击后跳转的小程序路径。|
| `action_params` | JSON | 路由参数。|
| `delivery_channel` | Enum(`inbox`,`subscribe_message`,`sms`,`staff_call`) | 触达方式。|
| `status` | Enum(`pending`,`sent`,`read`,`archived`) | 状态。|
| `scheduled_at` | Timestamp | 预定推送时间。|
| `sent_at` | Timestamp | 实际发送时间。|
| `read_at` | Timestamp | 阅读时间。|

**关系**：来源于 `behavior_tasks` 提醒、`weekly_summaries` 推送、`sos_cases` 告警；阅读行为写入 `user_events`。|

### `user_events`

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `event_id` | UUID | 行为事件主键。|
| `user_id` | UUID | 关联 `users`。|
| `event_name` | String | 事件名称（如 `pv_today`、`click_today_tool`）。|
| `event_time` | Timestamp | 触发时间。|
| `context` | JSON | 页面、位置、设备等上下文。|
| `source` | Enum(`mini_program`,`notification`,`automation`) | 事件来源渠道。|
| `related_resource` | JSON | 若关联任务/帖子/资源，记录目标 ID 与类型。|

**关系**：支撑埋点与漏斗分析，与 `notifications`、`behavior_tasks`、`suggestion_sessions` 等计算转化率。

### `badge_catalog`

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `badge_id` | UUID | 徽章主键。|
| `name` | String | 徽章名称。|
| `description` | Text | 展示描述。|
| `category` | Enum(`mood`,`habit`,`community`,`safety`) | 徽章类别。|
| `icon_asset` | String | 图标资源。|
| `unlock_condition` | JSON | 解锁条件公式或阈值。|
| `celebration_copy` | String | 庆祝文案。|
| `status` | Enum(`active`,`retired`) | 是否启用。|
| `created_at` | Timestamp | 创建时间。|

### `badge_events`

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `event_id` | UUID | 解锁事件主键。|
| `badge_id` | UUID | 关联 `badge_catalog`。|
| `user_id` | UUID | 关联 `users`。|
| `progress_percent` | Decimal | 当前达成进度。|
| `status` | Enum(`locked`,`in_progress`,`unlocked`) | 状态。|
| `trigger_source` | Enum(`checkin`,`task`,`community`,`report`) | 触发来源。|
| `unlocked_at` | Timestamp | 解锁时间。|
| `created_at` | Timestamp | 记录时间。|

**关系**：依赖 `checkins`、`task_events`、`forum_posts` 等数据计算；与前端徽章展示直接对应。

## 关系说明

- **用户主导关系**：`users` 是所有业务表的外键核心；`user_profiles` 提供个性化推荐特征，驱动 `suggestion_sessions` 与任务排序。
- **情绪数据链路**：`checkins` 与 `journals` 共同沉淀情绪与标签，日/周汇总存入 `daily_reports`、`weekly_summaries`，再反馈给微建议、周报、徽章系统。
- **建议与任务闭环**：`micro_suggestions` 提供模板池，`suggestion_sessions` 将其匹配给用户并生成 `behavior_tasks`；`task_events` 记录执行轨迹，完成后触发 `checkins` 回执及徽章进度更新。
- **社区互通**：`forum_posts` 可生成 `action_cards`，被用户领取后写入 `behavior_tasks`；帖子风险与执行复盘通过 `risk_signals`、`sos_cases`、`audit_logs` 跟踪，确保树洞安全。
- **安全守护**：`sos_cases` 与 `risk_signals` 汇总来自 SOS、帖子、任务回执的预警，`sos_followups` 记录线下/线上协作，并要求 `consents`、`audit_logs` 留痕。
- **通知与分析**：`notifications` 负责任务提醒、周报推送与守护告警；用户互动沉淀在 `user_events`，支撑漏斗分析与触达策略优化。
- **资源触达与反馈**：`support_resources` 为资源地图数据源，用户的联系操作写入 `audit_logs` 与 `resource_feedback`，并可能关联 `risk_signals` 做后续跟进。
- **成长激励**：`badge_catalog` + `badge_events` 组合追踪用户在情绪、任务、社区互动上的成就，并可与 `weekly_summaries` 推荐下一步行动。

> 注：以上为概念级设计，实际落库时可根据业务量级、查询模式与安全策略拆分读写库、引入多租户隔离或细化字段（如字段加密、分表策略等）。
