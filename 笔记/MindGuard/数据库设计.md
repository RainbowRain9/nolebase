# MindGuard 数据库设计

本文档基于 `docs/数据库/` 目录下的详细集合设计文件，提供了 MindGuard 微信小程序的完整数据模型概览。设计遵循"最小必要信息""安全审计留痕"的原则，支撑情绪记录、任务闭环、社区守护与资源触达等核心业务。

## 实体与关系概览

| 核心域 | 关键表 | 主要关系说明 |
| --- | --- | --- |
| 用户与权限 | `users`、`events` | users 为所有数据的主键，包含角色权限和守护配置；events 记录用户行为事件，支撑画像分析和 A/B 测试。 |
| 情绪健康闭环 | `checkins`、`journals`、`suggestions`、`tasks` | 情绪打卡与心情随笔沉淀原始数据，微建议系统生成任务清单，支持情绪-建议-任务的完整闭环。 |
| 社区守护系统 | `posts`、`comments`、`feedback` | 树洞发帖支持匿名互动，风险识别触发守护流程，反馈系统保障内容安全和用户体验。 |
| 安全保障机制 | `sos`、`reports`、`notifications` | SOS 呼救记录风险等级和处置过程，周报与风险报告提供健康洞察，通知系统确保及时触达。 |
| 资源与激励 | `resources`、`badges` | 资源地图提供校内外心理支持，徽章体系根据行为数据计算进度，形成正向激励循环。 |

## 表结构设计

### USERS

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `_id` | string | 主键 |
| `_openid` | string | 微信 OpenID，唯一标识 |
| `nickname` | string | 昵称 |
| `avatar_url` | string | 头像地址 |
| `campus_affiliation` | string | 校区/院系标签 |
| `status` | string | 账号状态 (active/inactive/restricted/suspended) |
| `role` | string | 用户角色 (user/counselor/mentor/guardian/ops) |
| `risk_tier` | string | 风险画像等级 (low/mid/high/critical) |
| `badge_ids` | array | 已获得徽章列表 |
| `guardian_ids` | array | 绑定守护者列表 |
| `counselor_id` | string | 绑定辅导员 |
| `emergency_contacts` | array | 紧急联系人列表 |
| `statistics` | object | 用户统计信息 |
| `preference_profile` | object | 偏好设置 |
| `consent_version` | string | 隐私协议版本 |
| `last_login_at` | date | 最近登录时间 |
| `last_activity_at` | date | 最后活动时间 |
| `is_deleted` | boolean | 软删标记 |
| `createdAt` | date | 创建时间 |
| `updatedAt` | date | 更新时间 |

**关系**：被所有行为记录表引用，通过 guardian_ids 和 counselor_id 自引用形成守护关系。

### CHECKINS

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `_id` | string | 主键 |
| `_openid` | string | 创建者 openid |
| `user_id` | string | 用户指针 |
| `mood_score` | number | 情绪分值 (0-100) |
| `mood_tags` | array | 场景/人物/地点标签 |
| `scene_tags` | array | 场景标签 |
| `primary_emotion` | string | 主情绪类别 |
| `risk_level` | string | 风险等级 (L1/L2/L3/L4) |
| `context_note` | string | 文本感受摘要 |
| `input_type` | string | 来源入口 |
| `related_task_id` | string | 关联任务 |
| `energy_level` | number | 能量指数 |
| `mood_wheel_snapshot` | object | 心情轮占比数据 |
| `checkin_date` | date | 打卡日期 |
| `suggestion_ids` | array | 当次建议列表 |
| `checkin_count` | number | 当日打卡次数 |
| `createdAt` | date | 创建时间 |
| `updatedAt` | date | 更新时间 |

**关系**：user_id → users，related_task_id → tasks，suggestion_ids → suggestions

### JOURNALS

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `_id` | string | 主键 |
| `_openid` | string | 创建人 openid |
| `user_id` | string | 用户指针 |
| `entry_type` | string | 记录类型 (text/voice/image/mixed/template) |
| `title` | string | 可选标题 |
| `body_text` | string | 文本正文或语音转写 |
| `mood_score` | number | 情绪分值 |
| `mood_tags` | array | 标签云来源 |
| `scene_tags` | array | 场景标签 |
| `media_refs` | array | 附件引用 |
| `rebt_struct` | object | REBT 结构化内容 |
| `ocr_text` | string | OCR 识别文本 |
| `derived_summary` | object | AI 摘要 |
| `generated_task_ids` | array | 转任务引用 |
| `share_scope` | string | 分享范围 (private/guardian/shared_link) |
| `risk_level` | string | 风险等级 |
| `source` | string | 创建入口 |
| `is_favorited` | boolean | 收藏标记 |
| `word_count` | number | 文本字数统计 |
| `audio_duration` | number | 音频时长 |
| `createdAt` | date | 创建时间 |
| `updatedAt` | date | 更新时间 |

**关系**：user_id → users，generated_task_ids → tasks

### TASKS

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `_id` | string | 主键 |
| `_openid` | string | 创建人 openid |
| `user_id` | string | 用户 |
| `title` | string | 任务标题 |
| `description` | string | 任务说明 |
| `source` | string | 来源 (suggestion/journal/action_card/weekly_report/quick_note/manual/counselor/mentor) |
| `origin_reference_type` | string | 来源实体类型 |
| `origin_reference_id` | string | 来源实体 ID |
| `category` | string | 分类标签 |
| `emotion_category` | string | 情绪类别 |
| `status` | string | 状态 (pending/in_progress/completed/skipped/expired/pending_confirmation/needs_review) |
| `due_at` | date | 截止时间 |
| `reminder_at` | date | 提醒时间 |
| `estimated_duration_minutes` | number | 预计耗时 |
| `priority` | string | 优先级 (low/medium/high) |
| `checklist_steps` | array | 子步骤 |
| `linked_checkin_id` | string | 完成回执 |
| `adherence_score` | number | 完成后效果评分 |
| `tags` | array | 自定义标签 |
| `is_pinned` | boolean | 今天页置顶 |
| `assignment_info` | object | 真人指派信息 |
| `pomodoro_sessions` | array | 番茄计时记录 |
| `review_data` | object | 复盘数据 |
| `createdAt` | date | 创建时间 |
| `updatedAt` | date | 更新时间 |

**关系**：user_id → users，origin_reference_id → suggestions/journals/posts，linked_checkin_id → checkins

### POSTS

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `_id` | string | 主键 |
| `_openid` | string | 作者 openid |
| `user_id` | string | 用户 |
| `alias_name` | string | 匿名展示名 |
| `anonymity_mode` | string | 匿名模式 (anon/pseudonym) |
| `content` | string | 正文 |
| `tags` | array | 主题标签 |
| `topic` | string | 话题分类 |
| `mood_thermometer` | number | 情绪温度 |
| `risk_score` | number | 风险模型分值 |
| `risk_level` | string | 风险等级 |
| `risk_factors` | array | 风险因素 |
| `status` | string | 状态 (draft/pending_review/published/removed/archived) |
| `moderation_result` | object | 审核记录 |
| `action_card_id` | string | 行动卡引用 |
| `self_check_result` | object | 草稿自检结果 |
| `comment_count` | number | 评论数 |
| `hug_count` | number | 抱抱数 |
| `favorite_count` | number | 收藏数 |
| `report_count` | number | 被举报数 |
| `is_featured` | boolean | 精选状态 |
| `risk_flag` | string | 风险标记 |
| `intervention_triggered` | boolean | 是否触发干预 |
| `guardian_notified` | boolean | 守护者已通知 |
| `content_hash` | string | 内容哈希 |
| `last_interaction_at` | date | 最后互动时间 |
| `publishedAt` | date | 发布时间 |
| `createdAt` | date | 创建时间 |
| `updatedAt` | date | 更新时间 |

**关系**：user_id → users，action_card_id → tasks

### SUGGESTIONS

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `_id` | string | 主键 |
| `user_id` | string | 用户 |
| `session_id` | string | 推荐会话标识 |
| `title` | string | 建议标题 |
| `description` | string | 补充说明 |
| `category` | string | 建议分类 |
| `priority_rank` | number | 当前排序 |
| `source` | string | 建议来源 (model/curated/manual) |
| `feature_snapshot` | object | 生成特征 |
| `task_template_id` | string | 生成任务模板 |
| `status` | string | 状态 (active/accepted/skipped/expired) |
| `accepted_task_id` | string | 接受后生成的任务 |
| `refresh_count` | number | 本会话刷新次数 |
| `expired_at` | date | 失效时间 |
| `createdAt` | date | 生成时间 |
| `updatedAt` | date | 更新时间 |

**关系**：user_id → users，accepted_task_id → tasks

### BADGES

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `_id` | string | 主键 |
| `user_id` | string | 用户 |
| `badge_code` | string | 徽章编码 |
| `status` | string | 当前状态 (locked/in_progress/unlocked) |
| `progress_value` | number | 当前进度 |
| `progress_target` | number | 目标 |
| `progress_detail` | object | 进度详情 |
| `unlocked_at` | date | 解锁时间 |
| `first_completed_at` | date | 首次达成时间 |
| `source` | string | 更新来源 |
| `createdAt` | date | 创建时间 |
| `updatedAt` | date | 更新时间 |

**关系**：user_id → users

### COMMENTS

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `_id` | string | 主键 |
| `_openid` | string | 互动者 openid |
| `user_id` | string | 用户 |
| `post_id` | string | 所属帖子 |
| `parent_id` | string | 楼中楼引用 |
| `action_type` | string | 互动类型 (reply/hug/save/report/moderator_note) |
| `content` | string | 文本内容 |
| `mood_thermometer` | number | 回复时的情绪 |
| `is_anonymous` | boolean | 匿名展示 |
| `alias_name` | string | 匿名昵称 |
| `metadata` | object | 附加信息 |
| `risk_flag` | string | 风险标记 |
| `status` | string | 状态 (active/hidden/removed) |
| `createdAt` | date | 创建时间 |
| `updatedAt` | date | 更新时间 |

**关系**：user_id → users，post_id → posts，parent_id → comments

### NOTIFICATIONS

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `_id` | string | 主键 |
| `user_id` | string | 接收者 |
| `message_type` | string | 通知类型 |
| `template_code` | string | 模板标识 |
| `title` | string | 通知标题 |
| `content` | string | 文案摘要 |
| `payload` | object | 结构化参数 |
| `channel` | string | 发送渠道 |
| `target_page` | string | 点击跳转 |
| `deeplink` | string | 外部链接 |
| `status` | string | 状态 (pending/sending/sent/failed/read) |
| `send_at` | date | 计划发送时间 |
| `sent_at` | date | 实际发送时间 |
| `read_at` | date | 已读时间 |
| `error_message` | string | 失败原因 |
| `createdAt` | date | 创建时间 |
| `updatedAt` | date | 更新时间 |

**关系**：user_id → users

### EVENTS

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `_id` | string | 主键 |
| `user_id` | string | 用户 |
| `openid_hash` | string | openid 哈希 |
| `event_name` | string | 事件名称 |
| `event_time` | date | 事件时间 |
| `page_path` | string | 触发页面 |
| `event_params` | object | 事件参数 |
| `device` | object | 设备信息 |
| `app_version` | string | 客户端版本 |
| `env` | string | 环境 |
| `network_type` | string | 网络 |
| `session_id` | string | 会话 ID |
| `trace_id` | string | 链路追踪 |
| `source_type` | string | 上报来源 |
| `exp_group` | string | 实验分组 |
| `createdAt` | date | 写入时间 |

**关系**：user_id → users

### SOS

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `_id` | string | 主键 |
| `user_id` | string | 发起人 |
| `trigger_source` | string | 触发来源 |
| `entry_point` | string | 入口 |
| `status` | string | 流转状态 |
| `severity_level` | string | 严重程度 |
| `guardian_contact_ids` | array | 通知的守护者 |
| `notify_results` | array | 通知结果 |
| `assigned_handler` | string | 值班人员 ID |
| `handler_role` | string | 处理角色 |
| `escalation_steps` | array | 升级日志 |
| `user_notes` | string | 用户补充信息 |
| `location_hint` | object | 位置线索 |
| `cancel_reason` | string | 取消原因 |
| `resolved_at` | date | 关闭时间 |
| `createdAt` | date | 创建时间 |
| `updatedAt` | date | 更新时间 |

**关系**：user_id → users，guardian_contact_ids → users

### REPORTS

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `_id` | string | 主键 |
| `user_id` | string | 报告对象 |
| `report_type` | string | 报告类型 |
| `period_start` | date | 周期开始 |
| `period_end` | date | 周期结束 |
| `headline` | string | 报告标题 |
| `mood_summary` | object | 情绪概览 |
| `task_metrics` | object | 任务指标 |
| `community_highlights` | object | 社区亮点 |
| `recommendations` | array | 下一步建议 |
| `risk_digest` | object | 风险摘要 |
| `share_status` | string | 分享状态 |
| `delivered_channels` | array | 推送渠道 |
| `read_at` | date | 用户阅读时间 |
| `generated_by` | string | 生成来源 |
| `version` | string | 模板版本 |
| `createdAt` | date | 生成时间 |
| `updatedAt` | date | 更新时间 |

**关系**：user_id → users，recommendations.task_id → tasks

### RESOURCES

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `_id` | string | 主键 |
| `name` | string | 资源名称 |
| `description` | string | 简要说明 |
| `category` | string | 资源分类 |
| `sub_category` | string | 子分类 |
| `contact_info` | object | 联系方式 |
| `operating_hours` | object | 营业时间 |
| `location` | object | 地理位置 |
| `support_anonymous` | boolean | 支持匿名联系 |
| `appointment_required` | boolean | 需要预约 |
| `service_scope` | array | 服务范围 |
| `eligibility` | array | 适用人群 |
| `confidentiality` | string | 保密级别 |
| `cost_info` | string | 费用说明 |
| `languages` | array | 支持语言 |
| `accessibility` | array | 无障碍设施 |
| `tags` | array | 标签 |
| `rating` | number | 用户评分 |
| `usage_count` | number | 使用次数 |
| `status` | string | 状态 |
| `priority` | number | 显示优先级 |
| `metadata` | object | 扩展信息 |
| `createdAt` | date | 创建时间 |
| `updatedAt` | date | 更新时间 |

### FEEDBACK

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| `_id` | string | 主键 |
| `user_id` | string | 反馈用户 |
| `_openid` | string | 用户标识 |
| `feedback_type` | string | 反馈类型 |
| `target_type` | string | 目标类型 |
| `target_id` | string | 目标对象 ID |
| `category` | string | 分类 |
| `title` | string | 反馈标题 |
| `content` | string | 详细描述 |
| `severity` | string | 严重程度 |
| `attachments` | array | 附件 |
| `contact_preference` | string | 回复方式 |
| `contact_info` | string | 联系信息 |
| `is_anonymous` | boolean | 匿名反馈 |
| `status` | string | 处理状态 |
| `assignee_id` | string | 处理人 ID |
| `assignee_role` | string | 处理人角色 |
| `response_content` | string | 回复内容 |
| `response_at` | date | 回复时间 |
| `resolution_action` | object | 解决方案 |
| `tags` | array | 内部标签 |
| `priority` | number | 处理优先级 |
| `metadata` | object | 元数据 |
| `created_ip` | string | 创建 IP |
| `created_location` | object | 创建位置 |
| `resolved_at` | date | 解决时间 |
| `createdAt` | date | 创建时间 |
| `updatedAt` | date | 更新时间 |

**关系**：user_id → users，target_id → 关联集合

## 关键关系说明

### 用户主导关系
- `users` 是所有业务数据的核心，通过 `_id` 被各业务表引用
- 支持守护者体系，通过 `guardian_ids` 自引用形成守护网络
- 角色权限系统支撑多端协作（学生/辅导员/守护者/运营）

### 情绪健康闭环
- **数据沉淀**：`checkins` 记录每日情绪，`journals` 提供深度记录
- **智能推荐**：`suggestions` 基于用户画像生成个性化建议
- **任务执行**：`tasks` 将建议转化为可执行行动，支持回执评分
- **效果评估**：通过 `linked_checkin_id` 建立任务与情绪改善的关联

### 社区守护系统
- **内容生态**：`posts` 支持匿名发帖，`comments` 提供互动功能
- **安全保障**：多层风险识别（内容风险+情绪风险），自动触发干预
- **行动转化**：高风险内容生成 `action_card_id`，引导用户采取积极行动
- **反馈机制**：`feedback` 系统保障内容安全和用户体验

### 安全保障机制
- **紧急响应**：`sos` 提供一键求助，支持多级升级和协作处置
- **风险监测**：`reports` 整合多源数据，提供周报和风险告警
- **及时触达**：`notifications` 确保重要信息不遗漏

### 资源与激励
- **资源整合**：`resources` 提供校内外心理支持资源的统一入口
- **成长激励**：`badges` 基于用户行为数据计算成就进度，形成正向循环
- **数据分析**：`events` 记录全量用户行为，支撑产品优化和 A/B 测试

## 数据安全与合规

### 隐私分级
- **P1**：基础信息（昵称、头像等）
- **P2**：敏感信息（联系方式、位置等）
- **P3**：高度敏感（情绪数据、求助内容等）

### 访问控制
- 基于 TCB 权限系统，实现精细化读写控制
- 支持角色权限区分（用户/辅导员/守护者/运营）
- 敏感操作记录审计日志

### 数据生命周期
- 用户数据保留期限遵循最小必要原则
- 支持用户数据导出和删除请求
- 高敏感数据采用加密存储和脱敏处理

> 本文档为 MindGuard 项目的核心数据库设计，实际实施时可根据业务发展进行优化调整。详细的集合设计请参考 `docs/数据库/` 目录下的各集合文件。