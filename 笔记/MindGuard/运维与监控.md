# 运维与监控

本方案旨在保障 MindGuard 微信小程序的稳定运行，从前端体验、后端服务、数据与安全三层搭建监控体系，覆盖日常巡检、告警响应与复盘机制。

## 1. 监控目标

- **可用性**：页面加载耗时 < 2s，关键流程成功率 > 98%。
- **稳定性**：小程序崩溃率 < 0.5%，接口错误率 < 1%。
- **安全性**：风险事件及时发现并有处置闭环。
- **运营支持**：埋点、任务闭环数据正常入库。

## 2. 监控体系结构

| 层级 | 工具/渠道 | 监控内容 | 说明 |
| --- | --- | --- | --- |
| 客户端（微信小程序） | 微信开发者后台“性能监控”、`wx.onError`/`wx.onUnhandledRejection` | 首次渲染时间、页面卡顿、崩溃堆栈 | 配置自定义上报服务，将异常写入 Sentry/自建网关。 |
| BFF/Serverless | API 网关（如 Tencent Cloud SCF / Node BFF）、APM（SkyWalking/Sentry） | 接口响应时间、错误码、依赖服务可用性 | 重点监控 `behavior_tasks`、`risk_signals`、`user_profile` 等核心接口。 |
| 数据与任务 | ClickHouse/Kafka 消费监控、ETL 任务告警 | 埋点落库、周报生成、风险路由任务 | 设置延迟阈值（>5 分钟延迟触发告警）。 |
| 运维总览 | Grafana + Prometheus、飞书告警机器人 | 聚合指标看板、值班告警 | 集成微信云托管/腾讯云监控，统一告警入口。 |

## 3. 指标与阈值

### 3.1 崩溃率
- **指标定义**：`Crash Sessions / Total Sessions`。
- **阈值**：连续 5 分钟 >0.5% 或单日 >1% 触发告警。
- **定位方式**：Sentry 崩溃堆栈、机型分布、微信基础库版本。
- **处置**：
  1. 评估是否与最新发版相关，如相关，执行回滚策略。
  2. 将崩溃日志同步至研发群，安排热修复或发版修复。

### 3.2 接口错误率
- **指标定义**：`5xx or CustomError Count / Total Requests`。
- **阈值**：单接口 3 分钟均值 >1% 告警；>5% 触发升级（电话）。
- **定位方式**：APM Trace、Request ID，配合日志平台（如 CLS/ELK）。
- **处置**：
  1. 快速区分客户端、服务端或依赖（如数据库、AI 服务）。
  2. 若为下游故障，启动降级策略（缓存上一次建议、隐藏部分入口）。

### 3.3 风险事件 SLA
- **指标定义**：`risk_signal_escalate.response_latency_s` 平均值。
- **阈值**：>300s 告警，>600s 升级至人工热线。
- **处置**：通知值班心理老师 / 运营，跟进转介流程，形成事件复盘。

### 3.4 埋点丢失率
- **指标定义**：`expected_events - actual_events`，按关键漏斗对齐。
- **阈值**：任一关键事件日环比下降 >20% 触发排查。
- **处置**：检查 SDK 配置、网络重试策略、数据管道。

## 4. 告警机制

1. **告警分级**：
   - P0：全量用户不可用、SOS 失败等；立即短信/电话 + 飞书红色告警，15 分钟内响应。
  - P1：接口错误率 >5%、风险响应超时；飞书橙色告警，30 分钟响应。
  - P2：指标趋势异常、单模块降级；飞书蓝色告警，4 小时内处理。
2. **告警路由**：Grafana OnCall → 飞书机器人 → 值班群，附带 Trace 链接与最近发布信息。
3. **值班制度**：
   - 工作日 09:00-23:00 产品/研发轮值；23:00-09:00 由夜间“晚安模式”运营值守。
   - 周末安排 On-Call，提供备用电话。

## 5. 日常运维流程

1. **例行巡检（每日 10:00 前）**：检查昨日崩溃率、接口错误率、关键漏斗数据、风险事件响应。
2. **版本跟踪**：记录最近 3 个版本的发版时间、灰度范围、是否存在回滚。
3. **依赖服务健康度**：AI Agent、向量数据库、短信/IM 通道，需提供状态页或心跳接口。
4. **数据备份**：关键表（`checkins`、`behavior_tasks`、`risk_signals`）每日快照，冷备份 30 天。
5. **安全巡检**：
   - 账号权限：每周复盘后台账号与 RBAC 权限。
   - 日志审计：对敏感操作（隐私授权变更、风险处置）开启审计。

## 6. 事故处理与复盘

1. **事件记录**：使用 Incident 模板，包含时间线、影响范围、根因分析、补救措施。
2. **快速回滚**：保留最近两个稳定版本的包体，必要时通过微信小程序管理后台回退。
3. **复盘会议**：P0/P1 事件 48 小时内召开复盘，输出行动项与负责人，纳入迭代计划跟踪。
4. **知识库沉淀**：将复盘、告警处理手册沉淀在 Confluence/飞书文档，供新成员熟悉。

## 7. 后续优化方向

- 引入前端性能体验指标（TTI、CLS）并与真机监控结合。
- 将风险事件的处置流程接入 PagerDuty/飞书服务台，自动派单。
- 通过灰度与蓝绿发布，降低版本切换风险。
- 为 AI Agent 服务设置独立健康检查与熔断机制，避免拖垮主链路。
