> æœ¬æ–‡ç”± [ç®€æ‚¦ SimpRead](http://ksria.com/simpread/) è½¬ç ï¼Œ åŸæ–‡åœ°å€ [blog.csdn.net](https://blog.csdn.net/weixin_55944949/article/details/136048349)

#### ç›®å½•

*   [ä¸€. è®¾ç½®é¥æ§å™¨](#__24)
*   [äºŒ. ä»¿çœŸä»£ç ](#__37)
*   [ä¸‰. ç¼–è¯‘è¿è¡Œ](#__165)
*   [å‚è€ƒ](#_198)

**å‰è¨€ï¼š** æœ¬æ¬¡æ•™ç¨‹æ˜¯å®˜æ–¹æä¾›çš„ [MAVROS](https://so.csdn.net/so/search?q=MAVROS&spm=1001.2101.3001.7020) _Offboard_ (æ¿å¤–) æ§åˆ¶ç¤ºä¾‹ï¼Œä½†åŠ ä¸Šäº†**å¤–éƒ¨é¥æ§å™¨ (RC) æ§åˆ¶**ï¼ˆå¦‚æœæƒ³è¦åœ¨çœŸæœºä¸Šå®ç°ï¼Œè¿˜è¦[ä¿®æ”¹ä»£ç ](https://so.csdn.net/so/search?q=%E4%BF%AE%E6%94%B9%E4%BB%A3%E7%A0%81&spm=1001.2101.3001.7020)ï¼‰

**æ³¨ï¼šæ­å»ºä»¿çœŸç¯å¢ƒå¯ä»¥çœ‹ä¸‹é¢æ•™ç¨‹** ğŸ‘‡

[(æœ€æ–°)ubuntu æ­å»º PX4 æ— äººæœºä»¿çœŸç¯å¢ƒ (1) â€”â€” æ¦‚å¿µä»‹ç»åŠç¯å¢ƒå»ºè®®](https://blog.csdn.net/weixin_55944949/article/details/130848009?spm=1001.2014.3001.5502)

[(æœ€æ–°)ubuntu æ­å»º PX4 æ— äººæœºä»¿çœŸç¯å¢ƒ (2) â€”â€” MAVROS å®‰è£…](https://blog.csdn.net/weixin_55944949/article/details/130877689?spm=1001.2014.3001.5502)

[(æœ€æ–°)ubuntu æ­å»º PX4 æ— äººæœºä»¿çœŸç¯å¢ƒ (3) â€”â€” ubuntu å®‰è£… QGC åœ°é¢ç«™](https://blog.csdn.net/weixin_55944949/article/details/130895363?spm=1001.2014.3001.5502)

[(æœ€æ–°)ubuntu æ­å»º PX4 æ— äººæœºä»¿çœŸç¯å¢ƒ (4) â€”â€” ä»¿çœŸç¯å¢ƒæ­å»º](https://blog.csdn.net/weixin_55944949/article/details/130895608?spm=1001.2014.3001.5501)

[ubuntu å®‰è£… ROS melodic(æœ€æ–°ã€è¶…è¯¦ç»†å›¾æ–‡æ•™ç¨‹)](https://blog.csdn.net/weixin_55944949/article/details/130468032?spm=1001.2014.3001.5502)

**å‰æœŸå›é¡¾**ï¼š

[å¸¦ä½ ç©è½¬ PX4 æ— äººæœºä»¿çœŸ (1) â€”â€” è¿è¡Œå®˜æ–¹æ¡ˆä¾‹ï¼ˆC++ï¼‰](https://blog.csdn.net/weixin_55944949/article/details/132570487?spm=1001.2014.3001.5501)

[å¸¦ä½ ç©è½¬ PX4 æ— äººæœºä»¿çœŸ (2) â€”â€” å®šç‚¹é£è¡Œ](https://blog.csdn.net/weixin_55944949/article/details/135326886?spm=1001.2014.3001.5501)

ä¸€. è®¾ç½®[é¥æ§å™¨](https://so.csdn.net/so/search?q=%E9%81%A5%E6%8E%A7%E5%99%A8&spm=1001.2101.3001.7020)
-----------------------------------------------------------------------------------------------

![](https://i-blog.csdnimg.cn/blog_migrate/3192efc610d136f371af9f60af76168c.png#pic_center)  
**(å¯Œæ–¯ i6s èˆªæ¨¡é¥æ§å™¨)**

ä»¿çœŸç”µè„‘å’Œé¥æ§å™¨é€šè¿‡ Micro USB æ•°æ®çº¿ (ä¹Ÿå°±æ˜¯è€ç‰ˆå®‰å“æ‰‹æœºçš„å……ç”µçº¿) è¿æ¥  
![](https://i-blog.csdnimg.cn/blog_migrate/3ed3d5f4a739df9f8daa41d8ef6f9916.png#pic_center)  
**ï¼ˆä»¿çœŸç”µè„‘ä¸é¥æ§å™¨è¿æ¥å›¾ï¼‰**

å½“åœ¨ä»¿çœŸæ—¶ï¼Œæ‰“å¼€ QGCï¼Œåœ¨è®¾ç½®ä¸­å¯ä»¥çœ‹åˆ°å¤šäº†ä¸€ä¸ª **æ¸¸æˆæ‰‹æŸ„** çš„ç•Œé¢ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º  
![](https://i-blog.csdnimg.cn/blog_migrate/2e0d8a71f041d5d2edc60f25a1cd5fcd.png#pic_center)  
ç‚¹å‡»æŒ‰é’®åˆ†é…å¹¶æ‹¨åŠ¨é¥æ§å™¨ä¸Šçš„æ‹¨æ†ï¼Œå°±å¯ä»¥çœ‹åˆ°æ‰€å¯¹åº”çš„é€šé“ï¼Œç„¶åä¸ºæ‹¨æ†é…ç½®åŠŸèƒ½ã€‚(æˆ‘çš„é…ç½®å¦‚ä¸‹ï¼Œä»…ä¾›å‚è€ƒ)  
![](https://i-blog.csdnimg.cn/blog_migrate/632d24fe4a5ca954c41b91fbaa163968.png#pic_center)

äºŒ. ä»¿çœŸä»£ç 
-------

æˆ‘ä»¬ç»§ç»­ä½¿ç”¨ `å¸¦ä½ ç©è½¬PX4æ— äººæœºä»¿çœŸ(1)` ä¸­çš„åŠŸèƒ½åŒ…ï¼Œåœ¨ off_node åŠŸèƒ½åŒ…ä¸‹çš„ src ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ª **offb_node_rc.cpp** æ–‡ä»¶

```
cd ~/catkin_ws/src/off_node/src/
touch offb_node_rc.cpp   // åˆ›å»ºæ–‡ä»¶
gedit offb_node_rc.cpp   // æ‰“å¼€æ–‡ä»¶

```

æ‰“å¼€æ–‡ä»¶ï¼Œå°†ä»£ç ç²˜è´´ä¸Šå»

```
#include <ros/ros.h>
#include <geometry_msgs/PoseStamped.h>
#include <mavros_msgs/CommandBool.h>
#include <mavros_msgs/SetMode.h>
#include <mavros_msgs/State.h>
#define GREEN "\033[0;1;32m"

using namespace std;

mavros_msgs::State current_state;
void state_cb(const mavros_msgs::State::ConstPtr& msg){
    current_state = *msg;
    ROS_INFO("current mode: %s",current_state.mode.c_str());
    ROS_INFO("system_status: %d",current_state.system_status);
}

geometry_msgs::PoseStamped aim_pos;
geometry_msgs::PoseStamped curr_pos;
void arrive_pos(const geometry_msgs::PoseStamped::ConstPtr& msg){
    curr_pos = *msg;
    cout <<GREEN <<"distance: "<<fabs((*msg).pose.position.z - aim_pos.pose.position.z) <<endl;  // æ‰“å°ä¸ç›®æ ‡ç‚¹çš„å·®è·
}

int main(int argc, char **argv)
{
    ros::init(argc, argv, "off_node");
    ros::NodeHandle nh;

    ros::Subscriber state_sub = nh.subscribe<mavros_msgs::State>
            ("mavros/state", 10, state_cb);
    ros::Publisher local_pos_pub = nh.advertise<geometry_msgs::PoseStamped>
            ("mavros/setpoint_position/local", 10);
    ros::ServiceClient arming_client = nh.serviceClient<mavros_msgs::CommandBool>
            ("mavros/cmd/arming");
    ros::ServiceClient set_mode_client = nh.serviceClient<mavros_msgs::SetMode>
            ("mavros/set_mode");

    ros::Subscriber local_pos_sub = nh.subscribe<geometry_msgs::PoseStamped>
            ("mavros/local_position/pose",10,arrive_pos);

    //the setpoint publishing rate MUST be faster than 2Hz
    ros::Rate rate(10.0);  // 10Hz 100ms

    // wait for FCU connection
    while(ros::ok() && !current_state.connected){
        ros::spinOnce();
        rate.sleep();
    }

    ROS_INFO("vehicle connected!");

    //geometry_msgs::PoseStamped pose;
    aim_pos.pose.position.x = 0;
    aim_pos.pose.position.y = 0;
    aim_pos.pose.position.z = 2;

    //send a few setpoints before starting
    for(int i = 100; ros::ok() && i > 0; --i){
        local_pos_pub.publish(aim_pos);
        ros::spinOnce();
        rate.sleep();
    }

    mavros_msgs::CommandBool arm_cmd;
    arm_cmd.request.value = true;

    ros::Time last_request = ros::Time::now();

    int count = 0;  // è®¡æ—¶

    while(ros::ok()){
        if( current_state.mode == "OFFBOARD"){
            if( !current_state.armed){
                if( arming_client.call(arm_cmd) &&arm_cmd.response.success){
                    ROS_INFO("Vehicle armed");
                }
            }
        }
        if(current_state.mode == "OFFBOARD" && fabs(curr_pos.pose.position.z - aim_pos.pose.position.z) <= 0.3){
            count++;
            cout <<GREEN << "count: "<< count<< endl;
            if(count > 150) // 15s
            {
                mavros_msgs::SetMode land_set_mode;
                land_set_mode.request.custom_mode = "AUTO.LAND";  // å‘é€é™è½å‘½ä»¤
                if(set_mode_client.call(land_set_mode) && land_set_mode.response.mode_sent){
                    ROS_INFO("land enabled");
                }
                //ä»»åŠ¡ç»“æŸ,å…³é—­è¯¥èŠ‚ç‚¹
                ros::shutdown();
            }  
        }
        if(current_state.mode != "OFFBOARD"){
            ROS_INFO("switch to Offboard");
        }

        local_pos_pub.publish(aim_pos);

        ros::spinOnce();
        rate.sleep();
    }

    return 0;
}

```

å°†ä¸‹é¢å†…å®¹æ·»åŠ åˆ° off_node åŠŸèƒ½åŒ…ä¸‹çš„ CMakeLists.txt æ–‡ä»¶é‡Œ

```
add_executable(offb_node src/offb_node_rc.cpp)
target_link_libraries(offb_node_rc ${catkin_LIBRARIES})

```

ä¸‰. ç¼–è¯‘è¿è¡Œ
-------

è¿è¡Œä¸‹é¢å‘½ä»¤ï¼Œç¼–è¯‘ä»£ç 

```
cd ~/catkin_ws
catkin_make # ä½¿ç”¨catkin buildè¯ï¼Œåˆ™ä¸º catkin build

```

åˆ›å»ºä¸€ä¸ªå¯åŠ¨è„šæœ¬ **offb_rc.sh**

```
#!/bin/bash
source ~/.bashrc
gnome-terminal --window -e 'bash -c "roscore; exec bash"' \
--tab -e 'bash -c "sleep 5; roslaunch px4 mavros_posix_sitl.launch; exec bash"' \
--tab -e 'bash -c "sleep 10; rosrun off_node offb_node_rc; exec bash"' \

```

è¿è¡Œ

```
chmod +x offb_rc.sh   
./offb_rc.sh

```

è¿è¡Œæ•ˆæœå¦‚ä¸‹ï¼šğŸ‘‡

PX4 æ— äººæœºä»¿çœŸâ€”â€”å®˜æ–¹æ¡ˆä¾‹ (RC ç‰ˆ)

å‚è€ƒ
--

[MAVROS Offboard æ§åˆ¶ç¤ºä¾‹ (C++) | PX4 è‡ªåŠ¨é©¾é©¶ç”¨æˆ·æŒ‡å—](https://docs.px4.io/main/zh/ros/mavros_offboard_cpp.html)

[Prometheus ä»¿çœŸå…¥é—¨ â€” ä»¿çœŸä¸­çš„é¥æ§å™¨ä½¿ç”¨è¯´æ˜](https://wiki.amovlab.com/public/prometheus-wiki/Prometheus%E4%BB%BF%E7%9C%9F%E5%85%A5%E9%97%A8/%E4%BB%BF%E7%9C%9F%E4%B8%AD%E7%9A%84%E9%81%A5%E6%8E%A7%E5%99%A8%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E.html)

> å¦‚æœ‰å…¶ä»–é—®é¢˜ï¼Œæˆ–è€…å‘ç°æ–‡ç« æœ‰é”™è¯¯ï¼Œè¯·åœ¨è¯„è®ºåŒºç•™è¨€  
> Keep learningï¼